--USE [UNITRAC];

SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;

DECLARE @Ticket nvarchar(15) = 'UTPRDT103_CSH32796'
DECLARE @RowsToChange INT = 0

BEGIN TRAN
/****** CREATE SOURCE TEMP TABLE  ******/
IF OBJECT_ID('tempdb..#Certificate_Detail_update', 'U') IS NOT NULL
	DROP TABLE #Certificate_Detail_update
CREATE TABLE #Certificate_Detail_update
(
    [Amount_NO] [DECIMAL](18,2) NOT NULL, 
	[CPI_ACtivity_ID] [bigINT] NOT NULL,
	[Type] [nvarchar](max) NOT NULL
)WITH (DATA_COMPRESSION = PAGE);

/****** INSERT RECORDS SOURCE TEMP TABLE  ******/
INSERT INTO #Certificate_Detail_update ([Amount_NO],[CPI_ACtivity_ID],[Type]) 
VALUES 
(304, 32448535, 'PRM'),
(940, 32652773, 'PRM'),
(-579, 34685050, 'PRM'),
(445, 32884582, 'PRM'),
(-269, 34973769, 'PRM'),
(2490, 33097729, 'PRM'),
(-2026, 33273684, 'PRM'),
(1080, 33097896, 'PRM'),
(-891, 33661380, 'PRM'),
(1928, 33098087, 'PRM'),
(-1062, 35475718, 'PRM'),
(752, 33517844, 'PRM'),
(-579, 33648033, 'PRM'),
(461, 33518103, 'PRM'),
(-226, 35442363, 'PRM'),
(1932, 33722567, 'PRM'),
(-969, 36967410, 'PRM'),
(1904, 33722600, 'PRM'),
(-1341, 34913545, 'PRM'),
(868, 33722651, 'PRM'),
(-695, 34048078, 'PRM'),
(959, 33722904, 'PRM'),
(1618, 33929860, 'PRM'),
(-1339, 35134113, 'PRM'),
(2163, 33930297, 'PRM'),
(-1215, 35994508, 'PRM'),
(1509, 34141276, 'PRM'),
(-1199, 34504252, 'PRM'),
(564, 34142384, 'PRM'),
(-332, 35582860, 'PRM'),
(408, 34142819, 'PRM'),
(-182, 35852264, 'PRM'),
(743, 34351306, 'PRM'),
(-501, 34973063, 'PRM'),
(508, 34352180, 'PRM'),
(1226, 34566997, 'PRM'),
(-940, 34778397, 'PRM'),
(4640, 34763950, 'PRM'),
(-3954, 35745527, 'PRM'),
(1487, 34982909, 'PRM'),
(-469, 38341086, 'PRM'),
(591, 34983206, 'PRM'),
(-397, 35851163, 'PRM'),
(291, 34983734, 'PRM'),
(264, 34983759, 'PRM'),
(977, 35206587, 'PRM'),
(-645, 36424352, 'PRM'),
(652, 35206830, 'PRM'),
(-325, 37155599, 'PRM'),
(411, 35207061, 'PRM'),
(-247, 36329474, 'PRM'),
(388, 35406471, 'PRM'),
(-21, 40910868, 'PRM'),
(578, 35406537, 'PRM'),
(621, 35406539, 'PRM'),
(-34, 40198293, 'PRM'),
(272, 35406558, 'PRM'),
(-87, 39241926, 'PRM'),
(227, 35406585, 'PRM'),
(-68, 38537452, 'PRM'),
(205, 35406606, 'PRM'),
(-19, 39360829, 'PRM'),
(2120, 35615654, 'PRM'),
(-1795, 36227317, 'PRM'),
(241, 35616861, 'PRM'),
(239, 35616877, 'PRM'),
(158, 35616938, 'PRM'),
(1406, 35838353, 'PRM'),
(-848, 36413534, 'PRM'),
(-254, 38940127, 'PRM'),
(671, 35838657, 'PRM'),
(-438, 36854275, 'PRM'),
(310, 35838896, 'PRM'),
(-9, 39833301, 'PRM'),
(689, 36056501, 'PRM'),
(-529, 36473635, 'PRM'),
(238, 36057018, 'PRM'),
(2104, 36269991, 'PRM'),
(-1643, 36426846, 'PRM'),
(1009, 36270191, 'PRM'),
(-705, 36859885, 'PRM'),
(650, 36271280, 'PRM'),
(-379, 37361167, 'PRM'),
(588, 36271394, 'PRM'),
(-284, 38428428, 'PRM'),
(473, 36271516, 'PRM'),
(-297, 37475226, 'PRM'),
(463, 36271523, 'PRM'),
(-127, 38645356, 'PRM'),
(295, 36271635, 'PRM'),
(-54, 40060069, 'PRM'),
(316, 36271641, 'PRM'),
(648, 36494595, 'PRM'),
(-478, 36985600, 'PRM'),
(1206, 36710368, 'PRM'),
(-922, 37275433, 'PRM'),
(357, 36710842, 'PRM'),
(315, 36710907, 'PRM'),
(262, 36710931, 'PRM'),
(332, 36930666, 'PRM'),
(-13, 41181110, 'PRM'),
(476, 36930861, 'PRM'),
(158, 36930946, 'PRM'),
(527, 37146571, 'PRM'),
(-258, 39293477, 'PRM'),
(2485, 37370125, 'PRM'),
(-2001, 37601433, 'PRM'),
(2359, 37370158, 'PRM'),
(-1655, 37557351, 'PRM'),
(1492, 37370426, 'PRM'),
(-634, 39962404, 'PRM'),
(257, 37370716, 'PRM'),
(745, 37566016, 'PRM'),
(-484, 38734445, 'PRM'),
(790, 37783471, 'PRM'),
(-558, 38446291, 'PRM'),
(719, 37783572, 'PRM'),
(-459, 39003107, 'PRM'),
(305, 37784036, 'PRM'),
(248, 37784101, 'PRM'),
(-9, 44019918, 'PRM'),
(244, 37784109, 'PRM'),
(-4, 44316028, 'PRM'),
(1451, 37977740, 'PRM'),
(-1208, 38305101, 'PRM'),
(834, 37978367, 'PRM'),
(-548, 39300275, 'PRM'),
(582, 37978611, 'PRM'),
(-228, 40613125, 'PRM'),
(419, 37978746, 'PRM'),
(-183, 39833348, 'PRM'),
(843, 37978748, 'PRM'),
(925, 38184860, 'PRM'),
(-725, 39494769, 'PRM'),
(-10, 39552708, 'PRM'),
(445, 38185167, 'PRM'),
(-272, 42155113, 'PRM'),
(437, 38185184, 'PRM'),
(-260, 40033668, 'PRM'),
(414, 38185200, 'PRM'),
(-187, 40488598, 'PRM'),
(3475, 38395027, 'PRM'),
(-2647, 38537101, 'PRM'),
(2465, 38395338, 'PRM'),
(-1594, 39538671, 'PRM'),
(1219, 38395343, 'PRM'),
(-852, 38713458, 'PRM'),
(842, 38395539, 'PRM'),
(-662, 38624456, 'PRM'),
(635, 38395642, 'PRM'),
(-303, 40525554, 'PRM'),
(599, 38395681, 'PRM'),
(-437, 38713259, 'PRM'),
(420, 38395795, 'PRM'),
(-234, 40021061, 'PRM'),
(905, 38612576, 'PRM'),
(-555, 40020917, 'PRM'),
(743, 38612853, 'PRM'),
(-584, 38962792, 'PRM'),
(578, 38613088, 'PRM'),
(-423, 38894649, 'PRM'),
(541, 38613117, 'PRM'),
(-379, 39149391, 'PRM'),
(360, 38613298, 'PRM'),
(423, 38810507, 'PRM'),
(-262, 40147216, 'PRM'),
(338, 38810577, 'PRM'),
(312, 38810597, 'PRM'),
(1050, 38856451, 'PRM'),
(-803, 38867974, 'PRM'),
(3872, 39052668, 'PRM'),
(-2981, 39418423, 'PRM'),
(297, 39053762, 'PRM'),
(1071, 39255751, 'PRM'),
(-795, 39537406, 'PRM'),
(255, 39256286, 'PRM'),
(1942, 39463085, 'PRM'),
(-1479, 40273899, 'PRM'),
(768, 39463178, 'PRM'),
(-452, 40455852, 'PRM'),
(1075, 39463325, 'PRM'),
(308, 39463527, 'PRM'),
(335, 39463529, 'PRM'),
(3394, 39669239, 'PRM'),
(-2445, 40274911, 'PRM'),
(3605, 39866684, 'PRM'),
(-2647, 40722391, 'PRM'),
(-464, 40722397, 'PRM'),
(832, 39867308, 'PRM'),
(-666, 40063677, 'PRM'),
(432, 39867619, 'PRM'),
(-258, 41546232, 'PRM'),
(330, 39867705, 'PRM'),
(296, 39867737, 'PRM'),
(-1, 44685545, 'PRM'),
(980, 40071344, 'PRM'),
(-725, 41574591, 'PRM'),
(632, 40071618, 'PRM'),
(-287, 42562709, 'PRM'),
(509, 40071720, 'PRM'),
(-236, 42352382, 'PRM'),
(472, 40071749, 'PRM'),
(-292, 41791969, 'PRM'),
(290, 40071912, 'PRM'),
(505, 40071939, 'PRM'),
(188, 40071972, 'PRM'),
(-21, 44392269, 'PRM'),
(1238, 40315569, 'PRM'),
(-1078, 41468350, 'PRM'),
(977, 40315724, 'PRM'),
(-800, 40441869, 'PRM'),
(267, 40316212, 'PRM'),
(509, 40537956, 'PRM'),
(-314, 42012325, 'PRM'),
(399, 40538034, 'PRM'),
(-43, 45691631, 'PRM'),
(256, 40538140, 'PRM'),
(489, 40538146, 'PRM'),
(1084, 40762017, 'PRM'),
(-369, 45691432, 'PRM'),
(359, 40762129, 'PRM'),
(336, 40762143, 'PRM'),
(169, 40762247, 'PRM'),
(1079, 41008333, 'PRM'),
(-754, 42013069, 'PRM'),
(2515, 41239036, 'PRM'),
(-1785, 42224439, 'PRM'),
(861, 41239269, 'PRM'),
(-554, 42524625, 'PRM'),
(324, 41239650, 'PRM'),
(169, 41239744, 'PRM'),
(785, 41474100, 'PRM'),
(323, 41474155, 'PRM'),
(1283, 41750939, 'PRM'),
(-1048, 42544809, 'PRM'),
(780, 41751376, 'PRM'),
(-496, 42566838, 'PRM'),
(344, 41751728, 'PRM'),
(2167, 41982335, 'PRM'),
(-1609, 43575038, 'PRM'),
(667, 41982629, 'PRM'),
(-307, 43290173, 'PRM'),
(598, 41982679, 'PRM'),
(-256, 45691418, 'PRM'),
(1148, 41982716, 'PRM'),
(-391, 43926334, 'PRM'),
(503, 41982765, 'PRM'),
(-181, 43818113, 'PRM'),
(2658, 42207365, 'PRM'),
(-1701, 42528732, 'PRM'),
(561, 42208105, 'PRM'),
(-393, 42694776, 'PRM'),
(344, 42208303, 'PRM'),
(335, 42208331, 'PRM'),
(191, 42208482, 'PRM'),
(602, 42428071, 'PRM'),
(-421, 42862999, 'PRM'),
(395, 42428215, 'PRM'),
(-229, 43251173, 'PRM'),
(173, 42428332, 'PRM'),
(774, 42637023, 'PRM'),
(-588, 42903714, 'PRM'),
(397, 42637406, 'PRM'),
(-72, 45691490, 'PRM'),
(343, 42637457, 'PRM'),
(-158, 43946119, 'PRM'),
(250, 42637535, 'PRM'),
(2077, 42849947, 'PRM'),
(-1205, 43744081, 'PRM'),
(1819, 42850031, 'PRM'),
(-1055, 43529332, 'PRM'),
(546, 42850326, 'PRM'),
(-317, 44137609, 'PRM'),
(416, 42850412, 'PRM'),
(-150, 45485211, 'PRM'),
(276, 42850497, 'PRM'),
(162, 42850559, 'PRM'),
(-5, 46844781, 'PRM'),
(2120, 43034026, 'PRM'),
(-1940, 43053516, 'PRM'),
(1664, 43054581, 'PRM'),
(-1313, 43511156, 'PRM'),
(713, 43064642, 'PRM'),
(-371, 44060202, 'PRM'),
(638, 43064707, 'PRM'),
(-447, 43408353, 'PRM'),
(511, 43064813, 'PRM'),
(-235, 44396606, 'PRM'),
(3853, 43260117, 'PRM'),
(-2928, 43721757, 'PRM'),
(1043, 43261125, 'PRM'),
(-543, 44395946, 'PRM'),
(1006, 43261137, 'PRM'),
(314, 43261289, 'PRM'),
(-75, 45451477, 'PRM'),
(176, 43261377, 'PRM'),
(2152, 43478361, 'PRM'),
(-1377, 43883150, 'PRM'),
(601, 43478758, 'PRM'),
(-421, 43633391, 'PRM'),
(560, 43478796, 'PRM'),
(-258, 45003216, 'PRM'),
(451, 43478915, 'PRM'),
(-208, 44265554, 'PRM'),
(372, 43478928, 'PRM'),
(-54, 47288492, 'PRM'),
(270, 43479026, 'PRM'),
(-24, 47405654, 'PRM'),
(267, 43479031, 'PRM'),
(176, 43479089, 'PRM'),
(154, 43479100, 'PRM'),
(360, 43681478, 'PRM'),
(968, 43871343, 'PRM'),
(-620, 44076561, 'PRM'),
(820, 43871467, 'PRM'),
(-525, 44375385, 'PRM'),
(670, 43871652, 'PRM'),
(-348, 45545019, 'PRM'),
(394, 44103228, 'PRM'),
(-205, 45691743, 'PRM'),
(165, 44103371, 'PRM'),
(-12, 48543549, 'PRM'),
(158, 44103375, 'PRM'),
(356, 44325822, 'PRM'),
(-86, 47836272, 'PRM'),
(330, 44325842, 'PRM'),
(3442, 44514483, 'PRM'),
(-2410, 45057643, 'PRM'),
(526, 44515266, 'PRM'),
(-189, 46159116, 'PRM'),
(310, 44515431, 'PRM'),
(-65, 47597155, 'PRM'),
(559, 44735683, 'PRM'),
(-391, 44789337, 'PRM'),
(545, 44735699, 'PRM'),
(-316, 44804458, 'PRM'),
(1361, 44931603, 'PRM'),
(-626, 47567029, 'PRM'),
(340, 44931856, 'PRM'),
(-177, 45840209, 'PRM'),
(293, 44931896, 'PRM'),
(1611, 45139508, 'PRM'),
(-1031, 45874448, 'PRM'),
(350, 45139844, 'PRM'),
(-161, 46159246, 'PRM'),
(290, 45139889, 'PRM'),
(-125, 46402053, 'PRM'),
(165, 45139953, 'PRM'),
(995, 45335121, 'PRM'),
(-763, 46277191, 'PRM'),
(1664, 45335289, 'PRM'),
(-765, 46160585, 'PRM'),
(2865, 45530919, 'PRM'),
(-1834, 46549827, 'PRM'),
(609, 45531415, 'PRM'),
(-280, 46802382, 'PRM'),
(425, 45531604, 'PRM'),
(-183, 46775863, 'PRM'),
(627, 45726690, 'PRM'),
(-326, 46894322, 'PRM'),
(592, 45726715, 'PRM'),
(-343, 46496356, 'PRM'),
(243, 45727179, 'PRM'),
(-68, 47722445, 'PRM'),
(566, 45915278, 'PRM'),
(-328, 46724522, 'PRM'),
(388, 45915499, 'PRM'),
(-202, 46862468, 'PRM'),
(1982, 46126081, 'PRM'),
(-912, 47216456, 'PRM'),
(522, 46126486, 'PRM'),
(-365, 46223350, 'PRM'),
(455, 46126556, 'PRM'),
(-196, 47836359, 'PRM'),
(420, 46126588, 'PRM'),
(-244, 46948135, 'PRM'),
(386, 46126614, 'PRM'),
(-35, 49730900, 'PRM'),
(275, 46126707, 'PRM'),
(-118, 47699646, 'PRM'),
(644, 46333712, 'PRM'),
(-489, 46435066, 'PRM'),
(0, 47448369, 'PRM'),
(314, 46333997, 'PRM'),
(2425, 46532507, 'PRM'),
(-1406, 47232474, 'PRM'),
(649, 46532869, 'PRM'),
(-338, 47489056, 'PRM'),
(589, 46532923, 'PRM'),
(-253, 49514082, 'PRM'),
(539, 46746915, 'PRM'),
(-377, 47006751, 'PRM'),
(334, 46747083, 'PRM'),
(226, 46747154, 'PRM'),
(1898, 46953461, 'PRM'),
(-1215, 47217950, 'PRM'),
(564, 46953765, 'PRM'),
(-327, 47836338, 'PRM'),
(324, 46954113, 'PRM'),
(-58, 49910448, 'PRM'),
(240, 46954208, 'PRM'),
(1180, 47391620, 'PRM'),
(-142, 50441359, 'PRM'),
(1276, 47604283, 'PRM'),
(-740, 48546466, 'PRM'),
(447, 47604457, 'PRM'),
(-125, 48887076, 'PRM'),
(-67, 48887234, 'PRM'),
(363, 47604569, 'PRM'),
(-189, 48498148, 'PRM'),
(307, 47604619, 'PRM'),
(251, 47604668, 'PRM'),
(176, 47807796, 'PRM'),
(598, 48227722, 'PRM'),
(-347, 48480113, 'PRM'),
(686, 48228000, 'PRM'),
(-192, 50670947, 'PRM'),
(270, 48228084, 'PRM'),
(678, 48654102, 'PRM'),
(-447, 50297225, 'PRM'),
(367, 48665194, 'PRM'),
(333, 48665209, 'PRM'),
(1358, 48869419, 'PRM'),
(-584, 49933921, 'PRM'),
(619, 48869470, 'PRM'),
(-322, 51869192, 'PRM'),
(468, 48869643, 'PRM'),
(-300, 49679737, 'PRM'),
(294, 48869847, 'PRM'),
(243, 49094367, 'PRM'),
(746, 49289094, 'PRM'),
(-567, 49675580, 'PRM'),
(580, 49289243, 'PRM'),
(-406, 49679594, 'PRM'),
(437, 49289377, 'PRM'),
(-280, 49780553, 'PRM'),
(405, 49289395, 'PRM'),
(-97, 52260886, 'PRM'),
(1052, 49324988, 'PRM'),
(-822, 50079696, 'PRM'),
(1702, 49522056, 'PRM'),
(-1192, 50300994, 'PRM'),
(1285, 49522221, 'PRM'),
(-193, 53622817, 'PRM'),
(191, 49522616, 'PRM'),
(2596, 49765355, 'PRM'),
(-1661, 50397914, 'PRM'),
(507, 49765852, 'PRM'),
(-345, 51533280, 'PRM'),
(492, 49765881, 'PRM'),
(-315, 50538138, 'PRM'),
(978, 49991455, 'PRM'),
(238, 49991700, 'PRM'),
(-57, 52531817, 'PRM'),
(863, 50260762, 'PRM'),
(-501, 51424627, 'PRM'),
(572, 50261261, 'PRM'),
(-103, 53617775, 'PRM'),
(652, 50500818, 'PRM'),
(-300, 51898146, 'PRM'),
(581, 50500883, 'PRM'),
(-407, 50771245, 'PRM'),
(670, 50736927, 'PRM'),
(-389, 51872205, 'PRM'),
(614, 50736955, 'PRM'),
(-356, 51504066, 'PRM'),
(285, 50737205, 'PRM'),
(343, 50964322, 'PRM'),
(-178, 53465003, 'PRM'),
(2426, 51229191, 'PRM'),
(-1407, 52122372, 'PRM'),
(467, 51229731, 'PRM'),
(-201, 52654941, 'PRM'),
(402, 51229809, 'PRM'),
(-113, 53623590, 'PRM'),
(281, 51229933, 'PRM'),
(255, 51229945, 'PRM'),
(-8, 55155373, 'PRM'),
(195, 51230014, 'PRM'),
(357, 51470935, 'PRM'),
(420, 51689213, 'PRM'),
(-151, 52970510, 'PRM'),
(826, 51910103, 'PRM'),
(-529, 51856793, 'PRM'),
(631, 51910251, 'PRM'),
(-366, 52093157, 'PRM'),
(535, 51910318, 'PRM'),
(-375, 51701979, 'PRM'),
(403, 51910448, 'PRM'),
(-48, 56576709, 'PRM'),
(230, 51910640, 'PRM'),
(3072, 52130117, 'PRM'),
(-2519, 53762440, 'PRM'),
(432, 52130871, 'PRM'),
(-251, 52237082, 'PRM'),
(266, 52130990, 'PRM'),
(0, 56620913, 'PRM'),
(4240, 52345302, 'PRM'),
(-3477, 53030806, 'PRM'),
(770, 52346053, 'PRM'),
(-493, 52420258, 'PRM'),
(544, 52346204, 'PRM'),
(-185, 54535213, 'PRM'),
(1320, 52385794, 'PRM'),
(-1053, 53058904, 'PRM'),
(3095, 52819298, 'PRM'),
(-2352, 52366094, 'PRM'),
(796, 52819807, 'PRM'),
(-557, 52614217, 'PRM'),
(0, 55328570, 'PRM'),
(842, 52820124, 'PRM'),
(-362, 53899084, 'PRM'),
(2415, 53070788, 'PRM'),
(-1546, 53128527, 'PRM'),
(1355, 53071192, 'PRM'),
(-442, 55790178, 'PRM'),
(2299, 53401694, 'PRM'),
(-1335, 54416067, 'PRM'),
(2303, 53401713, 'PRM'),
(-1750, 53687651, 'PRM'),
(841, 53628232, 'PRM'),
(-538, 53567277, 'PRM'),
(753, 53628298, 'PRM'),
(-392, 54463760, 'PRM'),
(289, 53628629, 'PRM'),
(-133, 56269555, 'PRM'),
(256, 53628656, 'PRM'),
(234, 53628664, 'PRM');


select @RowsToChange = count(*) from #Certificate_Detail_update

/* Existence Check for Storage Tables */
IF NOT EXISTS (
		SELECT *
		FROM UNITRACHDSTORAGE.sys.tables
		WHERE SCHEMA_NAME(SCHEMA_ID) = ('UNITRAC')
			AND NAME LIKE @Ticket + '_%'
			AND TYPE IN (N'U')
		)
BEGIN

    /* poulate storage table */
    EXEC('SELECT * into UNITRACHDSTORAGE..'+@Ticket+'_Certificate_Detail
  		FROM [Certificate_Detail]
  		WHERE [CPI_Activity_ID] IN (SELECT CPI_Activity_ID FROM #Certificate_Detail_update)')

    /* Does Storage Table meet expectations */
	IF( @@RowCount <= @RowsToChange )
		BEGIN
            PRINT 'Storage table meets expections - continue'
            
            /****** MERGE RECORDS TARGET TABLE  ******/
            MERGE [dbo].[Certificate_Detail] AS TARGET
            USING #Certificate_Detail_update AS SOURCE
            ON ( TARGET.CPI_ACtivity_ID = SOURCE.CPI_ACtivity_ID )
            /****** UPDATE ALL COLUMNS WHERE   ******/
            WHEN MATCHED AND ( TARGET.[Amount_NO] <> SOURCE.[Amount_NO] OR
                               TARGET.[Type_CD] <> SOURCE.[Type] ) THEN
	            UPDATE SET TARGET.[Amount_NO] = SOURCE.[Amount_NO],
                           TARGET.[Type_CD] = SOURCE.[Type],
						   TARGET.[UPDATE_USER_TX] = @TICKET,
						   TARGET.[UPDATE_DT] = GETDATE()
						  ;

            /* Step 4 - Inspect results - Commit/Rollback */
			IF ( @@RowCount <= @RowsToChange )
		  		BEGIN
		    			PRINT 'SUCCESS - Performing Commit'
		    			COMMIT;
		  		END
			ELSE
		  		BEGIN
		    			PRINT 'FAILED TO UPDATE - Performing Rollback'
		    			ROLLBACK;
		  		END
		END
	ELSE
      		BEGIN
        		PRINT 'Storage does not meet expectations - rollback'
			ROLLBACK;
		END
	END
ELSE
	BEGIN
		PRINT 'HD TABLE EXISTS - Stop work'
		COMMIT;
	END