--USE [UNITRAC];

SET ANSI_NULLS ON;
SET QUOTED_IDENTIFIER ON;

DECLARE @Ticket nvarchar(15) = 'UTPRDT103_CSH32796'
DECLARE @RowsToChange INT = 0

BEGIN TRAN
/****** CREATE SOURCE TEMP TABLE  ******/
IF OBJECT_ID('tempdb..#CPI_Activity_Update', 'U') IS NOT NULL
	DROP TABLE #CPI_Activity_Update
CREATE TABLE #CPI_Activity_Update
(
    [ID] [nvarchar](128) NOT NULL,
	[TOTAL_PREMIUM_NO] [DECIMAL](18,2) NOT NULL
)WITH (DATA_COMPRESSION = PAGE);

/****** INSERT RECORDS SOURCE TEMP TABLE  ******/
INSERT INTO #CPI_Activity_Update ([ID], [TOTAL_PREMIUM_NO]) 
VALUES 
(32448535, 304),
(32652773, 940),
(34685050, -579),
(32884582, 445),
(34973769, -269),
(33097729, 2490),
(33273684, -2026),
(33097896, 1080),
(33661380, -891),
(33098087, 1928),
(35475718, -1062),
(33517844, 752),
(33648033, -579),
(33518103, 461),
(35442363, -226),
(33722567, 1932),
(36967410, -969),
(33722600, 1904),
(34913545, -1341),
(33722651, 868),
(34048078, -695),
(33722904, 959),
(33929860, 1618),
(35134113, -1339),
(33930297, 2163),
(35994508, -1215),
(34141276, 1509),
(34504252, -1199),
(34142384, 564),
(35582860, -332),
(34142819, 408),
(35852264, -182),
(34351306, 743),
(34973063, -501),
(34352180, 508),
(34566997, 1226),
(34778397, -940),
(34763950, 4640),
(35745527, -3954),
(34982909, 1487),
(38341086, -469),
(34983206, 591),
(35851163, -397),
(34983734, 291),
(34983759, 264),
(35206587, 977),
(36424352, -645),
(35206830, 652),
(37155599, -325),
(35207061, 411),
(36329474, -247),
(35406471, 388),
(40910868, -21),
(35406537, 578),
(35406539, 621),
(40198293, -34),
(35406558, 272),
(39241926, -87),
(35406585, 227),
(38537452, -68),
(35406606, 205),
(39360829, -19),
(35615654, 2120),
(36227317, -1795),
(35616861, 241),
(35616877, 239),
(35616938, 158),
(35838353, 1406),
(36413534, -848),
(38940127, -254),
(35838657, 671),
(36854275, -438),
(35838896, 310),
(39833301, -9),
(36056501, 689),
(36473635, -529),
(36057018, 238),
(36269991, 2104),
(36426846, -1643),
(36270191, 1009),
(36859885, -705),
(36271280, 650),
(37361167, -379),
(36271394, 588),
(38428428, -284),
(36271516, 473),
(37475226, -297),
(36271523, 463),
(38645356, -127),
(36271635, 295),
(40060069, -54),
(36271641, 316),
(36494595, 648),
(36985600, -478),
(36710368, 1206),
(37275433, -922),
(36710842, 357),
(36710907, 315),
(36710931, 262),
(36930666, 332),
(41181110, -13),
(36930861, 476),
(36930946, 158),
(37146571, 527),
(39293477, -258),
(37370125, 2485),
(37601433, -2001),
(37370158, 2359),
(37557351, -1655),
(37370426, 1492),
(39962404, -634),
(37370716, 257),
(37566016, 745),
(38734445, -484),
(37783471, 790),
(38446291, -558),
(37783572, 719),
(39003107, -459),
(37784036, 305),
(37784101, 248),
(44019918, -9),
(37784109, 244),
(44316028, -4),
(37977740, 1451),
(38305101, -1208),
(37978367, 834),
(39300275, -548),
(37978611, 582),
(40613125, -228),
(37978746, 419),
(39833348, -183),
(37978748, 843),
(38184860, 925),
(39494769, -725),
(39552708, -10),
(38185167, 445),
(42155113, -272),
(38185184, 437),
(40033668, -260),
(38185200, 414),
(40488598, -187),
(38395027, 3475),
(38537101, -2647),
(38395338, 2465),
(39538671, -1594),
(38395343, 1219),
(38713458, -852),
(38395539, 842),
(38624456, -662),
(38395642, 635),
(40525554, -303),
(38395681, 599),
(38713259, -437),
(38395795, 420),
(40021061, -234),
(38612576, 905),
(40020917, -555),
(38612853, 743),
(38962792, -584),
(38613088, 578),
(38894649, -423),
(38613117, 541),
(39149391, -379),
(38613298, 360),
(38810507, 423),
(40147216, -262),
(38810577, 338),
(38810597, 312),
(38856451, 1050),
(38867974, -803),
(39052668, 3872),
(39418423, -2981),
(39053762, 297),
(39255751, 1071),
(39537406, -795),
(39256286, 255),
(39463085, 1942),
(40273899, -1479),
(39463178, 768),
(40455852, -452),
(39463325, 1075),
(39463527, 308),
(39463529, 335),
(39669239, 3394),
(40274911, -2445),
(39866684, 3605),
(40722391, -2647),
(40722397, -464),
(39867308, 832),
(40063677, -666),
(39867619, 432),
(41546232, -258),
(39867705, 330),
(39867737, 296),
(44685545, -1),
(40071344, 980),
(41574591, -725),
(40071618, 632),
(42562709, -287),
(40071720, 509),
(42352382, -236),
(40071749, 472),
(41791969, -292),
(40071912, 290),
(40071939, 505),
(40071972, 188),
(44392269, -21),
(40315569, 1238),
(41468350, -1078),
(40315724, 977),
(40441869, -800),
(40316212, 267),
(40537956, 509),
(42012325, -314),
(40538034, 399),
(45691631, -43),
(40538140, 256),
(40538146, 489),
(40762017, 1084),
(45691432, -369),
(40762129, 359),
(40762143, 336),
(40762247, 169),
(41008333, 1079),
(42013069, -754),
(41239036, 2515),
(42224439, -1785),
(41239269, 861),
(42524625, -554),
(41239650, 324),
(41239744, 169),
(41474100, 785),
(41474155, 323),
(41750939, 1283),
(42544809, -1048),
(41751376, 780),
(42566838, -496),
(41751728, 344),
(41982335, 2167),
(43575038, -1609),
(41982629, 667),
(43290173, -307),
(41982679, 598),
(45691418, -256),
(41982716, 1148),
(43926334, -391),
(41982765, 503),
(43818113, -181),
(42207365, 2658),
(42528732, -1701),
(42208105, 561),
(42694776, -393),
(42208303, 344),
(42208331, 335),
(42208482, 191),
(42428071, 602),
(42862999, -421),
(42428215, 395),
(43251173, -229),
(42428332, 173),
(42637023, 774),
(42903714, -588),
(42637406, 397),
(45691490, -72),
(42637457, 343),
(43946119, -158),
(42637535, 250),
(42849947, 2077),
(43744081, -1205),
(42850031, 1819),
(43529332, -1055),
(42850326, 546),
(44137609, -317),
(42850412, 416),
(45485211, -150),
(42850497, 276),
(42850559, 162),
(46844781, -5),
(43034026, 2120),
(43053516, -1940),
(43054581, 1664),
(43511156, -1313),
(43064642, 713),
(44060202, -371),
(43064707, 638),
(43408353, -447),
(43064813, 511),
(44396606, -235),
(43260117, 3853),
(43721757, -2928),
(43261125, 1043),
(44395946, -543),
(43261137, 1006),
(43261289, 314),
(45451477, -75),
(43261377, 176),
(43478361, 2152),
(43883150, -1377),
(43478758, 601),
(43633391, -421),
(43478796, 560),
(45003216, -258),
(43478915, 451),
(44265554, -208),
(43478928, 372),
(47288492, -54),
(43479026, 270),
(47405654, -24),
(43479031, 267),
(43479089, 176),
(43479100, 154),
(43681478, 360),
(43871343, 968),
(44076561, -620),
(43871467, 820),
(44375385, -525),
(43871652, 670),
(45545019, -348),
(44103228, 394),
(45691743, -205),
(44103371, 165),
(48543549, -12),
(44103375, 158),
(44325822, 356),
(47836272, -86),
(44325842, 330),
(44514483, 3442),
(45057643, -2410),
(44515266, 526),
(46159116, -189),
(44515431, 310),
(47597155, -65),
(44735683, 559),
(44789337, -391),
(44735699, 545),
(44804458, -316),
(44931603, 1361),
(47567029, -626),
(44931856, 340),
(45840209, -177),
(44931896, 293),
(45139508, 1611),
(45874448, -1031),
(45139844, 350),
(46159246, -161),
(45139889, 290),
(46402053, -125),
(45139953, 165),
(45335121, 995),
(46277191, -763),
(45335289, 1664),
(46160585, -765),
(45530919, 2865),
(46549827, -1834),
(45531415, 609),
(46802382, -280),
(45531604, 425),
(46775863, -183),
(45726690, 627),
(46894322, -326),
(45726715, 592),
(46496356, -343),
(45727179, 243),
(47722445, -68),
(45915278, 566),
(46724522, -328),
(45915499, 388),
(46862468, -202),
(46126081, 1982),
(47216456, -912),
(46126486, 522),
(46223350, -365),
(46126556, 455),
(47836359, -196),
(46126588, 420),
(46948135, -244),
(46126614, 386),
(49730900, -35),
(46126707, 275),
(47699646, -118),
(46333712, 644),
(46435066, -489),
(47448369, 0),
(46333997, 314),
(46532507, 2425),
(47232474, -1406),
(46532869, 649),
(47489056, -338),
(46532923, 589),
(49514082, -253),
(46746915, 539),
(47006751, -377),
(46747083, 334),
(46747154, 226),
(46953461, 1898),
(47217950, -1215),
(46953765, 564),
(47836338, -327),
(46954113, 324),
(49910448, -58),
(46954208, 240),
(47391620, 1180),
(50441359, -142),
(47604283, 1276),
(48546466, -740),
(47604457, 447),
(48887076, -125),
(48887234, -67),
(47604569, 363),
(48498148, -189),
(47604619, 307),
(47604668, 251),
(47807796, 176),
(48227722, 598),
(48480113, -347),
(48228000, 686),
(50670947, -192),
(48228084, 270),
(48654102, 678),
(50297225, -447),
(48665194, 367),
(48665209, 333),
(48869419, 1358),
(49933921, -584),
(48869470, 619),
(51869192, -322),
(48869643, 468),
(49679737, -300),
(48869847, 294),
(49094367, 243),
(49289094, 746),
(49675580, -567),
(49289243, 580),
(49679594, -406),
(49289377, 437),
(49780553, -280),
(49289395, 405),
(52260886, -97),
(49324988, 1052),
(50079696, -822),
(49522056, 1702),
(50300994, -1192),
(49522221, 1285),
(53622817, -193),
(49522616, 191),
(49765355, 2596),
(50397914, -1661),
(49765852, 507),
(51533280, -345),
(49765881, 492),
(50538138, -315),
(49991455, 978),
(49991700, 238),
(52531817, -57),
(50260762, 863),
(51424627, -501),
(50261261, 572),
(53617775, -103),
(50500818, 652),
(51898146, -300),
(50500883, 581),
(50771245, -407),
(50736927, 670),
(51872205, -389),
(50736955, 614),
(51504066, -356),
(50737205, 285),
(50964322, 343),
(53465003, -178),
(51229191, 2426),
(52122372, -1407),
(51229731, 467),
(52654941, -201),
(51229809, 402),
(53623590, -113),
(51229933, 281),
(51229945, 255),
(55155373, -8),
(51230014, 195),
(51470935, 357),
(51689213, 420),
(52970510, -151),
(51910103, 826),
(51856793, -529),
(51910251, 631),
(52093157, -366),
(51910318, 535),
(51701979, -375),
(51910448, 403),
(56576709, -48),
(51910640, 230),
(52130117, 3072),
(53762440, -2519),
(52130871, 432),
(52237082, -251),
(52130990, 266),
(56620913, 0),
(52345302, 4240),
(53030806, -3477),
(52346053, 770),
(52420258, -493),
(52346204, 544),
(54535213, -185),
(52385794, 1320),
(53058904, -1053),
(52819298, 3095),
(52366094, -2352),
(52819807, 796),
(52614217, -557),
(55328570, 0),
(52820124, 842),
(53899084, -362),
(53070788, 2415),
(53128527, -1546),
(53071192, 1355),
(55790178, -442),
(53401694, 2299),
(54416067, -1335),
(53401713, 2303),
(53687651, -1750),
(53628232, 841),
(53567277, -538),
(53628298, 753),
(54463760, -392),
(53628629, 289),
(56269555, -133),
(53628656, 256),
(53628664, 234);


select @RowsToChange = count(*) from #CPI_Activity_Update

/* Existence Check for Storage Tables */
IF NOT EXISTS (
		SELECT *
		FROM UNITRACHDSTORAGE.sys.tables
		WHERE SCHEMA_NAME(SCHEMA_ID) = ('UNITRAC')
			AND NAME LIKE @Ticket + '_%'
			AND TYPE IN (N'U')
		)
BEGIN

    /* poulate storage table */
    EXEC('SELECT * into UNITRACHDSTORAGE..'+@Ticket+'_CPI_ACTIVITY
  		FROM [CPI_ACTIVITY]
  		WHERE [ID] IN (SELECT ID FROM #CPI_Activity_Update)')

    /* Does Storage Table meet expectations */
	IF( @@RowCount <= @RowsToChange )
		BEGIN
            PRINT 'Storage table meets expections - continue'
            
            /****** MERGE RECORDS TARGET TABLE  ******/
            MERGE [dbo].[CPI_ACTIVITY] AS TARGET
            USING #CPI_ACTIVITY_UPDATE AS SOURCE
            ON ( TARGET.ID = SOURCE.ID )
            /****** UPDATE ALL COLUMNS WHERE   ******/
            WHEN MATCHED AND ( TARGET.[TOTAL_PREMIUM_NO] <> SOURCE.[TOTAL_PREMIUM_NO] )
				    THEN
	UPDATE 
	SET 
	           TARGET.[TOTAL_PREMIUM_NO] = SOURCE.[TOTAL_PREMIUM_NO],
               TARGET.[UPDATE_DT] = GETDATE(),
			   TARGET.[UPDATE_USER_TX] = @TICKET;

            /* Step 4 - Inspect results - Commit/Rollback */
			IF ( @@ROWCOUNT <= @RowsToChange )
		  		BEGIN
		    			PRINT 'SUCCESS - Performing Commit'
		    			COMMIT;
		  		END
			ELSE
		  		BEGIN
		    			PRINT 'FAILED TO UPDATE - Performing Rollback'
		    			ROLLBACK;
		  		END
		END
	ELSE
      		BEGIN
        		PRINT 'Storage does not meet expectations - rollback'
			ROLLBACK;
		END
	END
ELSE
	BEGIN
		PRINT 'HD TABLE EXISTS - Stop work'
		COMMIT;
	END