


SELECT 
      Min(id) as Min_ID,
      FPC_ID, 
      REQUIRED_COVERAGE_ID, 
      COUNT(*) as 'record count', 
      MIN(UPDATE_USER_TX) as min_update_user, 
      MAX(UPDATE_USER_TX) as max_update_user, 
      MIN(CREATE_DT) as min_create_dt, 
      MAX(CREATE_DT) as max_create_dt
INTO  #tmpRelate
FROM FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE 
WHERE PURGE_DT IS NULL
GROUP BY FPC_ID, REQUIRED_COVERAGE_ID
HAVING COUNT(*) > 1
ORDER BY 6 asc

BEGIN TRANSACTION 
	UPDATE FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE
	SET PURGE_DT = GETDATE(), 
		UPDATE_DT = GETDATE(), 
		UPDATE_USER_TX = 'EOMCleanUp', 
		LOCK_ID = (LOCK_ID % 255) + 1
	FROM #tmpRelate t
	WHERE FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE.FPC_ID = T.FPC_ID 
	AND FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE.REQUIRED_COVERAGE_ID = T.REQUIRED_COVERAGE_ID
	AND FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE.ID <> T.Min_ID
