---- FOR CANCELLED LENDERS - REPLACE 'mm/dd/yy' 
IF OBJECT_ID(N'tempdb..#TMPVD',N'U') IS NOT NULL
       DROP TABLE #TMPVD 

SELECT LENDER.AGENCY_ID ,  LENDER.CODE_TX , LENDER.NAME_TX , 
LENDER.CANCEL_DT , 
LOAN.LENDER_ID , LOAN.ID AS LOAN_ID , LOAN.NUMBER_TX , 
WI.ID AS WI_ID , WI.CREATE_DT , WI.STATUS_CD ,
WI.CURRENT_QUEUE_ID , WI.CURRENT_OWNER_ID , 
CONVERT(VARCHAR(30), 'CANCEL') AS UPDATE_STATUS 
INTO #TMPVD
--- SELECT COUNT(*)
FROM LOAN JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
JOIN WORK_ITEM WI ON WI.RELATE_ID = LOAN.ID
AND WI.RELATE_TYPE_CD = 'Allied.UniTrac.Loan'
AND WI.STATUS_CD NOT IN ('Complete', 'Withdrawn')
WHERE WI.WORKFLOW_DEFINITION_ID = 8
AND WI.PURGE_DT IS NULL
AND LENDER.PURGE_DT IS NULL
--AND LENDER.TEST_IN = 'N'
AND LENDER.CANCEL_DT IS NOT NULL
AND WI.CREATE_DT < 'mm/dd/yy'
ORDER BY LENDER.CODE_TX , WI.CREATE_DT


---- CANCELLED LENDERS
UPDATE WI SET STATUS_CD = 'Withdrawn' , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'BUGXXXX' , 
LOCK_ID = WI.LOCK_ID % 255 + 1
---- SELECT COUNT(*)
FROM WORK_ITEM WI JOIN #TMPVD TMP ON 
TMP.WI_ID = WI.ID
AND WI.PURGE_DT IS NULL


INSERT INTO WORK_ITEM_ACTION (WORK_ITEM_ID, ACTION_CD, FROM_STATUS_CD, TO_STATUS_CD, CURRENT_QUEUE_ID, 
CURRENT_OWNER_ID, ACTION_NOTE_TX, ACTIVE_IN, CREATE_DT, UPDATE_DT, UPDATE_USER_TX, LOCK_ID, ACTION_USER_ID)
SELECT DISTINCT WI_ID , 'Withdraw' , STATUS_CD , 'Withdrawn' , CURRENT_QUEUE_ID , 
CURRENT_OWNER_ID , 'BUGXXXX' , 'Y' , GETDATE() , GETDATE() , 'BUGXXXX' , 1 , 1
FROM #TMPVD


UPDATE LN SET SPECIAL_HANDLING_XML = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX  = 'BUGXXXX' , 
LOCK_ID = LN.LOCK_ID % 255 + 1
--- SELECT COUNT(*)
FROM LOAN LN JOIN #TMPVD ON #TMPVD.LOAN_ID = LN.ID


