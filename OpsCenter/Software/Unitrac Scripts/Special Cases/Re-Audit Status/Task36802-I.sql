--SELECT * FROM LENDER WHERE CODE_TX = '4750'
---- 2231

--- DROP TABLE #TMPPLCY
SELECT LOAN.NUMBER_TX , LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX , 
COLL.LOAN_ID , COLL.ID AS COLL_ID , 
---COLL.PROPERTY_ID , 
RC.TYPE_CD AS RC_TYPE_CD , RC.ID AS RC_ID , 
RC.SUMMARY_SUB_STATUS_CD , RC.SUMMARY_STATUS_CD , RC.EXPOSURE_DT , 
RC.CPI_QUOTE_ID , RC.NOTICE_DT , RC.NOTICE_SEQ_NO , RC.NOTICE_TYPE_CD , 
RC.LAST_EVENT_DT , RC.LAST_EVENT_SEQ_ID , RC.LAST_SEQ_CONTAINER_ID , 
PLCY.* , 0 AS EXCLUDE
INTO #TMPPLCY
FROM LOAN
JOIN COLLATERAL COLL ON COLL.LOAN_ID = LOAN.ID
AND COLL.PURGE_DT IS NULL AND LOAN.PURGE_DT IS NULL
AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = COLL.PROPERTY_ID
AND RC.PURGE_DT IS NULL
CROSS APPLY
(
SELECT * FROM dbo.GetCurrentCoverage(PR.ID , RC.ID , RC.TYPE_CD)
)  AS PLCY
WHERE LOAN.LENDER_ID = 2231
AND LOAN.NUMBER_TX IN 
(
'75395016','800117466','21554016','140572016','129469016','800604876','126428016','158872016','141282016','9320016'
------,	'68881016',	'157773016',	'147280016',	'117049016',	'252116016',	'180513016',	'51836016',	'800611357',	'32037017',	'44726016',	'153633017',	'201559017',	'2986051917',	'133109016',	'197226017',	'89864017',	'80803017',	'93058016',	'800732337',	'256120017',	'184736017',	'157852015',	'800757918',	'126668016',	'68319017',	'233468188',	'59039016',	'210733016',	'116472017',	'800400505',	'188007018',	'68182018',	'56396015',	'210951018',	'5244913008',	'173115018',	'216060018',	'3287445817',	'42945018',	'233896859',	'52794018',	'3258044078',	'210818019',	'800135609',	'32859018',	'108185016',	'79766016',	'101262018',	'39747018',	'234408119',	'234594957',	'108412019',	'253025019',	'41000019',	'68350019',	'233901179',	'61754018',	'128210019',	'233568779',	'172078015',	'54990019',	'173065010',	'800548269',	'233477339',	'234452369',	'800620749',	'234051929',	'251681019',	'111610016',	'87790019',	'233735639',	'234258239',	'136566016',	'102399019',	'233956829',	'233377229',	'265250019',	'800542039',	'199286016',	'235418579',	'233053018',	'233351489',	'125044019',	'70113019',	'234393089',	'234568134',	'234677459',	'234309479',	'148393017',	'262022019',	'123911019',	'46120019',	'800487176',	'125756019',	'234705119',	'234652494',	'233919359',	'234920638',	'234556014',	'234802464',	'234413900',	'234936359',	'278229019',	'234906599',	'234598464',	'234913405',	'234762504',	'233894039',	'234723324',	'235067994',	'180401019',	'233333309',	'234692964',	'233377949',	'234792359',	'234452039',	'235119569',	'79763019',	'234712409',	'235146504',	'120568019',	'182076019',	'234701664',	'235171079',	'234624805',	'235141499',	'234748494',	'240812004',	'3217277140',	'128289019',	'234789354',	'800614479',	'234804324',	'234981089',	'800763569',	'201857019',	'234773634',	'234839154',	'235373904',	'234823495',	'235329509',	'235063674',	'3505877279',	'234878994',	'234959244',	'800769059',	'259904019',	'104638013',	'82148010',	'207440019',	'93558019',	'205083019',	'105764019',	'800007909',	'71998019',	'234714864',	'234961584',	'800767479',	'131433018',	'3338210029',	'121780019',	'234518219',	'235331904',	'235327794',	'3679639614',	'235235724',	'236131404',	'800481309',	'233475119',	'159034019',	'235117289',	'11339010',	'236120184',	'800358669',	'81984019',	'235986084',	'235384884',	'261674019',	'800765067',	'278852019',	'235211099',	'800036269',	'234796284',	'800443529',	'3187486249',	'128916019',	'142692019',	'70555019',	'234800729',	'236078514',	'779828039',	'800317209',	'234084170',	'800357288',	'104870019',	'256136017',	'185976016',	'5246132789',	'233012330',	'236220864',	'159860019',	'234926129',	'3814220679',	'238133219',	'235978559',	'137982019',	'2586019',	'10736016',	'800739879',	'12003019',	'236111994',	'800798849',	'800646848',	'234655139',	'236473049',	'35467019',	'233460389',	'233166236',	'87498019',	'233276609',	'117375019',	'236278554',	'234623184',	'235048859',	'3534483140',	'233870930',	'800612859',	'236515769',	'234960479',	'236565084',	'118924019',	'110669019',	'93561019',	'17533010',	'236684459',	'234599961',	'85070019',	'800601861',	'81355016',	'233186219',	'234982014',	'800219146',	'166421010',	'236958504',	'236671554',	'43308016',	'236626829',	'236751089',	'71470019',	'48049019',	'208184010',	'263765019',	'155073019',	'122782019',	'237092454',	'236854554',	'236934834',	'180066018',	'588377443',	'588367343',	'235213859',	'150477019',	'271585019',	'233495690',	'236828094',	'237003414',	'235233145',	'236395169',	'236732634',	'233854019',	'234827849',	'800384809',	'236846694',	'236816334',	'135141019',	'237301469',	'237113694',	'236930484',	'3267019',	'588583583',	'800602759',	'154299019',	'236959165',	'55236019',	'166507019',	'235211034',	'001577240102',	'236331954',	'234667349',	'588610323',	'278823017',	'98123019',	'241083389',	'104839019',	'199773019',	'236166655',	'236345219',	'237218094',	'236214569',	'235098474',	'236647404',	'233836109',	'236333039',	'237662064',	'236801099',	'237066209',	'235975670',	'237799434',	'236723249',	'237721164',	'235981044',	'237377964',	'237742524',	'236496389',	'234869540',	'234996419',	'237780569',	'163247016',	'235022819',	'234256349',	'237735389',	'1103933',	'237077039',	'236686135',	'237537294',	'234435770',	'181143019',	'33277219',	'12084019',	'1184393',	'234879350',	'236781145',	'96898019',	'18060019',	'208231019',	'263923019',	'279678018',	'233788859',	'237952764',	'234750774',	'800194609',	'234308189',	'237816804',	'234654899',	'237737274',	'800663727',	'237689969',	'236529744',	'236545400',	'234703884',	'800707029',	'234910824',	'237159085',	'203066019',	'234938489',	'234045740',	'234045749',	'50104019',	'123002016',	'234748614',	'107268019',	'237946824',	'236334809',	'5935010',	'235246764',	'237066295',	'237388559',	'238202394',	'237878244',	'52927019',	'83979019',	'237356005',	'146954017',	'237956994',	'237988914',	'237840239',	'237780119',	'3366295260',	'238133004',	'58860019',	'237783864',	'234863360',	'237015594',	'234726320',	'236633994',	'238536924',	'233940209',	'234734634',	'237776964',	'234638091',	'233739419',	'237780864',	'3537440110',	'800717779',	'168905019',	'239268774',	'205136010',	'237856734',	'92842019',	'236193804',	'236343089',	'78991010',	'237910824',	'236518820',	'236183576',	'30879019',	'93880018',	'236643710',	'193619019',	'236139329',	'238377624',	'238333464',	'237901734',	'10463019',	'237254754',	'148314019',	'201864016',	'65946016',	'238517694',	'139766019',	'66833019',	'233721479',	'233498693',	'234642149',	'415871419',	'236168300',	'239016564',	'238325904',	'236941379',	'135596019',	'236984999',	'87787019',	'753644030',	'167755017',	'238009109',	'236202779',	'237739286',	'88102019',	'588430029',	'3496407499',	'236299764',	'237986244',	'110775019',	'236012840',	'800813657',	'236490299',	'78438019',	'238427754',	'132825011',	'92721017',	'234787196',	'84271019',	'238354704',	'234697430',	'234797249',	'234777329',	'238364844',	'233526800',	'236129699',	'233789849',	'236861035',	'237617935',	'238459344',	'238532574',	'217314019',	'234875639',	'236887916',	'94999016',	'848153',	'202500019',	'238273074',	'86550016',	'71004019',	'116706019',	'238178939',	'238634964',	'237507445',	'238430064',	'276041016',	'234971120',	'238203834',	'234590849',	'237126925',	'238557774',	'237374545',	'233613230',	'238245624',	'238464804',	'235252949',	'108010019',	'238245774',	'238699404',	'238511034',	'111412019',	'588611983',	'238394484',	'238632714',	'236141219',	'225612018',	'234996954',	'106057010',	'238592064',	'235416119',	'238205994',	'238916424',	'238249524',	'237183115',	'237542069',	'238564884',	'234184499',	'192822019',	'238627464',	'102903010',	'238727904',	'238380504',	'169235016',	'238440174',	'153623017',	'98465017',	'237720590',	'238457064',	'235959176',	'238891584',	'210793019',	'122826019',	'237912839',	'126503018',	'236642099',	'235970660',	'238617804',	'238686114',	'238223004',	'238579164',	'1158022',	'234620724',	'238357649',	'236517419',	'238454454',	'238641234',	'234516809',	'238265514',	'238443714',	'236067444',	'238221324',	'238635359',	'238446954',	'238423044',	'7298019',	'238238754',	'238248804',	'239031684',	'800827167',	'234090711',	'237292859',	'238707474',	'234842549',	'238382034',	'238212414',	'238277574',	'237105890',	'238395894',	'238491084',	'73593016',	'124756010',	'238314354',	'238280544',	'239173764',	'238964904',	'234972924',	'238332234',	'160815017',	'61997018',	'237925974',	'238196394',	'800165658',	'238518324',	'233950400',	'239054214',	'238311534',	'234355259',	'238547694',	'238981884',	'238889639',	'238181124',	'238324944',	'238253484',	'238235279',	'189167019',	'234902544',	'238343874',	'238414044',	'238408074',	'234638579',	'238501824',	'239054664',	'238485714',	'234659069',	'238636914',	'238250034',	'238954314',	'234928619',	'233010329',	'237249714',	'239046234',	'800502471',	'238222914',	'132403018',	'237758909',	'238750044',	'238308294',	'113157019',	'238745064',	'238394664',	'238192914',	'115365019',	'238392924',	'238581984',	'238382004',	'238614804',	'238711434',	'234800579',	'238423284',	'238952364',	'239295114',	'234628019',	'237837414',	'238986804',	'238434324',	'238432794',	'238427694',	'238939254',	'238605294',	'238336944',	'47388019',	'236199989',	'238507524',	'236549939',	'236065649',	'236809229',	'239145864',	'239095224',	'238919604',	'3187062094',	'238645194',	'239030724',	'95677015',	'238261679',	'238520694',	'233013509',	'238495554',	'238489794',	'238206444',	'238932534',	'238758354',	'237697349',	'238465944',	'238528014',	'238314774',	'238529184',	'238470414',	'238451004',	'238490184',	'238459494',	'238900764',	'238971354',	'239165934',	'238929864',	'53010019',	'238221834',	'238937604',	'238532844',	'238390314',	'238986534',	'275957019',	'238597224',	'238563744',	'237598829',	'238718964',	'239115864',	'238971654',	'238582164',	'234932009',	'238581234',	'112943016',	'234698090',	'238928934',	'238929654',	'238994934',	'238994514',	'239090454',	'170222010',	'238035269',	'239350824',	'99983019',	'233015549',	'235253399',	'238968414',	'238600224',	'237305155',	'238678734',	'239066094',	'237799465',	'239024994',	'239481534',	'239056974',	'234322349',	'239035074',	'235994759',	'238503174',	'101366019',	'238365654',	'238672284',	'239230104',	'238613754',	'238728384',	'238906104',	'239000214',	'238702584',	'238720944',	'238727754',	'238026624',	'238725294',	'238939344',	'238760214',	'198405019',	'239023974',	'588602899',	'238880544',	'236000633',	'236082230',	'238740024',	'238424454',	'238983534',	'238863264',	'238319064',	'238254264',	'238877604',	'239247714',	'233477330',	'238881174',	'236441366',	'238968804',	'238898064',	'239052354',	'92070019',	'34407019',	'238912734',	'238137714',	'175899019',	'61830019',	'238929504',	'239000934',	'239076414',	'236191079',	'239211354',	'238968054',	'239278944',	'239352204',	'237410574',	'588352380',	'238954194',	'237245180',	'235337874',	'239571384',	'239022024',	'800431411',	'238184694',	'3426016438',	'234443459',	'239023314',	'237989244',	'239020104',	'239765784',	'239032854',	'239008614',	'239095164',	'238156769',	'238997664',	'235007429',	'002382209602',	'239035764',	'238955484',	'239028684',	'238931244',	'238992894',	'239024814',	'238191324',	'253794010',	'238187454',	'238234254',	'797062030',	'234986394',	'12500019',	'236166594',	'237936389',	'235176354',	'4449010',	'238295849',	'236377405',	'235249079',	'238912644',	'238963914',	'234115769',	'239090784',	'239144754',	'238665474',	'239052324',	'239248614',	'236369691',	'239032044',	'238920744',	'236850119',	'105195019',	'239198004',	'239673749',	'238209204',	'233665679',	'238968114',	'125190010',	'240030324',	'800295959',	'237646649',	'150498010',	'239177754',	'239134674',	'238273164',	'239382684',	'238640844',	'239521104',	'235357589',	'238496814',	'239718684',	'239048904',	'238251624',	'238449714',	'235249559',	'239209914',	'235988844',	'239072334',	'238265304',	'239403504',	'239206884',	'234815030',	'235120499',	'800350720',	'234117530',	'236095160',	'238773474',	'238421544',	'236116251',	'3287850859',	'000496370103',	'239630574',	'205635016',	'800456859',	'5634754259',	'238975464',	'99947010',	'800714770',	'238409909',	'238559064',	'238582344',	'104605013',	'54001019',	'128403012',	'238437144',	'238492254',	'4725672780',	'800095869',	'84238016',	'800597379',	'239791884',	'237860069',	'240132114',	'238300256',	'002383002502',	'800111320',	'89481013',	'235069374',	'274284019',	'239643084',	'237087539',	'173106019',	'800467758',	'238719234'
)
AND PR.RECORD_TYPE_CD = 'G'
AND RC.RECORD_TYPE_CD = 'G'
AND LOAN.RECORD_TYPE_CD = 'G'
AND RC.SUMMARY_STATUS_CD NOT IN ('A' , 'N' , 'NC' )
ORDER BY NUMBER_TX
----10



UPDATE #TMPPLCY SET EXCLUDE = 1 WHERE SUMMARY_SUB_STATUS_CD = 'R'
----0

--SELECT DISTINCT SUMMARY_STATUS_CD , SUMMARY_SUB_STATUS_CD FROM #TMPPLCY
--WHERE EXCLUDE = 0 

UPDATE #TMPPLCY SET EXCLUDE = 2 WHERE SUMMARY_SUB_STATUS_CD <> 'D'
AND EXCLUDE = 0
----- 0

UPDATE #TMPPLCY SET EXCLUDE = 3 WHERE SUMMARY_STATUS_CD <> 'E'
AND EXCLUDE = 0
----0

--UPDATE #TMPPLCY SET EXCLUDE = -1 WHERE EXCLUDE = 0 
--AND NOTICE_SEQ_NO > 0
----22


SELECT T1.* , PC.ID AS PC_ID , PC.START_DT , PC.END_DT , PC.TYPE_CD , PC.SUB_TYPE_CD ,
PC.UPDATE_USER_TX AS PC_UPDATE_USER_TX
INTO #TMPPC
FROM POLICY_COVERAGE PC JOIN #TMPPLCY T1 ON T1.ID = PC.OWNER_POLICY_ID
WHERE PC.PURGE_DT IS NULL
AND EXCLUDE = 0 
----- 10

SELECT * 
INTO #TMPPLCY_01
FROM #TMPPLCY
WHERE EXCLUDE = 0
----10


SELECT * 
INTO UnitracHDStorage.dbo.tmpTask36802_PLCY_01
FROM #TMPPLCY
---- 10

SELECT * 
INTO UnitracHDStorage.dbo.tmpTask36802_PC_01
FROM #TMPPC
---- 10

UPDATE PLCY SET 
SUB_STATUS_CD = 'R', 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'TASK36802' , 
LOCK_ID = PLCY.LOCK_ID % 255 + 1
---- SELECT *
FROM OWNER_POLICY PLCY JOIN #TMPPLCY_01 T1 ON T1.ID = PLCY.ID
AND PLCY.STATUS_CD = 'E'
AND PLCY.SUB_STATUS_CD = 'D'
----- 10



----- GET THE LIST OF RC'S IN #TMPRC
---- DROP TABLE #TMPRC
SELECT  *
INTO #TMPRC
FROM #TMPPLCY_01
WHERE CPI_QUOTE_ID > 0
AND EXCLUDE = 0 
----0

---- DROP TABLE #tmpIH
SELECT IH.ID AS IH_ID
INTO #tmpIH
FROM #TMPRC tmp
		JOIN INTERACTION_HISTORY IH ON IH.RELATE_ID = tmp.CPI_QUOTE_ID
WHERE
		IH.TYPE_CD = 'CPI'
		AND IH.RELATE_CLASS_TX = 'ALLIED.UNITRAC.CPIQUOTE'
		AND tmp.RC_ID = ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/RC)[1]', 'BIGINT'),0 )
		and tmp.PROPERTY_ID = IH.property_id     
		AND ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/Status)[1]', 'varchar(20)'),'') = 'Open'
		AND IH.PURGE_DT IS NULL
		---- 0
	
INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	tf.RC_ID,
	'TASK36802',
	'N',
	GETDATE(),
	1,
	'Notice Cycle Cleared',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	TF.RC_ID,
	'PEND',
	'N'
FROM
	 #TMPPLCY_01 tf
WHERE
	NOTICE_SEQ_NO > 0
	AND EXCLUDE = 0 
	----- 0		
						
			
UPDATE QT
	SET	QT.CLOSE_REASON_CD = 'NCC',
		QT.CLOSE_DT = GETDATE(),
		QT.UPDATE_DT = GETDATE(),
		QT.UPDATE_USER_TX = 'TASK36802',
		QT.LOCK_ID = (QT.LOCK_ID % 255) + 1
	--SELECT COUNT(*)
	FROM CPI_QUOTE QT
	JOIN #TMPRC RC
		ON RC.CPI_QUOTE_ID = QT.ID
		---- 0
			
			
UPDATE IH
SET	SPECIAL_HANDLING_XML.modify('replace value of (/SH/Status/text())[1] with "Closed" '),
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'TASK36802',
	LOCK_ID = (IH.LOCK_ID % 255) + 1
--SELECT COUNT(*)
FROM INTERACTION_HISTORY IH
JOIN #tmpIH
	ON #tmpIH.IH_ID = IH.ID
----- 0



UPDATE RC SET GOOD_THRU_DT = NULL , 
INSURANCE_STATUS_CD = 'E' , 
INSURANCE_SUB_STATUS_CD = 'R' , 
SUMMARY_STATUS_CD = 'E' , 
SUMMARY_SUB_STATUS_CD = 'R' , 
NOTICE_DT = NULL , 
NOTICE_SEQ_NO = NULL , 
NOTICE_TYPE_CD = NULL , 
LAST_EVENT_DT = NULL , 
LAST_EVENT_SEQ_ID = NULL , 
LAST_SEQ_CONTAINER_ID = NULL ,
CPI_QUOTE_ID = NULL , 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'TASK36802' , 
LOCK_ID = RC.LOCK_ID % 255 + 1
---- SELECT *
FROM REQUIRED_COVERAGE RC JOIN #TMPPLCY_01 T1 ON T1.RC_ID = RC.ID
WHERE EXCLUDE = 0 
AND RC.SUMMARY_SUB_STATUS_CD = 'D'
AND RC.SUMMARY_STATUS_CD = 'E'
AND RC.INSURANCE_SUB_STATUS_CD = 'D'
AND RC.INSURANCE_STATUS_CD = 'E'
----- 10

INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'TASK36802',
	'N',
	GETDATE(),
	1,
	'Changed Summary status to Re-audit Expired',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'PEND',
	'N'
FROM
	 #TMPPLCY_01 WHERE EXCLUDE = 0 
	 ----- 10
	 
	 
UPDATE EVALUATION_EVENT
SET STATUS_CD = 'CLR',
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'TASK36802',
	LOCK_ID = (LOCK_ID % 255) + 1
--SELECT ee.*
FROM
	EVALUATION_EVENT ee
	JOIN #TMPPLCY_01 te ON ee.REQUIRED_COVERAGE_ID = te.RC_ID
	WHERE ee.STATUS_CD = 'PEND'
	AND ee.EVENT_SEQUENCE_ID > 0
	----0


