-- Bug 29188 : URGENT  LFP: 3171 - Jefferson County - Blanket Loans
-- Change the list of Required Coverages in Active to Blanket state
-- Lender Code = 3171 (Jefferson County Federal Credit Union)
-- Lender Id = 676 (SELECT ID FROM LENDER WHERE CODE_TX = '3171')

IF OBJECT_ID('tempdb..#TMP_ACTIVE_REQCOV_LOANS') IS NOT NULL DROP TABLE #TMP_ACTIVE_REQCOV_LOANS

SELECT DISTINCT LOAN.BRANCH_CODE_TX , LOAN.DIVISION_CODE_TX , LOAN.NUMBER_TX , 
LOAN.ID AS LOAN_ID , COLL.ID AS COLL_ID , COLL.PROPERTY_ID  , 
RC.ID AS RC_ID , RC.TYPE_CD , RC.STATUS_CD , RC.SUMMARY_STATUS_CD , RC.SUMMARY_SUB_STATUS_CD
INTO #TMP_ACTIVE_REQCOV_LOANS
FROM LOAN (NOLOCK) 
JOIN COLLATERAL COLL  (NOLOCK) ON COLL.LOAN_ID = LOAN.ID 
JOIN PROPERTY PROP  (NOLOCK) ON COLL.PROPERTY_ID = PROP.ID
JOIN REQUIRED_COVERAGE RC   (NOLOCK) ON RC.PROPERTY_ID = PROP.ID
WHERE  LOAN.LENDER_ID = 676
AND LOAN.RECORD_TYPE_CD = 'G'
AND LOAN.PURGE_DT IS NULL
AND LOAN.NUMBER_TX IN ('800101611-3','800102990-3','800105780-4','800112660-2','800112891-2','800112891-1','800112892-2','800114280-10','800114900-3','800114990-7','800115480-2','800115490-13','800115680-3','800115800-1','800116290-1','800116470-1','800116610-1','800117160-5','800117161-2','800117423-2','800117900-3','800118230-2','800118230-2','800118400-3','800118530-4','800119670-4','800119680-2','800119680-2','800119681-1','800120580-1','800120581-1','800120860-2','800121040-5','800122430-3','800122690-1','800123181-1','800123400-3','800123420-2','800123460-2','800123500-3','800123840-1','800123980-1','800124160-2','800124210-6','800124210-2','800124220-3','800124220-2','800124670-3','800124860-5','800126420-3','800126590-4','800126590-1','800126680-2','800126780-1','800127170-3','800127180-9','800127410-2','800127500-2','800127510-1','800127760-1','800127870-6','800127870-3','800127900-1','800127920-1','800127920-1','800127930-7','800128090-6','800128090-5','800128090-3','800128380-3','800128400-1','800128510-1','800128530-1','800128940-4','800129150-5','800129470-3','800129610-7','800129800-6','800129800-4','800129980-1','800130700-3','800131260-3','800131260-2','800131330-6','800131330-4','800131850-4','800131880-1','800131890-10','800132050-1','800132650-4','800132700-1','800132830-2','800133190-6','800134600-1','800134630-1','800134970-1','800135010-1','800140930-3','800168510-1','800181840-1','800301150-2','800301460-4','800301460-3','800310360-4','800310360-1','800310691-6','800310692-5','800313860-1','800313863-2','800314180-3','800314180-2','800316671-3','800317210-4','800317452-4','800317452-2','800318630-2','800322240-4','800322240-2','800322241-2','800325531-4','800325533-1','800341780-15','800341810-1','801509930-2','801510170-9','801512930-2','801517090-3','801517090-1','801518150-4','801518151-6','801518270-6','801518271-4','801518271-3','801518272-5','801518272-1','801519560-2','801519600-2','801519610-1','801519610-1','801522110-2','801522920-1','801524140-2','801524140-1','801524480-1','801524610-2','801527011-1','802201040-2','802201591-2','802201591-1','802203113-1','802203453-4','802203861-3','802204060-2','802204092-2','802204281-8','802204281-7','802204331-2','802204380-1','802204572-2','802204575-1','802204579-2','802204580-1','802204661-2','802204661-1','802204780-3','802204970-6','802205200-3','802205290-1')
AND COLL.PURGE_DT IS NULL
AND PROP.PURGE_DT IS NULL
AND PROP.RECORD_TYPE_CD = 'G'
AND RC.RECORD_TYPE_CD = 'G'
AND RC.PURGE_DT IS NULL
AND RC.STATUS_CD = 'A'
-- 156
AND RC.SUMMARY_STATUS_CD IN ('A', 'N')
-- 130

-- Update RequiredCoverage Status from Active to Blanket
UPDATE RC SET STATUS_CD = 'B' , GOOD_THRU_DT = NULL , 
CPI_QUOTE_ID = NULL , NOTICE_DT = NULL , NOTICE_TYPE_CD = NULL , 
NOTICE_SEQ_NO = NULL , LAST_EVENT_SEQ_ID = NULL , LAST_EVENT_DT = NULL ,
UPDATE_DT = GETDATE(), UPDATE_USER_TX = 'UNITRAC' , 
LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1 ELSE LOCK_ID + 1 END 
FROM REQUIRED_COVERAGE RC JOIN #TMP_ACTIVE_REQCOV_LOANS TMP 
ON TMP.RC_ID = RC.ID WHERE RC.STATUS_CD = 'A' AND RC.SUMMARY_STATUS_CD IN ('A', 'N')

-- Add Property change log
INSERT INTO PROPERTY_CHANGE
(
	ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
	CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
	LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN
)
SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , TMP.RC_ID , 'UNITRAC' , 'N' , 
GETDATE(),  1 , 
'Changed Coverage Status from Active to Blanket' , 
'N' , 'Y' , 1 ,  'Allied.UniTrac.RequiredCoverage' , TMP.RC_ID , 'PEND' , 'N'
FROM #TMP_ACTIVE_REQCOV_LOANS TMP


-- The cycle will clear it, if it couldn’t find the ERD.
UPDATE EE SET STATUS_CD = 'CLR' ,
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'BUG29188' ,
LOCK_ID = CASE WHEN EE.LOCK_ID >= 255 THEN 1 ELSE EE.LOCK_ID + 1 END
FROM EVALUATION_EVENT EE JOIN #TMP_ACTIVE_REQCOV_LOANS TMP ON 
TMP.RC_ID = EE.REQUIRED_COVERAGE_ID
WHERE EE.STATUS_CD = 'PEND'

DROP TABLE #TMP_ACTIVE_REQCOV_LOANS
