
USE UniTrac 

--DROP TABLE #tmpLCGCTId
SELECT P.TAB.value('.', 'nvarchar(max)') AS LCGCTId, pd.ID AS ProcId
INTO #tmpLCGCTId
FROM PROCESS_DEFINITION pd 
CROSS APPLY pd.SETTINGS_XML_IM.nodes('/ProcessDefinitionSettings/LenderList/LenderID') AS P (TAB)
WHERE PROCESS_TYPE_CD = 'UTLMTCHIB'
AND EXECUTION_FREQ_CD != 'RUNONCE'

--drop table #process
SELECT
DISTINCT
	LDR.CODE_TX,
	LDR.NAME_TX,
	PD.ID ProcessDefID,
	pd.EXECUTION_FREQ_CD, 
	pd.FREQ_MULTIPLIER_NO,
	SETTINGS_XML_IM.value('(/ProcessDefinitionSettings/TargetServiceList/TargetService)[1]', 'nvarchar(max)') AS ServiceName,
	PD.STATUS_CD
	INTO #process
FROM PROCESS_DEFINITION PD
JOIN #tmpLCGCTId tpc ON tpc.ProcId = PD.ID
JOIN LENDER LDR ON LDR.CODE_TX = tpc.LCGCTId
WHERE PROCESS_TYPE_CD = 'UTLMTCHIB'
AND EXECUTION_FREQ_CD != 'RUNONCE'
ORDER BY [ServiceName]
	


	SELECT P.*, rd.START_DT FROM #process P
	 INNER JOIN LENDER l ON l.CODE_TX = P.CODE_TX
	 LEFT join RELATED_DATA rd ON l.ID = rd.RELATE_ID
           AND rd.DEF_ID = '183' 
		   		   where L.PURGE_DT is null and L.TEST_IN = 'N'
		

--SELECT * FROM dbo.LENDER WHERE CODE_TX IN ('')




/*
DROP TABLE #tmpLCGCTId
DROP TABLE #process

*/
/*
SELECT PD.ID, PLI.* FROM dbo.PROCESS_LOG_ITEM PLI
INNER JOIN dbo.LENDER L ON PLI.RELATE_ID = L.ID AND RELATE_TYPE_CD = 'Allied.UniTrac.Lender'
INNER JOIN dbo.PROCESS_LOG PL ON PL.ID = PLI.PROCESS_LOG_ID
INNER JOIN dbo.PROCESS_DEFINITION PD ON PD.ID = PL.PROCESS_DEFINITION_ID
WHERE CODE_TX = 'XXXX'


SELECT * FROM dbo.PROCESS_LOG
WHERE PROCESS_DEFINITION_ID = '123326'
AND CAST(UPDATE_DT AS DATE) >= CAST(GETDATE()-30 AS DATE)
*/

