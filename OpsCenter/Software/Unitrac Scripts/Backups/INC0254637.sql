-------------- Check Work Items Before Update (To Verify Work Item Definition and Status)
-------------- Work Item ID Number(s) should be provided on HDT
----REPLACE XXXXXXX WITH THE THE WI ID
USE UniTrac

SELECT WI.CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, WI.*, 
INTO UniTracHDStorage..INC0254637
FROM    UniTrac..WORK_ITEM WI
JOIN dbo.LENDER L ON L.ID = WI.LENDER_ID
WHERE   L.CODE_TX IN ('2250', '6485') AND WI.STATUS_CD NOT IN ('Complete' ,'Withdrawn' ,'ImportCompleted') 
AND WORKFLOW_DEFINITION_ID = '13'


UPDATE WI
SET WI.STATUS_CD = 'Withdrawn', WI.LOCK_ID = CASE WHEN WI.LOCK_ID >= 255 THEN 1 ELSE WI.LOCK_ID + 1 END
--SELECT * 
FROM dbo.WORK_ITEM WI
WHERE ID IN (SELECT ID FROM UniTracHDStorage..INC0254637) AND WI.CREATE_DT >= '2016-10-31 '

SELECT  * FROM dbo.WORK_ITEM_ACTION
WHERE WORK_ITEM_ID IN ( XXXXXXX )


--Finding WI via CODE_TX
----REPLACE #### WITH THE THE Lender ID
SELECT CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, *
FROM    UniTrac..WORK_ITEM
WHERE    CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') = '####' 
AND STATUS_CD NOT IN ('Complete' ,'Withdrawn' ,'ImportCompleted')
--AND WORKFLOW_DEFINITION_ID = 'X'


SELECT * FROM dbo.WORKFLOW_DEFINITION



SELECT *
FROM WORK_ITEM
WHERE WORKFLOW_DEFINITION_ID IN (3,6,8)  AND RELATE_TYPE_CD = 'Allied.UniTrac.RequiredCoverage' AND RELATE_ID IN (SELECT REQUIRED_COVERAGE.ID
FROM LOAN
INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
INNER JOIN REQUIRED_COVERAGE ON PROPERTY.ID = REQUIRED_COVERAGE.PROPERTY_ID
INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
WHERE LENDER.CODE_TX = 'XXXX'
AND WORK_ITEM.STATUS_CD NOT LIKE 'Complete' AND WORK_ITEM.STATUS_CD NOT LIKE 'Withdrawn' )
ORDER BY WORK_ITEM.STATUS_CD ASC 


SELECT *
FROM WORK_ITEM
WHERE WORKFLOW_DEFINITION_ID = 8 AND RELATE_TYPE_CD = 'Allied.UniTrac.RequiredCoverage' AND RELATE_ID IN (SELECT REQUIRED_COVERAGE.ID
FROM LOAN
INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
INNER JOIN REQUIRED_COVERAGE ON PROPERTY.ID = REQUIRED_COVERAGE.PROPERTY_ID
INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
WHERE LENDER.CODE_TX = 'XXXX')


SELECT  *
FROM    WORK_ITEM
WHERE   RELATE_TYPE_CD = 'Allied.UniTrac.UTLMatchResult'
        AND RELATE_ID IN (
        SELECT  UTL_MATCH_RESULT.ID
        FROM    LOAN
                INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
                INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
                INNER JOIN dbo.UTL_MATCH_RESULT ON PROPERTY.ID = UTL_MATCH_RESULT.PROPERTY_ID
                INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
        WHERE   LENDER.CODE_TX = '7066'
                AND WORK_ITEM.STATUS_CD NOT LIKE 'Complete'
                AND WORK_ITEM.STATUS_CD NOT LIKE 'Withdrawn' ) 


-------------- Find Work Items By Update User, Definition Type Create Date, and Lender 'LIKE' Name
----REPLACE Lender% WITH THE THE Lender Name keep the % at the end 
	SELECT * FROM UniTrac..WORK_ITEM
	WHERE CONTENT_XML.value('(/Content/Lender/Name)[1]', 'varchar (50)') LIKE 'Lampco%' 
	ORDER BY UPDATE_DT DESC


----LENDER
----REPLACE #### WITH THE THE Lender ID
--via codeTX
SELECT *
FROM UniTrac..LENDER 
WHERE CODE_tX = '####'

--via Name
SELECT *
FROM UniTrac..LENDER 
WHERE NAME_TX = ''



SELECT * FROM dbo.WORK_QUEUE
WHERE NAME_TX LIKE '%Backfeed%'



SELECT * FROM dbo.MESSAGE
WHERE ID = '4761283'