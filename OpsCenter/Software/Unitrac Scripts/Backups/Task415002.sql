
USE Unitrac


SELECT  L.NUMBER_TX, L.ID [LoanID], RC.* INTO UniTracHDStorage..Task41502_RC
FROM    LOAN L
        INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
        INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
        INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
        INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
        INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
        INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
        INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE   LL.CODE_TX IN ( '2005' )
        AND L.ID IN ( )


UPDATE  rc
SET     NOTICE_DT = NULL ,
        NOTICE_SEQ_NO = ( NOTICE_SEQ_NO - 1 ) ,
        LAST_EVENT_DT = NULL ,
        LAST_EVENT_SEQ_ID = NULL ,
        LAST_SEQ_CONTAINER_ID = NULL ,
        GOOD_THRU_DT = NULL ,
        UPDATE_DT = GETDATE() ,
        LOCK_ID = ( LOCK_ID % 255 ) + 1 ,
        UPDATE_USER_TX = 'Task41502'
				  --SELECT NOTICE_DT, NOTICE_SEQ_NO,* 
FROM    dbo.REQUIRED_COVERAGE rc
WHERE   ID IN (SELECT ID FROM UniTracHDStorage..Task41502_RC)
				AND NOTICE_DT IS NOT NULL
			
			
UPDATE  IH
SET     PURGE_DT = GETDATE() ,
        UPDATE_USER_TX = 'Task41502' ,
        UPDATE_DT = GETDATE() ,
        LOCK_ID = ( IH.LOCK_ID % 255 ) + 1		
		          --SELECT * 
FROM    INTERACTION_HISTORY IH
        JOIN NOTICE NTC ON NTC.CPI_QUOTE_ID = IH.RELATE_ID
WHERE   IH.RELATE_CLASS_TX = 'Allied.Unitrac.CPIQuote'
        AND IH.TYPE_CD = 'CPI'
        AND NTC.id IN (SELECT ID FROM UniTracHDStorage..Task41502_L)
		AND IH.UPDATE_DT >= '2017-06-22 '


	
INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , ID , 'Task41502' , 'N' , 
 GETDATE() ,  1 , 
'Cleared Notice Cycle', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.RequiredCoverage' , ID , 'PEND' , 'N'
FROM    dbo.REQUIRED_COVERAGE rc
WHERE   ID IN (SELECT ID FROM UniTracHDStorage..Task41502_RC)
				AND NOTICE_DT IS NOT NULL