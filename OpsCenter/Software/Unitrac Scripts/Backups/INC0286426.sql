USE UniTrac

SELECT RC.* 
INTO UniTracHDStorage..INC0286426
FROM LOAN L
INNER JOIN dbo.NOTICE N ON N.LOAN_ID = L.ID
INNER JOIN dbo.NOTICE_REQUIRED_COVERAGE_RELATE NRC ON NRC.NOTICE_ID = N.ID
INNER JOIN dbo.REQUIRED_COVERAGE RC ON RC.ID = NRC.REQUIRED_COVERAGE_ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE LL.CODE_TX IN ('2864') AND RC.TYPE_CD != 'FLOOD' AND NOTICE_SEQ_NO != '0'
ORDER BY L.UPDATE_DT DESC 

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT L.NUMBER_TX, RC.TYPE_CD, NOTICE_SEQ_NO, RC.NOTICE_DT, rc.NOTICE_DT, RC.* FROM LOAN L
INNER JOIN dbo.NOTICE N ON N.LOAN_ID = L.ID
INNER JOIN dbo.NOTICE_REQUIRED_COVERAGE_RELATE NRC ON NRC.NOTICE_ID = N.ID
INNER JOIN dbo.REQUIRED_COVERAGE RC ON RC.ID = NRC.REQUIRED_COVERAGE_ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE LL.CODE_TX IN ('2864') AND RC.TYPE_CD != 'FLOOD' AND NOTICE_SEQ_NO != '0'
--AND L.NUMBER_TX = '122493142'
ORDER BY L.UPDATE_DT DESC 

UPDATE dbo.REQUIRED_COVERAGE
SET  UPDATE_DT = GETDATE(),UPDATE_USER_TX = ' INC0286426', LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1 ELSE LOCK_ID + 1 END, 
NOTICE_SEQ_NO = '0', NOTICE_DT = NULL, NOTICE_TYPE_CD = NULL
--SELECT * FROM dbo.REQUIRED_COVERAGE
WHERE ID IN (SELECT id FROM UniTracHDStorage..INC0286426)


	
	
INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , L.ID , 'INC0286426' , 'N' , 
 GETDATE() ,  1 , 
'Reset the notice information', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.RequiredCoverage' , L.ID , 'PEND' , 'N'
FROM LOAN L 
WHERE L.ID IN (SELECT id FROM UniTracHDStorage..INC0286426)

