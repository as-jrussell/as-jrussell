--SELECT * FROM LENDER WHERE CODE_TX = '4750'
---- 2231

--- DROP TABLE #TMPPLCY
SELECT LOAN.NUMBER_TX , LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX , 
COLL.LOAN_ID , COLL.ID AS COLL_ID , 
---COLL.PROPERTY_ID , 
RC.TYPE_CD AS RC_TYPE_CD , RC.ID AS RC_ID , 
RC.SUMMARY_SUB_STATUS_CD , RC.SUMMARY_STATUS_CD , RC.EXPOSURE_DT , 
RC.CPI_QUOTE_ID , RC.NOTICE_DT , RC.NOTICE_SEQ_NO , RC.NOTICE_TYPE_CD , 
RC.LAST_EVENT_DT , RC.LAST_EVENT_SEQ_ID , RC.LAST_SEQ_CONTAINER_ID , 
PLCY.* , 0 AS EXCLUDE
INTO #TMPPLCY
FROM LOAN
JOIN COLLATERAL COLL ON COLL.LOAN_ID = LOAN.ID
AND COLL.PURGE_DT IS NULL AND LOAN.PURGE_DT IS NULL
AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = COLL.PROPERTY_ID
AND RC.PURGE_DT IS NULL
JOIN dbo.LENDER LL ON LL.ID = LOAN.LENDER_ID
CROSS APPLY
(
SELECT * FROM dbo.GetCurrentCoverage(PR.ID , RC.ID , RC.TYPE_CD)
)  AS PLCY
WHERE  LL.CODE_TX = '1040' AND RC.INSURANCE_STATUS_CD <> 'e'
       AND LOAN.NUMBER_TX IN ( '1017', '1019', '1039', '1042', '1043', '1049' ,
                            '1067' ,'1073', '1087', '1088', '1093', '1102' ,
                            '1103' ,'1109', '1111', '1113', '1117', '1120' ,
                            '1126' ,'1127', '1129', '1140', '1148', '1149' ,
                            '1171' ,'1173', '1174', '1180', '1181', '1189' ,
                            '1190' ,'1200', '1214', '1215', '1218', '1233' ,
                            '1234' ,'1236', '1239', '1241', '1242', '1263' ,
                            '1276' ,'1279', '1280', '1288', '1290', '1308' ,
                            '1312' ,'1314', '1315', '1316', '1319', '1320' ,
                            '1321' ,'1324', '1326', '1330', '1332', '1338' ,
                            '1343' ,'1347', '1349', '1352', '1353', '1358' ,
                            '1367' ,'1368', '1373', '1399', '1401', '1411' ,
                            '1416' ,'1435', '1436', '1438', '1440', '1443' ,
                            '1444' ,'1448', '1451', '1454', '1455', '1456' ,
                            '1457' ,'1462', '1464', '1465', '1468', '1469' ,
                            '1470' ,'1471', '1474', '1479', '1482', '1488' ,
                            '1489' ,'1491', '1496', '1498', '1505', '1506' ,
                            '1507' ,'1509', '1515', '1516', '1519', '1525' ,
                            '1526' ,'1527', '1529', '1530', '1531', '1533' ,
                            '1544' ,'1547', '1550', '1557', '1558', '1561' ,
                            '1564' ,'1566', '1569', '1573', '1583', '1590' ,
                            '1592' ,'1596', '1598', '1599', '1601', '1605' ,
                            '1606' ,'1609', '1612', '1613', '1618', '1619' ,
                            '1624' ,'1625', '1626', '1627', '1630', '1632' ,
                            '1633' ,'1635', '1638', '1639', '1643', '1646' ,
                            '1647' ,'1654', '1657', '1661', '1663', '1666' ,
                            '1670' ,'1671', '1676', '1680', '1681', '1683' ,
                            '1685' ,'1686', '1687', '1690', '1691', '1692' ,
                            '1693' ,'1694', '1695', '1699', '1704', '1709' ,
                            '1715' ,'1720', '1721', '1724', '1726', '1727' ,
                            '1729' ,'1732', '1735', '1736', '1737', '1741' ,
                            '1748' ,'1755', '1763', '1768', '1773', '1775' ,
                            '1779' ,'1783', '1790', '1795', '1799', '1802' ,
                            '1811' ,'1813', '1818', '1824', '1825', '1827' ,
                            '1828' ,'1830', '1831', '1834', '1835', '1839' ,
                            '1841' ,'1844', '1845', '1846', '1855', '1860' ,
                            '1862' ,'1863', '1864', '1865', '1868', '1870' ,
                            '1871' ,'1874', '1875', '1884', '1885', '1886' ,
                            '1887' ,'1888', '1889', '1896', '1900', '1901' ,
                            '1903' ,'1904', '1905', '1909', '1914', '1919' ,
                            '1929' ,'1940', '1941', '1942', '1943', '1946' ,
                            '1947' ,'1950', '1953', '1955', '1965', '1967' ,
                            '1974' ,'1977', '1982', '1991', '1998', '2001' ,
                            '2006' ,'2008', '2010', '2016', '2024', '2029' ,
                            '2032' ,'2037', '2040', '2045', '2047', '2050' ,
                            '2051' ,'2053', '2054', '2057', '2061', '2062' ,
                            '2064' ,'2065', '2066', '2068', '2070', '2082' ,
                            '2085' ,'2087', '2088', '2094', '2098', '2099' ,
                            '2109' ,'2114', '2119', '2120', '2122', '2124' ,
                            '2139' ,'2141', '2142', '2144', '2147', '2148' ,
                            '2151' ,'2156', '2165', '2166', '2172', '2194' ,
                            '2199' ,'2200', '2206', '2207', '2209', '2214' ,
                            '2215' ,'2219', '2221', '2225', '2227', '2228' ,
                            '2229' ,'2232', '2233', '2234', '2236', '2238' ,
                            '2239' ,'2241', '2242', '2245', '2247', '2248' ,
                            '2251' ,'2257', '2259', '2260', '2261', '2265' ,
                            '2270' ,'2276', '2278', '2280', '2285', '2286' ,
                            '2289' ,'2294', '2304', '2306', '2309', '2311' ,
                            '2312' ,'2314', '2318', '2323', '2325', '2330' ,
                            '2342' ,'2344', '2346', '2348', '2349', '2351' ,
                            '2352' ,'2356', '2359', '2365', '2367', '2369' ,
                            '2373' ,'2377', '2378', '2380', '2388', '2389' ,
                            '2403' ,'2404', '2407', '2415', '2417', '2418' ,
                            '2419' ,'2423', '2430', '2437', '2439', '2441' ,
                            '2445' ,'2447', '2449', '2454', '2458', '2459' ,
                            '2461' ,'2462', '2470', '2476', '2480', '2486' ,
                            '2489' ,'2492', '2494', '2500', '2503', '2504' ,
                            '2516' ,'2518', '2524', '2527', '2529', '2532' ,
                            '2542' ,'2543', '2545', '2546', '2553', '2555' ,
                            '2556' ,'2558', '2564', '2565', '2567', '2570' ,
                            '2576' ,'2578', '2579', '2582', '2585', '2588' ,
                            '2599' ,'2601', '2602', '2604', '2608', '2611' ,
                            '2612' ,'2613', '2617', '2618', '2622', '2624' ,
                            '2628' ,'2630', '2633', '2635', '2637', '2642' ,
                            '2648' ,'2655', '2659', '2667', '2669', '2671' ,
                            '2673' ,'2674', '2676', '2678', '2684', '2703' ,
                            '2706' ,'2707', '2708', '2713', '2716', '2718' ,
                            '2724' ,'2725', '2728', '2731', '2732', '2737' ,
                            '2740' ,'2741', '2745', '2757', '2758', '2763' ,
                            '2764' ,'2766', '2769', '2775', '2776', '2777' ,
                            '2778' ,'2787', '2788', '2790', '2792', '2793' ,
                            '2794' ,'2796', '2799', '2804', '2812', '2813' ,
                            '2827' ,'2834', '2836', '2838', '2842', '2843' ,
                            '2844' ,'2848', '2851', '2854', '2858', '2862' ,
                            '2863' ,'2864', '2865', '2866', '2876', '2877' ,
                            '2879' ,'2881', '2882', '2883', '2886', '2887' ,
                            '2888' ,'2889', '2890', '2891', '2896', '2897' ,
                            '2898' ,'2899', '2900', '2904', '2906', '2907' ,
                            '2910' ,'2912', '2914', '2915', '2927', '2928' ,
                            '2931' ,'2936', '2938', '2939', '2940', '2949' ,
                            '2952' ,'2956', '2963', '2965', '2969', '2973' ,
                            '2975' ,'2976', '2977', '2981', '2982', '2987' ,
                            '2992' ,'2994', '2996', '2999', '3003', '3005' ,
                            '3006' ,'3007', '3009', '3010', '3011', '3014' ,
                            '3017' ,'3018', '3020', '3021', '3024', '3026' ,
                            '3028' ,'3029', '3031', '3032', '3039', '3040' ,
                            '3044' ,'3046', '3053', '3054', '3057', '3058' ,
                            '3060' ,'3061', '3067', '3069', '3070', '3073' ,
                            '3075' ,'3076', '3077', '3078', '3079', '3082' ,
                            '3083' ,'3084', '3093', '3094', '3096', '3098' ,
                            '3099' ,'3100', '3104', '3105', '3106', '3109' ,
                            '3112' ,'3118', '3122', '3124', '3129', '3139' ,
                            '3147' ,'3152', '3158', '3159', '3161', '3162' ,
                            '3163' ,'3164', '3170', '3171', '3175', '3176' ,
                            '3178' ,'3179', '3185', '3187', '3188', '3189' ,
                            '3197' ,'3205', '3206', '3209', '3212', '3216' ,
                            '3217' ,'3218', '3222', '3225', '3228', '3230' ,
                            '3232' ,'3234', '3235', '3239', '3242', '3246' ,
                            '3250' ,'3251', '3252', '3254', '3255', '3257' ,
                            '3258' ,'3264', '3266', '3267', '3271', '3273' ,
                            '3276' ,'3277', '3279', '3281', '3284', '3285' ,
                            '3286' ,'3288', '3289', '3291', '3294', '3300' ,
                            '3304' ,'3305', '3306', '3308', '3310', '3312' ,
                            '3313' ,'3319', '3320', '3321', '3323', '3327' ,
                            '3329' ,'3330', '3333', '3337', '3341', '3343' ,
                            '3344' ,'3348', '3349', '3350', '3351', '3353' ,
                            '3355' ,'3356', '3357', '3359', '3360', '3362' ,
                            '3365' ,'3366', '3367', '3369', '3370', '3372' ,
                            '3378' ,'3382', '3389', '3390', '3391', '3392' ,
                            '3393' ,'3394', '3395', '3397', '3398', '3399' ,
                            '3400' ,'3401', '3402', '3404', '3406', '3407' ,
                            '3410' ,'3411', '3415', '3417', '3422', '3423' ,
                            '3424' ,'3425', '3426', '3427', '3428', '3429' ,
                            '3430' ,'3433', '3435', '3436', '3437', '3438' ,
                            '3441' ,'3442', '3444', '3445', '3448', '3449' ,
                            '3450' ,'3454', '3455', '3457', '3458', '3459' ,
                            '3460' ,'3461', '3462', '3463', '3464', '3465' ,
                            '3466' ,'3467', '3468', '3478', '3483', '3485' ,
                            '3486' ,'3487', '3489', '3492', '3494', '3496' ,
                            '3498' ,'3504', '3505', '3506', '3510', '3513' ,
                            '3514' ,'3517', '3520', '3522', '3523', '3524' ,
                            '3525' ,'3528', '3531', '3536', '3537', '3539' ,
                            '3541' ,'3544', '3545', '3546', '3549', '3550' ,
                            '3552' ,'3555', '3559', '3560', '3561', '3562' ,
                            '3563' ,'3565', '3567', '3570', '3572', '3573' ,
                            '3574' ,'3575', '3576', '3577', '3579', '3580' ,
                            '3581' ,'3582', '3585', '3587', '3590', '3592' ,
                            '3594' ,'3595', '3597', '3606', '3607', '3612' ,
                            '3616' ,'3618', '3619', '3623', '3624', '3625' ,
                            '3626' ,'3627', '3629', '3630', '3632', '3635' ,
                            '3636' ,'3640', '3641', '3643', '3646', '3649' ,
                            '3653' ,'3656', '3657', '3659', '3661', '3662' ,
                            '3663' ,'3664', '3666', '3667', '3668', '3671' ,
                            '3672' ,'3674', '3676', '3677', '3680', '3684' ,
                            '3686' ,'3689', '3691', '3692', '3694', '3696' ,
                            '3697' ,'3698', '3702', '3704', '3706', '3707' ,
                            '3708' ,'3710', '3716', '3720', '3723', '3726' ,
                            '3730' ,'3731', '3735', '3739', '3740', '3741' ,
                            '3742' ,'3745', '3746', '3751', '3753', '3755' ,
                            '3756' ,'3759', '3767', '3774', '3778', '3779' ,
                            '3781' ,'3782', '3791', '3792', '3796', '3800' ,
                            '3803' ,'3807', '3810', '3811', '3815', '3816' ,
                            '3818' ,'3819', '3824', '3825', '3828', '3833' ,
                            '3838' ,'3848', '3855', '3861', '3869', '3878' ,
                            '3885' ,'3886', '3887', '3889', '3926', '3928' ,
                            '3937' ,'3965', '3969', '3981', '3985', '3996' ,
                            '4002' ,'4006', '4008', '4013', '4015', '4020' ,
                            '4024' ,'4026', '4034', '4041', '4057', '4064' ,
                            '4072' ,'4073', '4087', '4093', '4097', '4099' ,
                            '4110' ,'4123', '4133', '4144', '4163', '4190' ,
                            '4192' ,'4201', '4202', '4220', '4224', '4236' ,
                            '4237' ,'4238', '4265', '4269', '4275', '4278' ,
                            '4284' ,'4286', '4312', '4313', '4328', '4337' ,
                            '4343' ,'4351', '4352', '4360', '4375', '4393' ,
                            '4407' ,'4408', '4409', '4420', '4429', '4443' ,
                            '4449' ,'4459', '4460', '4467', '4469', '4472' ,
                            '4477' ,'4480', '4482', '4505', '4510', '4514' ,
                            '4531' ,'4545', '4556', '4558', '4559', '4588' ,
                            '4594' ,'4596', '4598', '4602', '4616', '4620' ,
                            '4625' ,'4640', '4650', '4662', '4666', '4680' ,
                            '4687' ,'4700', '4703', '4707', '4710', '4724' ,
                            '4731' ,'4734', '4739', '4741', '4751', '4755' ,
                            '4770' ,'4774', '4782', '4791', '4796', '4798' ,
                            '4825' ,'4829', '4839', '4846', '4852', '4854' ,
                            '4856' ,'4863', '4865', '4867', '4872', '4876' ,
                            '4877' ,'4898', '4899', '4903', '4908', '4910' ,
                            '4913' ,'4936', '4942', '4953', '4960', '4961' ,
                            '4962' ,'4977', '4985', '4998', '5032', '5033' ,
                            '5035' ,'5040', '5043', '5047', '5069', '5079' ,
                            '5089' ,'5129', '5138', '5162', '5179', '5184' ,
                            '5191' ,'5196', '5197', '5198', '5204', '5205' ,
                            '5213' ,'5216', '5223', '5239', '5250', '5256' ,
                            '5282' ,'5296', '5301', '5309', '5320', '5324' ,
                            '5325' ,'5333', '5342', '5347', '5354', '5379' ,
                            '5386' ,'5390', '5407', '5424', '5426', '5431' ,
                            '5441' ,'5473', '5478', '5481', '5483', '5502' ,
                            '5503' ,'5513', '5517', '5531', '5549', '5552' ,
                            '5615' ,'5649', '5731', '5751', '5757', '5770' ,
                            '5778' ,'5781', '5786', '5789', '5853'
                          )




UPDATE #TMPPLCY SET EXCLUDE = 1 WHERE SUMMARY_SUB_STATUS_CD = 'R'
----0

--SELECT DISTINCT SUMMARY_STATUS_CD , SUMMARY_SUB_STATUS_CD FROM #TMPPLCY
--WHERE EXCLUDE = 0 

UPDATE #TMPPLCY SET EXCLUDE = 2 WHERE SUMMARY_SUB_STATUS_CD <> 'D'
AND EXCLUDE = 0
----- 4

UPDATE #TMPPLCY SET EXCLUDE = 3 WHERE SUMMARY_STATUS_CD <> 'E'
AND EXCLUDE = 0
----49

--UPDATE #TMPPLCY SET EXCLUDE = -1 WHERE EXCLUDE = 0 
--AND NOTICE_SEQ_NO > 0
----22


SELECT T1.* , PC.ID AS PC_ID , PC.START_DT , PC.END_DT , PC.TYPE_CD , PC.SUB_TYPE_CD ,
PC.UPDATE_USER_TX AS PC_UPDATE_USER_TX
INTO #TMPPC
FROM POLICY_COVERAGE PC JOIN #TMPPLCY T1 ON T1.ID = PC.OWNER_POLICY_ID
WHERE PC.PURGE_DT IS NULL
AND EXCLUDE = 0 
----- 874

SELECT * 
INTO #TMPPLCY_01
FROM #TMPPLCY
WHERE EXCLUDE = 0
----856


SELECT * 
INTO UnitracHDStorage.dbo.tmpINC0312123_PLCY_01_0203
FROM #TMPPLCY
---- 909

SELECT * 
INTO UnitracHDStorage.dbo.tmpINC0312123_PC_01_0203
FROM #TMPPC
---- 874

UPDATE PLCY SET 
SUB_STATUS_CD = 'R', 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'INC0312123' , 
LOCK_ID = PLCY.LOCK_ID % 255 + 1
---- SELECT *
FROM OWNER_POLICY PLCY JOIN #TMPPLCY_01 T1 ON T1.ID = PLCY.ID
AND PLCY.STATUS_CD = 'E'
AND PLCY.SUB_STATUS_CD = 'D'
----- 845


----- GET THE LIST OF RC'S IN #TMPRC
---- DROP TABLE #TMPRC
SELECT  *
INTO #TMPRC
FROM #TMPPLCY_01
WHERE CPI_QUOTE_ID > 0
AND EXCLUDE = 0 
----22

---- DROP TABLE #tmpIH
SELECT IH.ID AS IH_ID
--INTO #tmpIH
FROM #TMPRC tmp
		JOIN INTERACTION_HISTORY IH ON IH.RELATE_ID = tmp.CPI_QUOTE_ID
WHERE
		IH.TYPE_CD = 'CPI'
		AND IH.RELATE_CLASS_TX = 'ALLIED.UNITRAC.CPIQUOTE'
		AND tmp.RC_ID = ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/RC)[1]', 'BIGINT'),0 )
		and tmp.PROPERTY_ID = IH.property_id     
		AND ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/Status)[1]', 'varchar(20)'),'') = 'Open'
		AND IH.PURGE_DT IS NULL
		---- 22
	
INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	tf.RC_ID,
	'INC0312123',
	'N',
	GETDATE(),
	1,
	'Notice Cycle Cleared',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	TF.RC_ID,
	'PEND',
	'N'
FROM
	 #TMPPLCY_01 tf
WHERE
	NOTICE_SEQ_NO > 0
	AND EXCLUDE = 0 
	----- 20	
						
			
UPDATE QT
	SET	QT.CLOSE_REASON_CD = 'NCC',
		QT.CLOSE_DT = GETDATE(),
		QT.UPDATE_DT = GETDATE(),
		QT.UPDATE_USER_TX = 'INC0312123',
		QT.LOCK_ID = (QT.LOCK_ID % 255) + 1
	--SELECT COUNT(*)
	FROM CPI_QUOTE QT
	JOIN #TMPRC RC
		ON RC.CPI_QUOTE_ID = QT.ID
		---- 22
			
			
UPDATE IH
SET	SPECIAL_HANDLING_XML.modify('replace value of (/SH/Status/text())[1] with "Closed" '),
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'INC0312123',
	LOCK_ID = (IH.LOCK_ID % 255) + 1
--SELECT COUNT(*)
FROM INTERACTION_HISTORY IH
JOIN #tmpIH
	ON #tmpIH.IH_ID = IH.ID
----- 22



UPDATE RC SET GOOD_THRU_DT = NULL , 
EXPOSURE_DT = NULL ,
INSURANCE_STATUS_CD = 'E' , 
INSURANCE_SUB_STATUS_CD = 'R' , 
SUMMARY_STATUS_CD = 'E' , 
SUMMARY_SUB_STATUS_CD = 'R' , 
NOTICE_DT = NULL , 
NOTICE_SEQ_NO = NULL , 
NOTICE_TYPE_CD = NULL , 
LAST_EVENT_DT = NULL , 
LAST_EVENT_SEQ_ID = NULL , 
LAST_SEQ_CONTAINER_ID = NULL ,
CPI_QUOTE_ID = NULL , 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'INC0312123' , 
LOCK_ID = RC.LOCK_ID % 255 + 1
---- SELECT *
FROM REQUIRED_COVERAGE RC JOIN #TMPPLCY_01 T1 ON T1.RC_ID = RC.ID
WHERE --EXCLUDE = 0 AND
 RC.SUMMARY_SUB_STATUS_CD = 'D'
AND RC.SUMMARY_STATUS_CD = 'E'
AND RC.INSURANCE_SUB_STATUS_CD = 'D'
AND RC.INSURANCE_STATUS_CD = 'E'
----- 856

INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'INC0312123',
	'N',
	GETDATE(),
	1,
	'Changed Summary status to Re-audit Expired',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'PEND',
	'N'
FROM
	 #TMPPLCY_01 WHERE EXCLUDE = 0 
	 ----- 853
	 
	 
UPDATE EE
SET STATUS_CD = 'CLR',
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'INC0312123',
	LOCK_ID = (ee.LOCK_ID % 255) + 1
--SELECT ee.*
FROM
	EVALUATION_EVENT EE
	JOIN #TMPPLCY_01 te ON EE.REQUIRED_COVERAGE_ID = te.RC_ID
	WHERE EE.STATUS_CD = 'PEND'
	AND EE.EVENT_SEQUENCE_ID > 0
	----78


