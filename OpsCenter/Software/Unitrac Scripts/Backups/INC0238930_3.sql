USE UniTrac


SELECT INC.ID FROM UniTracHDStorage..[Loans Updated] LU
LEFT JOIN UniTracHDStorage..INC0238930 INC ON LU.[Old Contract Number] = INC.NUMBER_TX



--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT L.*, P.ADDRESS_ID, P.MAKE_TX, P.MODEL_TX, C.COLLATERAL_CODE_ID, C.ID C_ID, P.ID [P_ID]
INTO #tmpA
FROM UniTracHDStorage..INC0238930 L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
WHERE L.ID IN (SELECT INC.ID FROM UniTracHDStorage..[Loans Updated] LU
LEFT JOIN UniTracHDStorage..INC0238930 INC ON LU.[Old Contract Number] = INC.NUMBER_TX)



--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT L.*, P.ADDRESS_ID, P.MAKE_TX, P.MODEL_TX, C.COLLATERAL_CODE_ID, C.ID C_ID, P.ID [P_ID]
INTO #tmpB
FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
WHERE L.ID IN (SELECT INC.ID FROM UniTracHDStorage..[Loans Updated] LU
LEFT JOIN dbo.LOAN INC ON LU.[New Contract Number]= INC.NUMBER_TX)


SELECT * 
INTO #tmpC
FROM UniTracHDStorage..[Loans Updated] 



SELECT * FROM #tmpA
--WHERE NUMBER_TX IN ('11563000-D', '11563000-F')

SELECT * FROM #tmpB
WHERE NUMBER_TX IN ('11563000-1')



SELECT B.* FROM #tmpA A
JOIN #tmpB B ON  A.C_ID = B.C_ID
WHERE B.NUMBER_TX IN ('11563000-D','11563000-F')



UPDATE B
SET B.NUMBER_TX = A.NUMBER_TX
--SELECT * 
FROM #tmpB B
JOIN #tmpA A ON A.C_ID = B.C_ID




SELECT *
 FROM #tmpB B
LEFT JOIN #tmpC C ON B.NUMBER_TX = C.[Old Contract Number]
WHERE C.[Old Contract Number] IS NOT NULL





UPDATE B 
SET  B.NUMBER_TX = C.[New Correct Number]
--SELECT B.* 
FROM #tmpB B
JOIN #tmpA A ON A.C_ID = B.C_ID
LEFT JOIN #tmpC C ON B.NUMBER_TX = C.[Old Contract Number]
WHERE C.[Old Contract Number] IS NOT NULL


SELECT * FROM #tmpB
WHERE NUMBER_TX IN ('3259022-2',
'3930003-2',
'4772002-3',
'5546004-2',
'7243006-2',
'7273009-2',
'8179002-2',
'8282006-2',
'8568001-2',
'8580005-2',
'8585000-2',
'8585000-3',
'8692000-2',
'8793032-2',
'8814003-3',
'8860006-2',
'9182005-2',
'9182005-4',
'9345009-2',
'9376001-2',
'9376001-3',
'9612005-2',
'9752005-2',
'9936004-2',
'9947001-2',
'9947001-3',
'10061009-2',
'10267001-2',
'10467009-2',
'10695003-2',
'11026001-1',
'11026001-2',
'11144008-1',
'11563000-2',
'11563000-3',
'11568005-2',
'11605000-2',
'11695004-2',
'11739000-2',
'11820008-2',
'11860004-2',
'11860004-2',
'11893005-2',
'11893005-3',
'11935004-2',
'11941002-2',
'12064002-1',
'12106001-1',
'12328001-2',
'12425005-2',
'12451001-2',
'12536009-2',
'12682001-3',
'12811006-2',
'12881009-2',
'12963005-3',
'12969002-2',
'12972006-2',
'13007000-2',
'13039003-2',
'13227004-3',
'13272056-2',
'13272056-3',
'13272081-2',
'13272160-3',
'13272160-4',
'13272169-2',
'13272280-2',
'13272762-2',
'13273063-3',
'13273063-2',
'13273339-2',
'13273352-2',
'13273461-2',
'13273487-2',
'13273487-3',
'13273618-3',
'13273618-2',
'13273655-2',
'13273686-2',
'13273686-4',
'13273687-3',
'13273687-2',
'13273887-2',
'13273979-2',
'13273988-2',
'13273988-3',
'13274106-2',
'13274106-3',
'13274126-2',
'13274131-2',
'13274135-2',
'13274274-2',
'13274419-2',
'13274452-2',
'13274521-2',
'13274677-2',
'13274765-2',
'13274793-2',
'13274914-2',
'13275139-2',
'13275139-3',
'13275160-4',
'13275190-2',
'13275190-3',
'13275196-2',
'13275255-2',
'13275337-2',
'13275370-2',
'13275425-2',
'13275465-2',
'13275476-2',
'13275599-2',
'13275636-2',
'13275658-3',
'13275658-5',
'13275721-2',
'13275768-3',
'13275783-2',
'13275822-2',
'13275836-2',
'13275838-3',
'13275841-2',
'13275970-2',
'13276023-2',
'13276043-3',
'13276043-4',
'13276047-2',
'13276064-2',
'13276094-2',
'13276094-4',
'13276101-2',
'13276101-3',
'13276106-2',
'13276112-4',
'13276112-5',
'13276184-3',
'13276202-2',
'13276202-4',
'13276202-5',
'13276211-2',
'13276276-2',
'13276291-2',
'13276297-4',
'13276311-2',
'13276335-2',
'13276352-2',
'13276365-2',
'13276372-2',
'13276378-2',
'13276384-2',
'13276453-2',
'13276453-3',
'13276465-2',
'13276487-2',
'13276492-2',
'13276508-3',
'13276610-2',
'13276612-2',
'13276625-2',
'13276649-3',
'13276663-3',
'13276728-3',
'13276757-5',
'13276757-2',
'13276801-2',
'13276817-2',
'13276835-2',
'13276952-4',
'13276982-2',
'13276996-2',
'13277028-2',
'13277031-2',
'13277078-3',
'13277141-2',
'13277158-4',
'13277162-2',
'13277187-2',
'13277187-3',
'13277215-2',
'13277268-2',
'13277271-2',
'13277272-2',
'13277276-2',
'13277276-3',
'13277290-2',
'13277310-2',
'13277352-2',
'13277359-2',
'13277359-3',
'13277378-2',
'13277389-2',
'13277391-2',
'13277400-2')





UPDATE L
SET L.LOCK_ID = L.LOCK_ID+1, L.UPDATE_DT = GETDATE(), L.UPDATE_USER_TX = 'INC0238930', L.NUMBER_TX = B.NUMBER_TX
--SELECT * 
FROM dbo.LOAN L 
JOIN #tmpB B ON B.ID = L.ID 


--2) INSERT into PROPERTY_CHANGE table
INSERT INTO PROPERTY_CHANGE (ENTITY_NAME_TX,ENTITY_ID,USER_TX,ATTACHMENT_IN,CREATE_DT,AGENCY_ID,DETAILS_IN,FORMATTED_IN,LOCK_ID,PARENT_NAME_TX,PARENT_ID,TRANS_STATUS_CD,UTL_IN)
SELECT 'Allied.UniTrac.Loan',LOAN.ID,'INC0238930','N','2016-07-11 00:00:00.000',1,'Y','N',1,'Allied.UniTrac.Loan',LOAN.ID,'PEND','N'
FROM LOAN
WHERE ID IN (SELECT ID FROM #tmpB)
--42


--3) INSERT into PROPERTY_CHANGE_UPDATE table
INSERT INTO PROPERTY_CHANGE_UPDATE (CHANGE_ID, TABLE_NAME_TX, TABLE_ID, COLUMN_NM, FROM_VALUE_TX,TO_VALUE_TX,DATATYPE_NO,CREATE_DT,DISPLAY_IN,OPERATION_CD)
select PC.ID,'LOAN',ENTITY_ID,'NUMBER_TX',B.NUMBER_TX,L.NUMBER_TX,1,'2016-04-01 00:00:00.000','Y','U'
from PROPERTY_CHANGE PC
INNER JOIN LOAN L ON PC.ENTITY_ID = L.ID AND ENTITY_NAME_TX = 'Allied.UniTrac.Loan' 
INNER JOIN #tmpB B ON L.ID = B.ID --AND ENTITY_NAME_TX = 'Allied.UniTrac.Loan' 
WHERE PC.CREATE_DT = '2016-07-11 00:00:00.000'
AND ENTITY_ID IN (SELECT ID FROM #tmpB)
--0

---4) Insert into LOAN_NUMBER Table (Leave old numbers for matching purposes)

INSERT INTO LOAN_NUMBER (LOAN_ID,NUMBER_TX,EFFECTIVE_DT,CREATE_DT,UPDATE_DT,UPDATE_USER_TX, LOCK_ID)
SELECT dbo.LOAN.ID, dbo.LOAN.NUMBER_TX,dbo.LOAN.EFFECTIVE_DT,GETDATE(),GETDATE(),'INC0238930',1
FROM #tmpB HD INNER JOIN dbo.LOAN ON HD.ID = LOAN.ID
--42

--5) Full Text Search Updates

--Create updates
SELECT 'EXEC SaveSearchFullText', PROPERTY.ID 
FROM PROPERTY
INNER JOIN COLLATERAL ON PROPERTY.ID = COLLATERAL.PROPERTY_ID
AND LOAN_ID in (select ID FROM #tmpB)
--42



EXEC SaveSearchFullText	70512698
EXEC SaveSearchFullText	1821454
EXEC SaveSearchFullText	70512697
EXEC SaveSearchFullText	1821456
EXEC SaveSearchFullText	122918927
EXEC SaveSearchFullText	1821491
EXEC SaveSearchFullText	1821525
EXEC SaveSearchFullText	1821531
EXEC SaveSearchFullText	87782780
EXEC SaveSearchFullText	1821549
EXEC SaveSearchFullText	49512654
EXEC SaveSearchFullText	87782782
EXEC SaveSearchFullText	1821558
EXEC SaveSearchFullText	75989662
EXEC SaveSearchFullText	1821624
EXEC SaveSearchFullText	70512805
EXEC SaveSearchFullText	119402855
EXEC SaveSearchFullText	1821626
EXEC SaveSearchFullText	1821644
EXEC SaveSearchFullText	87782857
EXEC SaveSearchFullText	1821684
EXEC SaveSearchFullText	101864424
EXEC SaveSearchFullText	1828836
EXEC SaveSearchFullText	42451700
EXEC SaveSearchFullText	85043916
EXEC SaveSearchFullText	1835567
EXEC SaveSearchFullText	85043923
EXEC SaveSearchFullText	1835571
EXEC SaveSearchFullText	104271565
EXEC SaveSearchFullText	1835575
EXEC SaveSearchFullText	1841558
EXEC SaveSearchFullText	70512795
EXEC SaveSearchFullText	1855203
EXEC SaveSearchFullText	1893274
EXEC SaveSearchFullText	19585458
EXEC SaveSearchFullText	16613605
EXEC SaveSearchFullText	72057121
EXEC SaveSearchFullText	1899215
EXEC SaveSearchFullText	33002922
EXEC SaveSearchFullText	75989638
EXEC SaveSearchFullText	1969301
EXEC SaveSearchFullText	104271543
EXEC SaveSearchFullText	2003130
EXEC SaveSearchFullText	2017536
EXEC SaveSearchFullText	2029107
EXEC SaveSearchFullText	2029115
EXEC SaveSearchFullText	52938812
EXEC SaveSearchFullText	2034525
EXEC SaveSearchFullText	70512820
EXEC SaveSearchFullText	2044273
EXEC SaveSearchFullText	2074292
EXEC SaveSearchFullText	113611785
EXEC SaveSearchFullText	2115109
EXEC SaveSearchFullText	2426106
EXEC SaveSearchFullText	107648123
EXEC SaveSearchFullText	1995274
EXEC SaveSearchFullText	2426121
EXEC SaveSearchFullText	119402861
EXEC SaveSearchFullText	2426206
EXEC SaveSearchFullText	30285196
EXEC SaveSearchFullText	2943431
EXEC SaveSearchFullText	4300990
EXEC SaveSearchFullText	6372016
EXEC SaveSearchFullText	7636055
EXEC SaveSearchFullText	2034523
EXEC SaveSearchFullText	97529841
EXEC SaveSearchFullText	97529829
EXEC SaveSearchFullText	80819219
EXEC SaveSearchFullText	8826411
EXEC SaveSearchFullText	70512797
EXEC SaveSearchFullText	11840639
EXEC SaveSearchFullText	13727190
EXEC SaveSearchFullText	121616387
EXEC SaveSearchFullText	14456087
EXEC SaveSearchFullText	19585806
EXEC SaveSearchFullText	22345431
EXEC SaveSearchFullText	24923529
EXEC SaveSearchFullText	24923534
EXEC SaveSearchFullText	24923544
EXEC SaveSearchFullText	26809146
EXEC SaveSearchFullText	26809147
EXEC SaveSearchFullText	30285159
EXEC SaveSearchFullText	30285179
EXEC SaveSearchFullText	30285183
EXEC SaveSearchFullText	30285192
EXEC SaveSearchFullText	30285200
EXEC SaveSearchFullText	30285203
EXEC SaveSearchFullText	30285206
EXEC SaveSearchFullText	31126347
EXEC SaveSearchFullText	70512850
EXEC SaveSearchFullText	31126714
EXEC SaveSearchFullText	31715030
EXEC SaveSearchFullText	32111540
EXEC SaveSearchFullText	33002922
EXEC SaveSearchFullText	35996406
EXEC SaveSearchFullText	33817609
EXEC SaveSearchFullText	33832357
EXEC SaveSearchFullText	33832354
EXEC SaveSearchFullText	35995710
EXEC SaveSearchFullText	35995777
EXEC SaveSearchFullText	97529833
EXEC SaveSearchFullText	39523515
EXEC SaveSearchFullText	122918938
EXEC SaveSearchFullText	12444128
EXEC SaveSearchFullText	89525085
EXEC SaveSearchFullText	40979676
EXEC SaveSearchFullText	46827512
EXEC SaveSearchFullText	1821487
EXEC SaveSearchFullText	46827510
EXEC SaveSearchFullText	47652983
EXEC SaveSearchFullText	12444128
EXEC SaveSearchFullText	49512641
EXEC SaveSearchFullText	50269609
EXEC SaveSearchFullText	52938810
EXEC SaveSearchFullText	2133994
EXEC SaveSearchFullText	54770619
EXEC SaveSearchFullText	54770700
EXEC SaveSearchFullText	55741182
EXEC SaveSearchFullText	55741183
EXEC SaveSearchFullText	34521336
EXEC SaveSearchFullText	2029116
EXEC SaveSearchFullText	61049053
EXEC SaveSearchFullText	61049078
EXEC SaveSearchFullText	2034516
EXEC SaveSearchFullText	62527814
EXEC SaveSearchFullText	62527815
EXEC SaveSearchFullText	1860598
EXEC SaveSearchFullText	65103086
EXEC SaveSearchFullText	119402849
EXEC SaveSearchFullText	66675186
EXEC SaveSearchFullText	66675188
EXEC SaveSearchFullText	68907176
EXEC SaveSearchFullText	68907180
EXEC SaveSearchFullText	68907181
EXEC SaveSearchFullText	70512673
EXEC SaveSearchFullText	70512677
EXEC SaveSearchFullText	70512678
EXEC SaveSearchFullText	70512680
EXEC SaveSearchFullText	70512682
EXEC SaveSearchFullText	70512683
EXEC SaveSearchFullText	70512686
EXEC SaveSearchFullText	70512687
EXEC SaveSearchFullText	70512688
EXEC SaveSearchFullText	70512694
EXEC SaveSearchFullText	70512704
EXEC SaveSearchFullText	107648116
EXEC SaveSearchFullText	70512708
EXEC SaveSearchFullText	70512710
EXEC SaveSearchFullText	70512713
EXEC SaveSearchFullText	70512735
EXEC SaveSearchFullText	70512741
EXEC SaveSearchFullText	70512743
EXEC SaveSearchFullText	70512744
EXEC SaveSearchFullText	70512745
EXEC SaveSearchFullText	68907180
EXEC SaveSearchFullText	70512746
EXEC SaveSearchFullText	70512751
EXEC SaveSearchFullText	70512781
EXEC SaveSearchFullText	70512786
EXEC SaveSearchFullText	70512789
EXEC SaveSearchFullText	70512790
EXEC SaveSearchFullText	70512803
EXEC SaveSearchFullText	70512815
EXEC SaveSearchFullText	70512824
EXEC SaveSearchFullText	70512831
EXEC SaveSearchFullText	70512832
EXEC SaveSearchFullText	70512834
EXEC SaveSearchFullText	70512835
EXEC SaveSearchFullText	70512840
EXEC SaveSearchFullText	70512841
EXEC SaveSearchFullText	70512842
EXEC SaveSearchFullText	70512844
EXEC SaveSearchFullText	70512847
EXEC SaveSearchFullText	70512849
EXEC SaveSearchFullText	72057123
EXEC SaveSearchFullText	73544761
EXEC SaveSearchFullText	73545858
EXEC SaveSearchFullText	70512735
EXEC SaveSearchFullText	74523657
EXEC SaveSearchFullText	74523660
EXEC SaveSearchFullText	74523667
EXEC SaveSearchFullText	8934050
EXEC SaveSearchFullText	76383513
EXEC SaveSearchFullText	76383569
EXEC SaveSearchFullText	24923534
EXEC SaveSearchFullText	79424951
EXEC SaveSearchFullText	1821648
EXEC SaveSearchFullText	79757048
EXEC SaveSearchFullText	49512641
EXEC SaveSearchFullText	80819230
EXEC SaveSearchFullText	82101147
EXEC SaveSearchFullText	83695027
EXEC SaveSearchFullText	83695030
EXEC SaveSearchFullText	70512744
EXEC SaveSearchFullText	1995274
EXEC SaveSearchFullText	83695035
EXEC SaveSearchFullText	85043902
EXEC SaveSearchFullText	70512677
EXEC SaveSearchFullText	85043907
EXEC SaveSearchFullText	85043912
EXEC SaveSearchFullText	85043913
EXEC SaveSearchFullText	85043937
EXEC SaveSearchFullText	85043969
EXEC SaveSearchFullText	1875228
EXEC SaveSearchFullText	86412093
EXEC SaveSearchFullText	104271576
EXEC SaveSearchFullText	46827498
EXEC SaveSearchFullText	86412105
EXEC SaveSearchFullText	86412111
EXEC SaveSearchFullText	87782744
EXEC SaveSearchFullText	1821479
EXEC SaveSearchFullText	87782774
EXEC SaveSearchFullText	93301025
EXEC SaveSearchFullText	1860598
EXEC SaveSearchFullText	87782787
EXEC SaveSearchFullText	87782826
EXEC SaveSearchFullText	89525041
EXEC SaveSearchFullText	34521336
EXEC SaveSearchFullText	119402837
EXEC SaveSearchFullText	89525049
EXEC SaveSearchFullText	89525066
EXEC SaveSearchFullText	89525065
EXEC SaveSearchFullText	90441996
EXEC SaveSearchFullText	93301003
EXEC SaveSearchFullText	70512695
EXEC SaveSearchFullText	93301004
EXEC SaveSearchFullText	93301008
EXEC SaveSearchFullText	93301009
EXEC SaveSearchFullText	93301010
EXEC SaveSearchFullText	93301011
EXEC SaveSearchFullText	19585791
EXEC SaveSearchFullText	93301017
EXEC SaveSearchFullText	93301018
EXEC SaveSearchFullText	93301019
EXEC SaveSearchFullText	93301020
EXEC SaveSearchFullText	93301021
EXEC SaveSearchFullText	93301023
EXEC SaveSearchFullText	93301024
EXEC SaveSearchFullText	11840621
EXEC SaveSearchFullText	95265736
EXEC SaveSearchFullText	95265762
EXEC SaveSearchFullText	95265770
EXEC SaveSearchFullText	95265805
EXEC SaveSearchFullText	95265811
EXEC SaveSearchFullText	93301028
EXEC SaveSearchFullText	97529813
EXEC SaveSearchFullText	1893276
EXEC SaveSearchFullText	97529837
EXEC SaveSearchFullText	97529843
EXEC SaveSearchFullText	99090309
EXEC SaveSearchFullText	99090310
EXEC SaveSearchFullText	11840648
EXEC SaveSearchFullText	97529831
EXEC SaveSearchFullText	99090714
EXEC SaveSearchFullText	11840648
EXEC SaveSearchFullText	97529831
EXEC SaveSearchFullText	99090768
EXEC SaveSearchFullText	99090771
EXEC SaveSearchFullText	2044271
EXEC SaveSearchFullText	100532162
EXEC SaveSearchFullText	101864427
EXEC SaveSearchFullText	100532154
EXEC SaveSearchFullText	101864435
EXEC SaveSearchFullText	19585802
EXEC SaveSearchFullText	104271566
EXEC SaveSearchFullText	104646562
EXEC SaveSearchFullText	107648112
EXEC SaveSearchFullText	107648113
EXEC SaveSearchFullText	107648120
EXEC SaveSearchFullText	113611783
EXEC SaveSearchFullText	93301018
EXEC SaveSearchFullText	107648122
EXEC SaveSearchFullText	107648132
EXEC SaveSearchFullText	107648134
EXEC SaveSearchFullText	110119351
EXEC SaveSearchFullText	110119353
EXEC SaveSearchFullText	110119354
EXEC SaveSearchFullText	110119355
EXEC SaveSearchFullText	110119358
EXEC SaveSearchFullText	1821552
EXEC SaveSearchFullText	110119363
EXEC SaveSearchFullText	110119364
EXEC SaveSearchFullText	113611779
EXEC SaveSearchFullText	113611780
EXEC SaveSearchFullText	110119360
EXEC SaveSearchFullText	113611786
EXEC SaveSearchFullText	113611788
EXEC SaveSearchFullText	113611789
EXEC SaveSearchFullText	113611791
EXEC SaveSearchFullText	115247660
EXEC SaveSearchFullText	68907175
EXEC SaveSearchFullText	115247678
EXEC SaveSearchFullText	115247679
EXEC SaveSearchFullText	115247680
EXEC SaveSearchFullText	115247660
EXEC SaveSearchFullText	119402836
EXEC SaveSearchFullText	119402840
EXEC SaveSearchFullText	119402842
EXEC SaveSearchFullText	119402843
EXEC SaveSearchFullText	119402844
EXEC SaveSearchFullText	113611782
EXEC SaveSearchFullText	119402847
EXEC SaveSearchFullText	119402848
EXEC SaveSearchFullText	119402850
EXEC SaveSearchFullText	119402851
EXEC SaveSearchFullText	119402853
EXEC SaveSearchFullText	119402854
EXEC SaveSearchFullText	119402856
EXEC SaveSearchFullText	20460876
EXEC SaveSearchFullText	119402858
EXEC SaveSearchFullText	119402860
EXEC SaveSearchFullText	121616367
EXEC SaveSearchFullText	121616385
EXEC SaveSearchFullText	121616392
EXEC SaveSearchFullText	121616406
EXEC SaveSearchFullText	121616407
EXEC SaveSearchFullText	122918929
EXEC SaveSearchFullText	122918930
EXEC SaveSearchFullText	122918931
EXEC SaveSearchFullText	122918933
EXEC SaveSearchFullText	122918936
EXEC SaveSearchFullText	76963563