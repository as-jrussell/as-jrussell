USE UniTrac


--Pull all Hazard that are done by LDH service into temp table
SELECT L.NUMBER_TX, OP.POLICY_NUMBER_TX, PC.* 
INTO #tmpHaz
 FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
INNER JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
INNER JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
WHERE LL.CODE_TX IN ('3000') AND pc.TYPE_CD IN ('HAZARD')
AND L.UPDATE_USER_TX = 'LDHPCRA'



--Pull all Flood that are done by LDH service into temp table
SELECT L.NUMBER_TX, OP.POLICY_NUMBER_TX, PC.* 
INTO #tmpFlood
 FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
INNER JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
INNER JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
WHERE LL.CODE_TX IN ('3000') AND pc.TYPE_CD IN ('FLOOD')
AND L.UPDATE_USER_TX = 'LDHPCRA'


--These are the ones that have both the same policy number for both flood and hazard
SELECT  F.POLICY_NUMBER_TX , H.POLICY_NUMBER_TX , F.TYPE_CD, H.TYPE_CD, * FROM #tmpHaz H
JOIN #tmpFlood F ON  F.POLICY_NUMBER_TX = H.POLICY_NUMBER_TX 

---Backup Hazard (add ticket number)
SELECT * 
INTO UnitracHDStorage..INC0321374
FROM #tmpHaz

---Backup Flood (add ticket number)
SELECT * 
INTO UnitracHDStorage..INC0321374
FROM #tmpFlood

--Create tmp table ID's that will be purged
SELECT F.ID INTO #tmpFloodPurge FROM #tmpHaz H
JOIN #tmpFlood F ON  F.POLICY_NUMBER_TX = H.POLICY_NUMBER_TX 
WHERE F.TYPE_CD IN ('FLOOD')


--- Purge out the unneeded Floods
UPDATE PC 
SET OP.PURGE_DT = GETDATE(), OP.UPDATE_USER_TX = 'INC0321374', OP.LOCK_ID = OP.LOCK_ID+1, 
OP.UPDATE_DT = GETDATE()
--SELECT * 
FROM dbo.POLICY_COVERAGE PC
WHERE ID IN (SELECT * FROM #tmpFloodPurge) 



