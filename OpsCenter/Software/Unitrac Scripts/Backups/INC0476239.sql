USE [UniTrac]
GO 

--Implementation
SELECT LL.CODE_TX, LL.NAME_TX, collateral_code_id,RC.* 
into unitrachdstorage..INC0476239
FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE
 ll.CODE_TX = '6485' and l.NUMBER_TX IN ('9701279185',
'9701221823',
'9701197957',
'9701268311',
'9701232598',
'9800571565',
'9800636350',
'9701142250',
'9701111735',
'9701267180',
'9701273915',
'9701271927',
'9701127558',
'9701215148',
'9701205487',
'9701231905',
'9701262488',
'9701106305',
'9701101942',
'9800518905',
'9701179211',
'9701262041',
'9701239734',
'9701245426',
'9701231046',
'9701232283',
'9701155203',
'9701218431',
'9701300759',
'9701233505',
'9800616113',
'9701225915',
'9701271513',
'9701240112',
'9800591522',
'9701230071',
'9701171580',
'9701275126',
'9701235484',
'9701132384',
'9701102981',
'9701151046',
'9701241557',
'9701294333',
'9701115314',
'9701207863',
'9701105042',
'9701269103',
'9800566227',
'9701146491',
'9800542533',
'9800580657',
'9701178478',
'9701272826',
'9701147796',
'9701158710',
'9800520661',
'9800520661',
'9701232036',
'9800521495',
'9800497647',
'9701281181',
'9701228190',
'9701280704',
'9701212525',
'9701125081',
'9701228976',
'9701218373',
'9701127913',
'9701230725',
'9701239221',
'9701239221',
'9701193642',
'9701187628',
'9701187651',
'9800601529',
'9701189285',
'9701300254',
'9701212533',
'9800567076',
'9800564602',
'9800552805',
'9800552805',
'9701139744',
'9701135783',
'9800564420',
'9701203847',
'9701236482',
'9800497639',
'9701219512',
'9701280381',
'9800576408',
'9701257025',
'9701215817',
'9701201577',
'9701153422',
'9800498579',
'9701201494',
'9701257546',
'9701202195',
'9800477110',
'9701218985',
'9800624042',
'9701089279',
'9701263510',
'9800485931',
'9701238694',
'9701271067',
'9701224850',
'9701156821',
'9701208986',
'9701241375',
'9701219553',
'9701219553',
'9800495062',
'9800624521',
'9701160930',
'9701188725',
'9701179047',
'9701234131',
'9701181811',
'9701280902',
'9701282478',
'9701157613',
'9800640964',
'9701246390',
'9701246390',
'9701246390',
'9800560287',
'9800578800',
'9701182256',
'9701175888',
'9701274426',
'9701295413',
'9701295413',
'9701295413',
'9800496227',
'9800601867',
'9701133861',
'9800582430',
'9800582430',
'9800524994',
'9701256332',
'9800579345',
'9800579345',
'9701129687',
'9701210495',
'9701109135',
'9701158413',
'9701200819',
'9701240419',
'9701215999',
'9800502016',
'9800511249',
'9800593601',
'9800586118',
'9800586118',
'9701100209',
'9800490311',
'9800576937',
'9800477128',
'9800478837',
'9800480817',
'9800485071',
'9800486582',
'9800487291',
'9800487630',
'9800491020',
'9800491772',
'9701193097',
'9800492291',
'9800493414',
'9800493430',
'9701107048',
'9800493943',
'9800493943',
'9800495153',
'9800495286',
'9800495468',
'9800496151',
'9701200686',
'9800498470',
'9800499361',
'9800501570',
'9800501877',
'9800502230',
'9701131212',
'9800504210',
'9701133820',
'9800504459',
'9800592447',
'9800592447',
'9800505514',
'9800506884',
'9701160005',
'9800507858',
'9800508401',
'9800508435',
'9800509326',
'9800510639',
'9800510795',
'9800517733',
'9800527419',
'9800519614',
'9800522279',
'9800523236',
'9800524820',
'9800526197',
'9800532096',
'9701171499',
'9800532369',
'9800533078',
'9701173552',
'9800534514',
'9800534662',
'9800535073',
'9800535222',
'9800535230',
'9800535891',
'9800540263',
'9800540321',
'9800540321',
'9800541147',
'9701178544',
'9800541899',
'9800541915',
'9800544778',
'9701181308',
'9800544893',
'9800545338',
'9701193139',
'9701190531',
'9701190077',
'9800550478',
'9800550817',
'9701225485',
'9800554926',
'9701202856',
'9800558125',
'9800558497',
'9800558497',
'9800559263',
'9800559263',
'9800559263',
'9800560386',
'9800560642',
'9800561269',
'9800562192',
'9800566037',
'9800563067',
'9800564214',
'9800564305',
'9701231772',
'9701235955',
'9800568843',
'9800570997',
'9800571946',
'9701229719',
'9800573199',
'9800576028',
'9800576028',
'9800576028',
'9701237308',
'9701238835',
'9800578834',
'9800578834',
'9800579261',
'9800579980',
'9800579980',
'9800580962',
'9800580962',
'9800581895',
'9800581895',
'9800582042',
'9800582521',
'9800582521',
'9800582521',
'9800582992',
'9800585706',
'9800585706',
'9800588403',
'9800588825',
'9800592827',
'9800593288',
'9800593486',
'9800596687',
'9701274046',
'9701308950',
'9800605215',
'9701290208',
'9800614282',
'9800616048',
'9701291511',
'9800617517',
'9800618937',
'9800619000',
'9800620925',
'9701310006',
'9800624679',
'9800624695',
'9800635311',
'9800635923',
'9800636020',
'9800640253',
'9800640634',
'9800641319',
'9800641863')




update rc
set status_cd = 'T',UPDATE_DT = GETDATE(),UPDATE_USER_TX = ' INC0434969',rc.LOCK_ID = rc.LOCK_ID % 255 + 1
from REQUIRED_COVERAGE rc
join UniTracHDStorage..INC0476239 on cr.id = rc.id


INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , L.ID , 'INC0476239' , 'N' , 
 GETDATE() ,  1 , 
'Move Loans to Tracking', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.RequiredCoverage' , L.ID , 'PEND' , 'N'
FROM REQUIRED_COVERAGE L 
WHERE L.ID IN (SELECT ID FROM UniTracHDStorage..INC0476239)


---Test Plan 

select rc.* from REQUIRED_COVERAGE rc
join UniTracHDStorage..INC0476239




---Backout plan




update rc
set status_cd = cr.status_cd,UPDATE_DT = GETDATE(),UPDATE_USER_TX = ' INC0434969',rc.LOCK_ID = rc.LOCK_ID % 255 + 1
from REQUIRED_COVERAGE rc
join UniTracHDStorage..INC0476239 on cr.id = rc.id



delete pc
--select * 
from PROPERTY_CHANGE pc
where pc.ENTITY_NAME_TX = 'Allied.UniTrac.RequiredCoverage'
and USER_TX = 'INC0434969'
and ENTITY_ID IN (SELECT ID FROM UniTracHDStorage..INC0434969)