-------------- Check Work Items Before Update (To Verify Work Item Definition and Status)
-------------- Work Item ID Number(s) should be provided on HDT
----REPLACE XXXXXXX WITH THE THE WI ID


SELECT CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, *
FROM    UniTrac..WORK_ITEM
WHERE   ID IN ( 30541917 , 30542112  )

SELECT  * FROM dbo.WORK_ITEM_ACTION
WHERE WORK_ITEM_ID IN ( XXXXXXX )


--Finding WI via CODE_TX
----REPLACE #### WITH THE THE Lender ID
SELECT CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, *
--INTO UniTracHDStorage..INC0228433
FROM    UniTrac..WORK_ITEM
WHERE    CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') = '2261' 
AND STATUS_CD NOT IN ('Complete' ,'Withdrawn' ,'ImportCompleted')
AND WORKFLOW_DEFINITION_ID = '2'


SELECT * FROM dbo.WORKFLOW_DEFINITION



SELECT *
FROM WORK_ITEM
WHERE WORKFLOW_DEFINITION_ID IN (3,6,8)  AND RELATE_TYPE_CD = 'Allied.UniTrac.RequiredCoverage' AND RELATE_ID IN (SELECT REQUIRED_COVERAGE.ID
FROM LOAN
INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
INNER JOIN REQUIRED_COVERAGE ON PROPERTY.ID = REQUIRED_COVERAGE.PROPERTY_ID
INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
WHERE LENDER.CODE_TX = 'XXXX'
AND WORK_ITEM.STATUS_CD NOT LIKE 'Complete' AND WORK_ITEM.STATUS_CD NOT LIKE 'Withdrawn' )
ORDER BY WORK_ITEM.STATUS_CD ASC 


SELECT *
FROM WORK_ITEM
WHERE WORKFLOW_DEFINITION_ID = 8 AND RELATE_TYPE_CD = 'Allied.UniTrac.RequiredCoverage' AND RELATE_ID IN (SELECT REQUIRED_COVERAGE.ID
FROM LOAN
INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
INNER JOIN REQUIRED_COVERAGE ON PROPERTY.ID = REQUIRED_COVERAGE.PROPERTY_ID
INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
WHERE LENDER.CODE_TX = 'XXXX')


SELECT  RELATE_ID
INTO #tmp
FROM    WORK_ITEM
WHERE   RELATE_TYPE_CD = 'Allied.UniTrac.UTLMatchResult'
        AND RELATE_ID IN (
        SELECT  UTL_MATCH_RESULT.ID
        FROM    LOAN
                INNER JOIN COLLATERAL ON LOAN.ID = COLLATERAL.LOAN_ID-- AND COLLATERAL.PURGE_DT IS NULL
                INNER JOIN PROPERTY ON COLLATERAL.PROPERTY_ID = PROPERTY.ID
                INNER JOIN dbo.UTL_MATCH_RESULT ON PROPERTY.ID = UTL_MATCH_RESULT.PROPERTY_ID
                INNER JOIN LENDER ON LOAN.LENDER_ID = LENDER.ID
        WHERE   LENDER.CODE_TX = '2261'
                AND WORK_ITEM.STATUS_CD NOT LIKE 'Complete'
                AND WORK_ITEM.STATUS_CD NOT LIKE 'Withdrawn' ) 


				SELECT LOAN_ID
				INTO #tmpD
				FROM dbo.UTL_MATCH_RESULT
				WHERE ID IN (SELECT * FROM #tmp)

				SELECT * FROM dbo.LOAN
				WHERE ID IN (SELECT * FROM #tmpD)


UPDATE dbo.WORK_ITEM
SET STATUS_CD = 'Withdrawn', LOCK_ID = LOCK_ID+1, UPDATE_DT = GETDATE(), UPDATE_USER_TX = 'INC0228433'
--SELECT * FROM dbo.WORK_ITEM
WHERE ID IN (SELECT ID FROM UniTracHDStorage..INC0228433)
