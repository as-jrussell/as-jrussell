USE [UniTrac]
GO 

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT  L.ID[Loan_ID], L.NUMBER_TX [Loan Number],  RC.*
INTO #tmp
FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
INNER JOIN dbo.INTERACTION_HISTORY IH ON IH.PROPERTY_ID = P.ID
WHERE LL.CODE_TX IN ('1595') 



SELECT INSURANCE_SUB_STATUS_CD, INSURANCE_STATUS_CD, * FROM #tmp RC
WHERE RC.UPDATE_DT < '2015-11-07' AND RC.UPDATE_DT > '2015-11-06'


SELECT * FROM dbo.REF_CODE
WHERE CODE_CD IN ('D', 'F') AND DOMAIN_CD IN ( 'RequiredCoverageInsStatus', 'RequiredCoverageInsSubStatus')



SELECT DISTINCT  Loan_ID, [Loan Number], PROPERTY_ID, INSURANCE_SUB_STATUS_CD, INSURANCE_STATUS_CD, L.RECORD_TYPE_CD, RC.CREATE_DT
INTO #tmpA
FROM #tmp RC
INNER JOIN dbo.LOAN L ON L.ID = RC.Loan_ID 
WHERE --INSURANCE_SUB_STATUS_CD = 'D' AND  INSURANCE_STATUS_CD = 'F' AND PROPERTY_ID = '66698851'
RC.CREATE_DT < '2015-11-05' AND RC.CREATE_DT > '2015-05-05'

AND   CAST(UPDATE_DT AS DATE) > CAST(GETDATE()-120 AS DATE) 
ORDER BY UPDATE_DT ASC
--718228

SELECT COUNT(*) FROM #tmp
--964045


SELECT * FROM dbo.INTERACTION_HISTORY
WHERE PROPERTY_ID IN (66698851)
--AND TYPE_CD = 'MEMO'
ORDER BY PROPERTY_ID ASC


SELECT RC1. DESCRIPTION_TX [NSURANCE_SUB_STATUS_CD] , RC2.DESCRIPTION_TX [INSURANCE_STATUS_CD], T.* FROM #tmpB T
INNER JOIN dbo.REF_CODE RC1 ON RC1.CODE_CD = T.INSURANCE_SUB_STATUS_CD AND RC1.DOMAIN_CD = 'RequiredCoverageInsSubStatus' 
INNER JOIN dbo.REF_CODE RC2 ON RC2.CODE_CD = T.INSURANCE_STATUS_CD AND RC2.DOMAIN_CD = 'RequiredCoverageInsStatus' 
WHERE T.RECORD_TYPE_CD = 'G'
ORDER BY T.CREATE_DT ASC



SELECT RC1. DESCRIPTION_TX [NSURANCE_SUB_STATUS_CD] , RC2.DESCRIPTION_TX [INSURANCE_STATUS_CD], T.* FROM #tmpA T
INNER JOIN dbo.REF_CODE RC1 ON RC1.CODE_CD = T.INSURANCE_SUB_STATUS_CD AND RC1.DOMAIN_CD = 'RequiredCoverageInsSubStatus' 
INNER JOIN dbo.REF_CODE RC2 ON RC2.CODE_CD = T.INSURANCE_STATUS_CD AND RC2.DOMAIN_CD = 'RequiredCoverageInsStatus' 
WHERE T.RECORD_TYPE_CD = 'G'
ORDER BY T.CREATE_DT ASC



SELECT TOP 1 * FROM dbo.COLLATERAL



SELECT * FROM dbo.REF_CODE

WHERE DOMAIN_CD = 'RecordType'
CODE_CD IN ('G', 'B')


SELECT DISTINCT  PROPERTY_ID
INTO #tmpC
FROM #tmp RC
INNER JOIN dbo.LOAN L ON L.ID = RC.Loan_ID 
WHERE --INSURANCE_SUB_STATUS_CD = 'D' AND  INSURANCE_STATUS_CD = 'F' AND PROPERTY_ID = '66698851'
RC.CREATE_DT < '2015-09-25' AND RC.CREATE_DT > '2015-03-25'




SELECT DISTINCT  PROPERTY_ID
INTO #tmpD
FROM #tmp RC
INNER JOIN dbo.LOAN L ON L.ID = RC.Loan_ID 
WHERE --INSURANCE_SUB_STATUS_CD = 'D' AND  INSURANCE_STATUS_CD = 'F' AND PROPERTY_ID = '66698851'
RC.CREATE_DT > '2015-09-25' --AND RC.CREATE_DT > '2015-05-05'


SELECT TOP 10 L.ID, L.CREATE_DT [Loan Start Date], IH.*, N.* FROM #tmpC T
INNER JOIN dbo.INTERACTION_HISTORY IH ON T.PROPERTY_ID = IH.PROPERTY_ID
INNER JOIN dbo.COLLATERAL C ON C.PROPERTY_ID = T.PROPERTY_ID
INNER JOIN dbo.LOAN L ON L.ID = C.LOAN_ID
INNER JOIN dbo.NOTICE N ON N.ID = IH.RELATE_ID AND RELATE_CLASS_TX = 'Allied.UniTrac.Notice'
WHERE IH.TYPE_CD = 'NOTICE' AND IH.SPECIAL_HANDLING_XML.value('(SH/Sequence) [1]', 'varchar (50)') = '1'
aND IH.SPECIAL_HANDLING_XML.value('(SH/Type) [1]', 'varchar (50)') = 'N'
ORDER BY IH.PROPERTY_ID

SELECT  L.CREATE_DT [Loan Start Date], IH.* FROM #tmpD T
INNER JOIN dbo.INTERACTION_HISTORY IH ON T.PROPERTY_ID = IH.PROPERTY_ID
INNER JOIN dbo.COLLATERAL C ON C.PROPERTY_ID = T.PROPERTY_ID
INNER JOIN dbo.LOAN L ON L.ID = C.LOAN_ID
WHERE IH.TYPE_CD = 'NOTICE' AND IH.SPECIAL_HANDLING_XML.value('(SH/Sequence) [1]', 'varchar (50)') = '1'
ORDER BY IH.PROPERTY_ID


SELECT * FROM dbo.PROPERTY_CHANGE PC
INNER JOIN dbo.PROPERTY_CHANGE_UPDATE PCU ON PC.ENTITY_ID = PCU.TABLE_ID
WHERE ENTITY_ID = '112142185' AND pcu.COLUMN_NM LIKE '%notice%'


SELECT * FROM dbo.INTERACTION_HISTORY IH
WHERE IH.PROPERTY_ID = '111020613'
AND IH.TYPE_CD = 'NOTICE' AND IH.SPECIAL_HANDLING_XML.value('(SH/Sequence) [1]', 'varchar (50)') = '1'
aND IH.SPECIAL_HANDLING_XML.value('(SH/Type) [1]', 'varchar (50)') = 'N'


SELECT DISTINCT  NUMBER_TX
INTO #tmpE
FROM #tmp RC
INNER JOIN dbo.LOAN L ON L.ID = RC.Loan_ID 
WHERE --INSURANCE_SUB_STATUS_CD = 'D' AND  INSURANCE_STATUS_CD = 'F' AND PROPERTY_ID = '66698851'
RC.CREATE_DT < '2015-09-25' AND RC.CREATE_DT > '2015-03-25'




SELECT DISTINCT  NUMBER_TX
INTO #tmpF
FROM #tmp RC
INNER JOIN dbo.LOAN L ON L.ID = RC.Loan_ID 
WHERE --INSURANCE_SUB_STATUS_CD = 'D' AND  INSURANCE_STATUS_CD = 'F' AND PROPERTY_ID = '66698851'
RC.CREATE_DT > '2015-09-25' --AND RC.CREATE_DT > '2015-05-05'






SELECT LOAN_ID, NUMBER_TX,pl.ID, PRINT_STATUS_CD,PRINTED_DT, pli.RELATE_ID
INTO #tmpFF
FROM PROCESS_LOG pl
inner join process_log_item pli on pli.PROCESS_LOG_ID = pl.id and pli.relate_type_cd = 'allied.unitrac.notice'
inner join NOTICE N on N.id = pli.relate_id 
inner join LOAN L on L.ID = n.LOAN_ID
left outer join document_container dc on dc.relate_id = n.id and dc.relate_class_name_tx = 'allied.unitrac.notice' AND DC.PURGE_DT IS NULL	
where L.NUMBER_TX IN (SELECT * FROM #tmpF) AND PRINT_STATUS_CD <> 'EXCLUDE'

SELECT NUMBER_TX, RELATE_ID, OB.EXTERNAL_ID, OB.UPDATE_DT  --,OUTPUT_BATCH_LOG.*
from OUTPUT_BATCH OB
INNER JOIN OUTPUT_BATCH_LOG OBL ON OB.ID = OBL.OUTPUT_BATCH_ID
INNER JOIN #tmpFF EE ON EE.ID = OB.PROCESS_LOG_ID
WHERE OB.PROCESS_LOG_ID IN (SELECT ID FROM #tmpFF) AND LOG_TXN_TYPE_CD = 'SENT' 
AND OB.EXTERNAL_ID LIKE 'NTC%' AND RELATE_ID = '12656150'

