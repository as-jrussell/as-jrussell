USE [UniTrac];
GO

--Loan Notice Cycle Reset
SELECT --NOTICE_DT, NOTICE_SEQ_NO,
rc.*
INTO UniTracHDStorage..INC0386195
FROM   LOAN L
       INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
       INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
       INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
       INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE  LL.CODE_TX IN ( '3210' )
       AND L.NUMBER_TX IN ('300074218-500',
'900016087-505',
'900014128-501',
'900012956-500',
'300016163-505',
'300079210-505',
'300052045-500',
'900018496-500',
'900018084-500',
'900017834-505',
'300085687-512',
'300055998-500',
'900016706-505',
'900021524-505',
'900016971-501',
'900018307-506',
'900004522-511',
'900016729-511',
'900000930-505',
'900016094-500',
'300052428-501',
'900014830-501',
'900016058-505',
'900003301-500',
'300081070-500',
'304003502-500',
'900016609-500',
'900017459-505',
'900013343-505',
'900005364-505',
'300042566-500',
'300056165-500',
'300081008-500',
'900017350-500',
'300057591-506',
'900017065-500',
'900001988-511',
'900012686-500',
'900003910-505',
'900014523-500',
'900013644-500',
'900015790-500',
'900014084-511',
'300050221-500',
'900024422-511',
'900017920-501',
'900006513-505',
'900006667-500',
'300069387-506',
'900018174-500',
'900011808-505',
'900018777-500',
'300074055-505',
'900008784-505',
'900014490-500',
'900012923-505',
'900017325-505',
'900014995-505',
'900019751-500',
'300070834-505',
'900010489-500',
'900008586-505',
'300086575-505',
'300039860-525',
'900013104-505',
'300082514-505',
'900018810-500',
'900012257-500',
'900016368-500',
'300086006-500',
'900021691-505',
'900006366-505',
'900015258-500',
'900009485-505',
'900005111-506',
'300065379-505',
'300074552-500',
'120084-500',
'900013268-505',
'900012830-500',
'900012785-501',
'300076538-506',
'900010207-500',
'300081008-505',
'300078844-507',
'900004897-500',
'900013021-505',
'900021419-500',
'300006442-501',
'900015293-500',
'900011512-505',
'300086909-505',
'900005728-500',
'900019633-505',
'900016544-500',
'900009030-505',
'900014874-500',
'900016516-500',
'900018866-511',
'900002660-507',
'900017516-501',
'300074055-500',
'300085695-500',
'900017082-500',
'900012765-500',
'900016035-500',
'900016786-500',
'900024216-511',
'900024771-511',
'900024794-500',
'900018765-511',
'100312-511',
'900019210-511',
'900009201-511',
'900024729-511',
'107529-511',
'300042021-511',
'900024890-511',
'900024850-511',
'300081161-511',
'300076387-511',
'900003622-511',
'900024751-511',
'900024688-511',
'300014105-511',
'900024889-511',
'900007678-525',
'300080429-511',
'900024882-511',
'900024265-511',
'900024755-511',
'VEHTEST',
'300004706-500',
'300071220-505',
'900009596-501',
'900000093-505',
'900021240-500',
'900013906-500',
'900017631-500',
'900012773-500',
'900004372-501',
'900017849-500',
'900010711-505',
'900006327-505',
'300046375-500')
     
UPDATE rc 
SET rc.NOTICE_DT =NULL, rc.NOTICE_SEQ_NO = '0'
--SELECT NOTICE_DT, NOTICE_SEQ_NO,* 
FROM dbo.REQUIRED_COVERAGE rc
WHERE ID IN (SELECT id FROM UniTracHDStorage..INC0386195)

INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , L.ID , 'INC0386195' , 'N' , 
 GETDATE() ,  1 , 
'Reset Notices to zero', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.RequiredCoverage' , L.ID , 'PEND' , 'N'
FROM REQUIRED_COVERAGE L 
WHERE L.ID IN (SELECT ID FROM UniTracHDStorage..INC0386195)




--SELECT * FROM LENDER WHERE CODE_TX = '6155'

--SELECT * FROM UniTracHDStorage..INC0222294_RC_ONLYNew

---- DROP TABLE #TMPLOAN
SELECT LOAN.NUMBER_TX , LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX , 
COLL.LOAN_ID , COLL.ID AS COLL_ID , COLL.PROPERTY_ID , COLL.PRIMARY_LOAN_IN , 
RC.ID AS RC_ID , RC.TYPE_CD , RC.SUMMARY_STATUS_CD , RC.SUMMARY_SUB_STATUS_CD , 
RC.INSURANCE_STATUS_CD , RC.INSURANCE_SUB_STATUS_CD , 
RC.BEGAN_NEW_IN , RC.CPI_QUOTE_ID , RC.NOTICE_DT , 
RC.NOTICE_SEQ_NO , RC.NOTICE_TYPE_CD , 
RC.LAST_EVENT_DT , RC.LAST_EVENT_SEQ_ID , RC.LAST_SEQ_CONTAINER_ID , 
RC.EXPOSURE_DT
INTO #TMPLOAN
 FROM LOAN
JOIN COLLATERAL COLL ON COLL.LOAN_ID = LOAN.ID
AND COLL.PURGE_DT IS NULL AND LOAN.PURGE_DT IS NULL
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = PR.ID
AND RC.PURGE_DT IS NULL
WHERE LOAN.NUMBER_TX IN ('93543-505',
'900008797-506',
'300070767-525',
'900015968-505',
'109333-505',
'300085782-506',
'900003452-505',
'900013144-505',
'900000452-505',
'300034286-505',
'300060850-500',
'300071555-506',
'300041121-500',
'900022399-505',
'900013738-505',
'900013057-500',
'900008700-508',
'900014745-500',
'900007622-505',
'900013559-505',
'127809-525',
'900004771-525',
'300045907-505',
'300005945-505',
'900012551-506',
'900012756-501',
'119602-505',
'300074155-505',
'300045284-505',
'300027648-511',
'900024149-511',
'900020227-505',
'900020966-505',
'300046432-505',
'900021939-505',
'900017508-500',
'300041184-505',
'300039655-505',
'900021780-505',
'900023418-511',
'8475-505',
'900017112-505',
'900013215-505',
'900002617-511',
'900003466-505',
'300045957-505',
'300082546-505',
'900018233-505',
'900003750-508',
'900018190-507',
'300086484-505',
'55659-505',
'900020525-506',
'300086685-505',
'900015394-505',
'300046188-511',
'300023384-511',
'300047541-505',
'300049535-506',
'125611-505',
'900003769-505',
'300075404-505',
'300085413-505',
'900009459-500')
----- 10701

SELECT   rc.*
into unitrachdstorage..INC0386195_Audit
FROM REQUIRED_COVERAGE RC JOIN #TMPLOAN TMP 
ON TMP.RC_ID = RC.ID 


select RC.SUMMARY_STATUS_CD , RC.INSURANCE_STATUS_CD , RC.BEGAN_NEW_IN , RC.EXPOSURE_DT , RC.TYPE_CD,* from unitrachdstorage..INC0386195_Audit rc

-- Update RequiredCoverage Status from Track to Active
UPDATE RC SET SUMMARY_STATUS_CD = 'A' ,
INSURANCE_STATUS_CD = 'A' , BEGAN_NEW_IN = 'N' , 
GOOD_THRU_DT = NULL , 
CPI_QUOTE_ID = NULL , NOTICE_DT = NULL , NOTICE_TYPE_CD = NULL , 
NOTICE_SEQ_NO = NULL , LAST_EVENT_SEQ_ID = NULL , LAST_EVENT_DT = NULL ,
LAST_SEQ_CONTAINER_ID = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'INC0386195' , 
LOCK_ID = RC.LOCK_ID % 255 + 1
---- SELECT RC.SUMMARY_STATUS_CD , RC.INSURANCE_STATUS_CD , RC.BEGAN_NEW_IN , RC.EXPOSURE_DT , RC.TYPE_CD ---,  *
FROM REQUIRED_COVERAGE RC JOIN #TMPLOAN TMP 
ON TMP.RC_ID = RC.ID 
---- 10701

--SELECT DISTINCT LOAN_ID FROM #TMPLOAN

-- Add Property change log
 INSERT INTO PROPERTY_CHANGE
 (
 ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN
 )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , TMP.RC_ID , 'INC0386195' , 'N' ,
 GETDATE(),  1 ,
 'Changed Summary Status from Audit' ,
 'N' , 'Y' , 1 ,  'Allied.UniTrac.RequiredCoverage' , TMP.RC_ID , 'PEND' , 'N'
 FROM #TMPLOAN TMP
 ---- 10682

