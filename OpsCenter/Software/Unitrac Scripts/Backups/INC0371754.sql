USE [UniTrac]
GO 

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE

--drop table #TMPPLCY_01
SELECT rc.id [RC_ID] into #TMPPLCY_01
FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE LL.CODE_TX = '2258' AND L.NUMBER_TX IN ('1660332L53',
'1636054L53','1309541L53.1','1657763L53','1518161L53','1437966L53','1407558L53.1','1474970L53','1808970L53',
'1629527L53.1','1660332L53','1790307L53','1757607L53','1761935L53.1','1630950L53','1636054L53','1606208L53',
'1660930L53','1309541L53.1','1407973L53.1','1717581L53','1472142L53','1657763L53','1421759L53','1738616L53',
'1825589L53.2','1432047L53.1','337800L53','1023500L53','1701820L53','1694191L53.1','1791488L53','1518161L53',
'1719402L53','1473307L53','1437966L53','1636844L59','1524599L53','1809208L53','1749206L53','1733110L53','1612146L53',
'1732578L53','1496182L53.1', '1743778L53','1430513L53','1604594L53','1757526L53','1713277L53','1812347L53','1432620L53',
'1407558L53.1','1752229L53','1678428L53.1','1809129L53','1314390L53','1061520L53.2','1532441L53','1743491L53','1513977L53',
'1524151L53','1765961L53','1490849L53','1749900L53','1644770L59','1303067L53','1449244L53.1','1525340L53','1765387L53',
'1532644L53','1688063L59','1688063L59','1475961L53.1','1415154L53.1','1659476L50','1786041L53','1477680L53','1497609L53',
'1808709L53','1474970L53','1662015L53','1728443L53','1528121L53','1313259L53','1809344L53','1704525L53','1304660L53',
'1808970L53','1429665L53','1453040L53.1','1738135L53','1753775L53','1790307L53','1636054L53','1606208L53','1612146L53',
'1713277L53') and rc.status_cd = 'T'



select * from ref_code
where DOMAIN_CD = 'RequiredCoverageStatus'



UPDATE RC SET GOOD_THRU_DT = NULL , 
Status_CD = 'A',
NOTICE_DT = NULL , 
NOTICE_SEQ_NO = NULL , 
NOTICE_TYPE_CD = NULL , 
LAST_EVENT_DT = NULL , 
LAST_EVENT_SEQ_ID = NULL , 
LAST_SEQ_CONTAINER_ID = NULL ,
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'TASK36687' , 
LOCK_ID = RC.LOCK_ID % 255 + 1
---- SELECT *
FROM REQUIRED_COVERAGE RC JOIN #TMPPLCY_01 T1 ON T1.RC_ID = RC.ID
----- 583


INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'INC0371754',
	'N',
	GETDATE(),
	1,
	'Changed Summary status to Active',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'PEND',
	'N'
FROM
	 #TMPPLCY_01
	 ----- 583


/*
---Finding Branch
SELECT LO.TYPE_CD, LO.CODE_TX , Lo.NAME_TX,*
FROM LENDER L
INNER JOIN LENDER_ORGANIZATION LO ON L.ID = LO.LENDER_ID
INNER JOIN RELATED_DATA RD ON LO.ID = RD.RELATE_ID --AND RD.DEF_ID = '105'
WHERE L.CODE_TX = '' AND Lo.TYPE_CD = 'DIV'



---Finding Collateral Code
SELECT  CC.ID ,
        CC.CODE_TX ,
        CC.DESCRIPTION_TX 
         FROM dbo.COLLATERAL_CODE CC
INNER JOIN dbo.LCCG_COLLATERAL_CODE_RELATE CCR ON CCR.COLLATERAL_CODE_ID = CC.ID
INNER JOIN dbo.LENDER_COLLATERAL_CODE_GROUP LCCG ON LCCG.ID = CCR.LCCG_ID
INNER JOIN dbo.LENDER L ON L.ID = LCCG.LENDER_ID
WHERE L.CODE_TX = 'XXXX'

*/