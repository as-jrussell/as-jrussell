USE [Unitrac_Reports]
GO

/****** Object:  StoredProcedure [dbo].[IsLenderSMPMonthly]    Script Date: 5/3/2017 4:50:49 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[IsLenderSMPMonthly]
(
	@billingGroupID	bigint
)
AS
BEGIN

SET NOCOUNT ON
	
--Get the RELATION DEF ID for the SMP indicator
DECLARE @SMPPayConfiREFID as int
SELECT @SMPPayConfiREFID = ID FROM RELATED_DATA_DEF WHERE NAME_TX = 'SMPPayConfigType' AND RELATE_CLASS_NM = 'LenderProduct'


SELECT CASE WHEN count(*) > 0  THEN 'Y' ELSE 'N' END
FROM BILLING_GROUP_LCGCT_RELATE BGR
JOIN LENDER_COLLATERAL_GROUP_COVERAGE_TYPE LCGCT ON BGR.LCGCT_ID = LCGCT.ID AND LCGCT.PURGE_DT IS NULL
JOIN MASTER_POLICY_LENDER_PRODUCT_RELATE MPLPR ON LCGCT.LENDER_PRODUCT_ID = MPLPR.LENDER_PRODUCT_ID AND MPLPR.PURGE_DT IS NULL
JOIN MASTER_POLICY MP ON MPLPR.MASTER_POLICY_ID = MP.ID and MP.PURGE_DT IS NULL
LEFT JOIN MASTER_POLICY_ASSIGNMENT MPA ON MP.ID = MPA.MASTER_POLICY_ID AND MPA.PURGE_DT IS NULL
LEFT JOIN ISSUE_PROCEDURE IP ON MPA.ISSUE_PROCEDURE_ID = IP.ID AND IP.PURGE_DT IS NULL
LEFT JOIN RELATED_DATA RD ON LCGCT.LENDER_PRODUCT_ID = rd.RELATE_ID and DEF_ID = @SMPPayConfiREFID
WHERE BGR.BILLING_GROUP_ID = @billingGroupID
and (RD.VALUE_TX = 'M' or IP.IS_MONTHLY_BILLING_IN = 'Y')

END


GO

