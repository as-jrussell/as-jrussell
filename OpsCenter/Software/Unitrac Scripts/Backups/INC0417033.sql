use unitrac

select * from lender
where id in (12)

drop table UnitracHDStorage..INC0417033_loan

select l.SPECIAL_HANDLING_XML, wi.* 
from loan l
join work_item wi on wi.relate_id = l.id and workflow_definition_id = 8
where wi.status_cd = 'Initial' and  l.lender_id =12 and l.number_tx in ('0015526040')

SELECT create_dt, Name_tx, CODE_TX from lender 
where code_tx in ('1299',
      '1003',
      '2704',
      '2708',
      '3515',
      '3522',
      '3680',
      '4414',
      '4423',
      '2333',
      '7374')
	  order by CREATE_DT ASC
select L.* 
into UnitracHDStorage..INC0417033_loan
from loan l
join work_item wi on wi.relate_id = l.id and workflow_definition_id = 8
where wi.status_cd = 'Initial' and  l.lender_id =12 and l.number_tx in ('0102077240',
'0009885041',
'0015526040',
'0022419041',
'0470059033',
'0106449341',
'0102953541',
'0102611340',
'0102610640',
'0100936840',
'0016965040',
'0469212270',
'0470799358',
'0469527504',
'0052588841',
'0052602141',
'0469060190',
'0059565241',
'0003727042',
'0469374202',
'0905266043',
'0005093040',
'0060999941',
'0006174841',
'0059735940',
'0006721041',
'0065430340',
'0064418640',
'0100706640',
'0019203040',
'0904154041',
'0105921840',
'0052498340',
'0052496243',
'0105930441',
'0100711342',
'0059346840',
'0903893041',
'0058551241',
'0052182741',
'0058177041',
'0053538541',
'0469900247',
'0104167840',
'0023934042',
'0103984940',
'0059210542',
'0906011042',
'0067459140',
'0054023140',
'0059415641',
'0902779040',
'0018759040',
'0053869441',
'0059746340',
'0052850440',
'0100293740',
'0101033941',
'0059055440',
'0052893840',
'0016272041',
'0103350941',
'0056851240',
'0103770041',
'8106845341',
'0064213340',
'0017202041',
'0065211740',
'0025813040',
'0470803274',
'0470350895',
'0466119700',
'0903614041',
'0061263041',
'0057365441',
'0468802915',
'0469086922',
'0050534840',
'0002476541',
'0468334322',
'0103371340',
'0060726340',
'0054275341',
'0465947079',
'0058296440',
'0054685940',
'0100494342',
'0058456742',
'0900877040',
'0055976441',
'0469724895',
'0050034340',
'0467690337',
'0904525042',
'0026642040',
'0051169340',
'0051185842',
'0469072608',
'0052786740',
'0015232040',
'0064046740',
'0100924341',
'0466238600',
'0022255040',
'0000238642',
'0104089540',
'0025181040',
'0467525401',
'0010880041',
'0064261840',
'0036212042',
'0103170440',
'8103842140',
'0104088241',
'0036982041',
'0014502042',
'0104414440',
'0053777841',
'0468287167',
'0042737041',
'0042896040',
'0043646040',
'0467040350',
'0049967940',
'0466247000',
'0105576440',
'0105586740',
'0103313341',
'0050173741',
'0050253840',
'0469433082',
'0470734304',
'0103325441',
'0015951040',
'0050433140',
'0039078041',
'0050492541',
'0021894041',
'0100742840',
'0050892340',
'0051037040',
'0103343440',
'0053334842',
'0469005922',
'8108061040',
'0053419941',
'0053424541',
'0054883342',
'0469473484',
'0469432141',
'0003164640',
'0061871841',
'0106649240',
'0902929042',
'0063790341',
'0102848142',
'0056326340',
'0468762797',
'0050327242',
'0101441740',
'0467807320',
'0105549840',
'0105561940',
'0103906840',
'0103163640',
'0470795596',
'0467001245',
'0100234740',
'0059115040',
'0102492340',
'0710318740',
'0105285340',
'0102096440',
'0021217040',
'0106723441',
'0102857440',
'0102236840',
'0065655240',
'0064253440',
'0468360020',
'0051862140',
'0101619140',
'0026868040',
'0468366391',
'0060599540',
'0468464830',
'0103089440',
'0050081941',
'0106471340',
'0904581041',
'0105456940',
'0051648140',
'0106248340',
'0054125340',
'0470166177',
'0470798219',
'0039622040',
'0049984340',
'0466080940',
'0055530740',
'0468108751',
'0051377040',
'0103817040',
'0467958149',
'8106497040',
'0466829375',
'0100718340',
'0466364710',
'0060715440',
'0102623540',
'0053627940',
'0066131640',
'0002470940',
'0021944040',
'0100458040',
'0100172540',
'0055132240',
'0104421840',
'0062902440',
'0003257840',
'0053131940',
'0102852440',
'0103344340',
'0066290140',
'0064534240',
'0102648441',
'0025715040',
'0057277440',
'0104325140',
'0055841440',
'0906369040',
'0054681940',
'0043506940',
'0105324340',
'0106008540',
'7513445040',
'0066424540',
'0901134040',
'0470669791',
'0035819040',
'0901138040',
'0000703640',
'0050419541',
'0467249209',
'0470068000',
'0057625241',
'0470756580',
'0050672140',
'0051767940',
'0023680040',
'0049982341',
'0468526656',
'0013036040',
'0064209440',
'0036280040',
'0023879040',
'0023075042',
'0051539640',
'0906118042',
'0055532143',
'0055532141',
'0002435741',
'0102261740',
'0051735840',
'0101025540',
'0066923240',
'0710252540',
'0052125640',
'0102632240',
'0059849240',
'0055178340',
'0057970440',
'0469132105',
'0013977040',
'0100564240',
'0002426940',
'0007395040',
'0100982640',
'0468391166',
'0064495140',
'0106934940',
'0710647040',
'0066873340',
'0052618940',
'0059292240',
'0760260240',
'0060955240',
'0002817740',
'0062238040',
'0102372141',
'0466937350',
'0469627362',
'0003202940',
'0470699566',
'0106921740',
'0470829759',
'0060817440',
'0052607340',
'0067658840',
'0103615440',
'0055687140',
'0470807466',
'0067043340',
'0058147740',
'8107442140',
'0050096540',
'0065110140',
'0468389632',
'0713323640',
'0058852040',
'0014660043',
'0067386640',
'0067970840',
'0106848940',
'0466212050',
'0057638240',
'0060313641',
'0102143740',
'0053589042',
'0058331040',
'0106451140',
'0065016340',
'0067345540',
'0107297040',
'0467129469',
'0716140340',
'0022768040',
'0469708948',
'0468052809',
'0053238742',
'0106992540',
'0469129582',
'0902510040',
'0059901540',
'0107351240',
'0468977354',
'0101082440',
'0102169940',
'0102558641',
'0469088473',
'0468488799',
'0052564140',
'0069063040',
'0466401840',
'0467740413',
'0107985140',
'0469048526',
'0068948040',
'0102609141',
'0065915640',
'0058544440',
'0103548840',
'0100326740',
'0055680342',
'0715023440',
'0760077440',
'0105310040',
'0056879740',
'0103174341',
'0469472478',
'0100731240',
'0055178341',
'0067297940',
'0717657940',
'0723072040',
'0002475140',
'0014801040',
'0064402240',
'0710158040',
'0064116940',
'0069688940',
'0106410140',
'0055101640',
'0065614140',
'0100550040',
'0468014578',
'0103557840',
'0710482940',
'0465963170',
'0103543140',
'0062343440',
'0101397440',
'0063189340',
'0070525040',
'0715229040',
'0055893540',
'0722018140',
'0061858340',
'0053830742',
'0052519041',
'0058236540',
'0065090140',
'0069087940',
'0009002041',
'0057789340',
'0055857842',
'0070804540',
'0052415340',
'0718389640',
'0055237240',
'0057886040',
'0064457440',
'0055555840',
'0107335840',
'0466826305',
'0050589240',
'0100689641',
'0062857040',
'0060228941',
'0067780840',
'0055872240',
'0052253340',
'0722947040',
'0063739541',
'0056903940',
'0070178340',
'0107909440',
'0720690140',
'0071445140',
'0712624940',
'0760338740',
'0050243240',
'0071563940',
'0061970040',
'0071833640',
'0105580240',
'0071805440',
'0103767441',
'0726253740',
'0067271040',
'0107512540',
'0050384740',
'0901280040',
'0055303040',
'0051722540',
'0065038241',
'0902049041',
'0071027540',
'0064976940',
'0056356141',
'0002730243',
'0026963041',
'0100964640',
'0072671840',
'0000730040',
'0002006240',
'0058434340',
'0060338641',
'0465690130',
'0465750030',
'0465783280',
'0465925500',
'0060270641',
'0465677020',
'0465969320',
'0465978220',
'0466012770',
'0466014780',
'0466081488',
'0466096320',
'0466162970',
'0466155340',
'0466160860',
'0466194200',
'0466238590',
'0466240300',
'0469806734',
'0469220009',
'0466263830',
'0466282020',
'0466278233',
'0466302120',
'0466286630',
'0466337900',
'0013404041',
'0466364720',
'0469992864',
'0466370590',
'0466347050',
'0466391840',
'0055660540',
'0466441750',
'0466500214',
'0466603373',
'0466711217',
'0466734277',
'0466781509',
'0466828179',
'0466839126',
'0466858259',
'0466861632',
'0466831023',
'0467064813',
'0467075927',
'0467091395',
'0467096866',
'0467173151',
'0467149897',
'0467229318',
'0467261005',
'0467278836',
'0467278878',
'0467322518',
'0467463776',
'0467595404',
'0467517713',
'0467517664',
'0467591204',
'0467613149',
'0467761807',
'0467765289',
'0467787506',
'0467749259',
'0467796804',
'0467860584',
'0467859959',
'0467868851',
'0467969469',
'0467868885',
'0467930931',
'0467928754',
'0467974286',
'0468110152',
'0468111407',
'0468069961',
'0468077807',
'0468206555',
'0468245991',
'0468197522',
'0468225836',
'0468290764',
'0468290780',
'0468276681',
'0468329323',
'0468322674',
'0468347797',
'0468255560',
'0468366367',
'0468374732',
'0468372009',
'0468393998',
'0468398609',
'0468429173',
'0468488814',
'0468498897',
'0468509735',
'0468603719',
'0470714306',
'0468653293',
'0468841913',
'0468841963',
'0468852647',
'0468853257',
'0468445046',
'0468534360',
'0468917475',
'0468946284',
'0468376811',
'0468955269',
'0468976380',
'0468994259',
'0468989804',
'0470858055',
'0469005914',
'0469049730',
'0469048518',
'0469045390',
'0469040308',
'0469051834',
'0469048534',
'0469075355',
'0469067112',
'0469075082',
'0469087160',
'0469086641',
'0469088001',
'0469089215',
'0469086980',
'0469086972',
'0469117529',
'0469119583',
'0469138806',
'0469136868',
'0469131967',
'0469165586',
'0469191424',
'0469188091',
'0469215373',
'0469217080',
'0469322251',
'0469338331',
'0469342845',
'0469351846',
'0469357349',
'0469365251',
'0469452222',
'0469434048',
'0469509172',
'0469534898',
'0469560009',
'0469569986',
'0468996627',
'0469725405',
'0469740594',
'0104420741',
'0469795531',
'0469798775',
'0469822045',
'0469830212',
'0469841102',
'0469841772',
'0469842572',
'0469844247',
'0469852208',
'0469855351',
'0469872206',
'0469889029',
'0469911997',
'0469911989',
'0469917953',
'0468179869',
'0469979870',
'0469993292',
'0470016538',
'0470016546',
'0470029135',
'0470048771',
'0470079065',
'0470108418',
'0470144636',
'0470164775',
'0470177794',
'0470214851',
'0470263006',
'0470275548',
'0470304917',
'0470334609',
'0470337348',
'0470343353',
'0470384555',
'0470386270',
'0470398506',
'0470406466',
'0470415904',
'0470420028',
'0470672215',
'0470681555',
'0470683981',
'0470692338',
'0470694110',
'0470711865',
'0470724438',
'0470727226',
'0470740129',
'0470739966',
'0470752421',
'0470766852',
'0470774102',
'0470171548',
'0470795223',
'0470802789',
'0470799697',
'0470805361',
'0470812225',
'0470827745',
'0470833487',
'0470844020',
'0470853279',
'0470853774',
'0470885610',
'0058845640',
'1111-50',
'771477090147')





SELECT L.STATUS_CD [Loan_Status], CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, WI.* INTO 
#tmp 
FROM    UniTrac..WORK_ITEM WI 
INNER JOIN dbo.LOAN L ON L.ID = WI.RELATE_ID AND WI.RELATE_TYPE_CD = 'Allied.UniTrac.Loan'
WHERE  WI.ID IN (53726195) AND WI.STATUS_CD NOT IN ( 'COMPLETE', 'Withdrawn' )

select * from #tmp

-------- Verify Data Work Item Clean Up for Cancelled Lender or update initial Select if only specific WI's being closed out.
----REPLACE XXXXXXX WITH THE THE WI ID
----REPLACE #### WITH THE THE Lender ID

drop table #TMPWI


SELECT 
        WI.ID AS WI_ID ,
        LOAN.ID AS LOAN_ID
		
INTO    #TMPWI
FROM    LOAN
        JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
        JOIN WORK_ITEM WI ON WI.RELATE_ID = LOAN.ID
WHERE   WI.WORKFLOW_DEFINITION_ID = 8
        AND WI.STATUS_CD NOT IN ( 'COMPLETE', 'Withdrawn' )
        AND WI.PURGE_DT IS NULL
        --AND WI.CREATE_DT < '2014-01-01 00:00:00.000'
		AND WI.ID IN (SELECT ID FROM #tmp)
		



UPDATE  LN
SET     SPECIAL_HANDLING_XML = NULL ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0417033' ,
        LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1
                       ELSE LOCK_ID + 1
                  END
--SELECT COUNT(*)
FROM    LOAN LN
        JOIN #TMPWI ON #TMPWI.LOAN_ID = LN.ID


UPDATE  WI
SET     STATUS_CD = 'Withdrawn' ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0417033' ,
        LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1
                       ELSE LOCK_ID + 1
                  END
--SELECT COUNT(*)
FROM    WORK_ITEM WI
        JOIN #TMPWI ON #TMPWI.WI_ID = WI.ID


SELECT STATUS_CD, UPDATE_DT, UPDATE_USER_TX, LOCK_ID FROM dbo.WORK_ITEM
WHERE ID IN (SELECT WI_ID FROM #TMPWI)



SELECT SPECIAL_HANDLING_XML, UPDATE_DT, UPDATE_USER_TX, LOCK_ID
FROM dbo.LOAN WHERE ID IN (SELECT LOAN_ID FROM #TMPWI)


