--SELECT * FROM LENDER WHERE CODE_TX = '1732'

---- DROP TABLE #TMPRC
SELECT T1.ID AS LOAN_ID ,  T1.NUMBER_TX , T1.BRANCH_CODE_TX , T1.DIVISION_CODE_TX , T1.RECORD_TYPE_CD , 
T1.STATUS_CD AS LN_STATUS_CD , T1.EXTRACT_UNMATCH_COUNT_NO AS LN_EXTRACT_UNMATCH_COUNT_NO , 
COLL.ID AS COLL_ID , COLL.COLLATERAL_CODE_ID , COLL.PROPERTY_ID , COLL.PRIMARY_LOAN_IN , 
COLL.STATUS_CD AS COLL_STATUS_CD , COLL.EXTRACT_UNMATCH_COUNT_NO AS COLL_EXTRACT_UNMATCH_COUNT_NO ,
PR.RECORD_TYPE_CD AS PR_RECORD_TYPE_CD , PR.ADDRESS_ID , 
OA.LINE_1_TX , OA.CITY_TX , OA.STATE_PROV_TX , OA.POSTAL_CODE_TX , 
RC.ID AS RC_ID , RC.TYPE_CD AS RC_TYPE_CD , RC.NOTICE_DT , RC.NOTICE_SEQ_NO , 
RC.NOTICE_TYPE_CD , RC.CPI_QUOTE_ID , RC.LAST_EVENT_DT , 
RC.LAST_EVENT_SEQ_ID , RC.LAST_SEQ_CONTAINER_ID , RC.RECORD_TYPE_CD AS RC_RECORD_TYPE_CD , 
CC.CODE_TX AS CC_CODE_TX , CC.DESCRIPTION_TX AS CC_DESCRIPTION_TX ,
0 AS EXCLUDE
INTO #TMPRC
FROM LOAN t1
JOIN COLLATERAL COLL ON COLL.LOAN_ID = T1.ID
AND COLL.PURGE_DT IS NULL AND T1.PURGE_DT IS NULL
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
LEFT JOIN OWNER_ADDRESS OA ON OA.ID = PR.ADDRESS_ID
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = PR.ID
AND RC.PURGE_DT IS NULL
JOIN COLLATERAL_CODE CC ON CC.ID = COLL.COLLATERAL_CODE_ID
WHERE T1.LENDER_ID = 331
AND T1.NUMBER_TX IN 
(
'0004511280-11',
'0004517759-11',
'0004535345-10',
'0004539305-11',
'0004548524-11',
'0004552602-10',
'0004556178-10',
'0004650779-10',
'0045009556-10',
'4555056 1729',
'4653212 1729'
)
ORDER BY T1.NUMBER_TX
----18

SELECT * 
INTO UnitracHDStorage.dbo.tmpTask36923_RC_0226
FROM #TMPRC
----18


UPDATE LN SET 
RECORD_TYPE_CD = CASE WHEN LN.RECORD_TYPE_CD IN ( 'D' , 'A') THEN 'G' ELSE LN.RECORD_TYPE_CD END ,
STATUS_CD = 'A',
EXTRACT_UNMATCH_COUNT_NO = 0  , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK36923', 
LOCK_ID = LN.LOCK_ID % 255 + 1
---- SELECT DISTINCT LN.ID , LN.LENDER_ID , LN.STATUS_CD , LN.EXTRACT_UNMATCH_COUNT_NO , LN.DIVISION_CODE_TX
FROM LOAN LN JOIN #TMPRC T1 ON T1.LOAN_ID = LN.ID
---- 9


UPDATE COLL SET 
STATUS_CD = 'A',
EXTRACT_UNMATCH_COUNT_NO = 0  , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK36923' , 
LOCK_ID = COLL.LOCK_ID % 255 + 1
---- SELECT DISTINCT COLL.ID , COLL.STATUS_CD , COLL.EXTRACT_UNMATCH_COUNT_NO ,  T1.*
FROM COLLATERAL COLL JOIN #TMPRC T1 ON T1.COLL_ID = COLL.ID
AND COLL.PURGE_DT IS NULL
---- 18


UPDATE PR SET 
RECORD_TYPE_CD = CASE WHEN PR.RECORD_TYPE_CD IN ( 'D' , 'A') THEN 'G' ELSE PR.RECORD_TYPE_CD END ,
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK36923', 
LOCK_ID = PR.LOCK_ID % 255 + 1
---- SELECT DISTINCT PR.ID , PR.RECORD_TYPE_CD
FROM PROPERTY PR JOIN #TMPRC T1 ON T1.PROPERTY_ID = PR.ID
WHERE PR.LENDER_ID = 331
----- 9

INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.Loan',
	LOAN_ID,
	'TASK36923',
	'N',
	GETDATE(),
	1,
	'Un-deleted Loan',
	'N',
	'Y',
	1,
	'Allied.UniTrac.Loan',
	LOAN_ID,
	'PEND',
	'N'
FROM #TMPRC
---- 9


INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.Loan',
	LOAN_ID,
	'TASK36923',
	'N',
	GETDATE(),
	1,
	'Changed Loan Status from Un-match to Active',
	'N',
	'Y',
	1,
	'Allied.UniTrac.Loan',
	LOAN_ID,
	'PEND',
	'N'
FROM #TMPRC
---- 9


INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.Property',
	PROPERTY_ID,
	'TASK36923',
	'N',
	GETDATE(),
	1,
	'Un-deleted Property',
	'N',
	'Y',
	1,
	'Allied.UniTrac.Property',
	PROPERTY_ID,
	'PEND',
	'N'
FROM #TMPRC
---- 9


INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.Collateral',
	COLL_ID,
	'TASK36923',
	'N',
	GETDATE(),
	1,
	'Changed Collateral Status from Un-match to Active',
	'N',
	'Y',
	1,
	'Allied.UniTrac.Collateral',
	COLL_ID,
	'PEND',
	'N'
FROM #TMPRC
---- 9