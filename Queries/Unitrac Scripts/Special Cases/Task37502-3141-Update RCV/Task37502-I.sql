IF OBJECT_ID(N'tempdb..#TMPRC_00',N'U') IS NOT NULL
       DROP TABLE #TMPRC_00 

---- DROP TABLE #TMPRC_00
SELECT LENDER.CODE_TX , LENDER.NAME_TX ,
LOAN.BRANCH_CODE_TX , LOAN.DIVISION_CODE_TX , LOAN.NUMBER_TX , 
LOAN.STATUS_CD AS LOAN_STATUS_CD, LOAN.EXTRACT_UNMATCH_COUNT_NO AS LOAN_EXTRACT_UNMATCH_COUNT_NO ,
COLL.STATUS_CD AS COLL_STATUS_CD , COLL.EXTRACT_UNMATCH_COUNT_NO AS COLL_EXTRACT_UNMATCH_COUNT_NO ,
OA.LINE_1_TX , OA.CITY_TX , OA.STATE_PROV_TX , OA.POSTAL_CODE_TX , 
CC.CODE_TX AS COLL_CODE_TX , CC.PRIMARY_CLASS_CD , CC.SECONDARY_CLASS_CD , 
RC.TYPE_CD , PR.REPLACEMENT_COST_VALUE_NO , PLCYCOV.AMOUNT_NO AS COVERAGE_AMOUNT_NO , 
CAST (0 AS DECIMAL(18,5)) AS NEW_COVERAGE_AMOUNT_NO ,
PLCY.* , PLCYCOV.START_DT , PLCYCOV.END_DT , PLCYCOV.ID AS PC_ID , PLCYCOV.SUB_TYPE_CD ,
LOAN.ID AS LOAN_ID , COLL.ID AS COLL_ID , RC.ID AS RC_ID , COLL.PRIMARY_LOAN_IN ,
RCCOV.MEANING_TX AS COVERAGE_STATUS ,  LTRIM(ISNULL(RC02.MEANING_TX,'') + ' ' + ISNULL(RC01.MEANING_TX,'')) AS SUMMARY_STATUS ,
0 AS EXCLUDE
INTO #TMPRC_00
FROM LOAN
JOIN COLLATERAL COLL ON COLL.LOAN_ID = LOAN.ID
AND LOAN.PURGE_DT IS NULL AND COLL.PURGE_DT IS NULL
AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN COLLATERAL_CODE CC ON CC.ID = COLL.COLLATERAL_CODE_ID
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = PR.ID
AND RC.PURGE_DT IS NULL
JOIN OWNER_ADDRESS OA ON OA.ID = PR.ADDRESS_ID
CROSS APPLY
(
SELECT * FROM dbo.GetCurrentCoverage(PR.ID , RC.ID , RC.TYPE_CD)
) AS PLCY
CROSS APPLY
(
SELECT TOP 1 PC.ID ,PC.START_DT , PC.END_DT , PC.AMOUNT_NO , PC.SUB_TYPE_CD
FROM POLICY_COVERAGE PC
WHERE PC.OWNER_POLICY_ID = PLCY.ID
AND PC.PURGE_DT IS NULL
AND PC.TYPE_CD = RC.TYPE_CD
ORDER BY PC.END_DT DESC
) AS PLCYCOV
JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
LEFT JOIN REF_CODE RCCOV ON RCCOV.CODE_CD = RC.STATUS_CD
AND RCCOV.DOMAIN_CD = 'RequiredCoverageStatus'
LEFT JOIN REF_CODE RC01 ON RC01.CODE_CD = RC.SUMMARY_STATUS_CD
		 AND RC01.DOMAIN_CD = 'RequiredCoverageInsStatus' 
		  LEFT JOIN REF_CODE RC02 ON RC02.CODE_CD = RC.SUMMARY_SUB_STATUS_CD
		 AND RC02.DOMAIN_CD = 'RequiredCoverageInsSubStatus' 
WHERE LENDER.CODE_TX = '3141'
AND LOAN.RECORD_TYPE_CD = 'G'
AND RC.RECORD_TYPE_CD = 'G'
AND PR.RECORD_TYPE_CD = 'G'
AND RC.TYPE_CD = 'HAZARD'
AND NUMBER_TX IN 
(
'100906132',	'101265779',	'100396078',	'101392004',	'101295570',	'101103095',	'101858733',	'100031481',	'5237700027',	'99882460',	'101203687',	'100625291',	'101863782',	'101887470',	'101854708',	'101399124',	'101228091',	'102024432',	'101388847',	'100877933',	'100949670',	'100685905',	'100146910',	'101238009',	'101386599',	'101377711',	'101376657',	'101810740',	'3132400001',	'101373816',	'100959709',	'101823227',	'99956071',	'100757802',	'101605638',	'100899494',	'100999152',	'100828382',	'101592934',	'101445508',	'100297175',	'101340180',	'101087962',	'102115424',	'101987110',	'101363107',	'100946204',	'101195326',	'101849393',	'101282598',	'101861023',	'101931702',	'100913064',	'101750239',	'102034404',	'101511841',	'101415024',	'101331638',	'101216016',	'6387400087',	'101842219',	'101349099',	'101859860',	'101489780',	'100967133',	'100359411',	'102003446',	'100707601',	'100748145',	'4476000080',	'101379368',	'101444967',	'2028700081',	'101225465',	'99913403',	'2350900002',	'102003222',	'101386012',	'99912572',	'100550254',	'101590387',	'101167323',	'101502241',	'100674806',	'3125700088',	'101191038',	'101040716',	'101899651',	'99877952',	'101371568',	'101901415',	'101948858',	'102106972',	'101166401',	'101338619',	'101525969',	'101144379',	'100911323',	'100778713',	'101886754',	'101371353',	'101111018',	'1788800089',	'101327417',	'101932615',	'100756355',	'101954091',	'102094565',	'101529613',	'101270018',	'100890642',	'101929950',	'101591535',	'101921860',	'101409500',	'101566935',	'100789858',	'101853710',	'102053898',	'100872938',	'101311126',	'101898748',	'100911136',	'101396020',	'102049341',	'102065640',	'101435590',	'100832790',	'100897735',	'100775217',	'100979024',	'101426815',	'100789401',	'100656549',	'101432263',	'101274418',	'101847353',	'100800409',	'101526199',	'101120476',	'100914904',	'100485981',	'101692133',	'4185000089',	'100617812',	'101158992',	'99866611',	'99861643',	'101164256',	'101686646',	'101448732',	'101405267',	'2285500080',	'101921262',	'100940686',	'101857585',	'1274100090',	'101059781',	'100916177',	'101147615',	'101405043',	'99930398',	'101819846',	'101818193',	'101653778',	'102026445',	'101227357',	'101674353',	'101186203',	'101386898',	'101859552',	'2212500089',	'100678000',	'3890100089',	'100675885',	'101414670',	'101532930',	'101357067',	'102064504',	'101724463',	'101819716',	'100410992',	'5624200082',	'101158808',	'101629830',	'100812439',	'101852740',	'101000082',	'101386067',	'102094631',	'101194525',	'101043137',	'99909871',	'102093166',	'101305219',	'5627300080',	'101972376',	'101247403',	'101249108',	'101466987',	'101819798',	'101478953',	'3302200080',	'2438000089',	'100673818',	'101807151',	'101737221',	'100691698',	'101552424',	'100731549',	'100672183',	'100966396',	'101957588',	'4209200080',	'100915095',	'101165075',	'101875749',	'101529668',	'101859020',	'101284453',	'100728295',	'100614811',	'101835275',	'2177500089',	'101292720',	'101618544',	'101933274',	'100925281',	'101592055',	'101948139',	'5151600085',	'101128276',	'101387279',	'101262264',	'5779400089',	'101283308',	'100634565',	'100297232',	'100875827',	'101519324',	'101562245',	'101453567',	'101256535',	'101528559',	'101422835',	'102097119',	'102031878',	'101447212',	'101263793',	'100848607',	'101032926',	'100943258',	'100053830',	'101047069',	'101742841',	'100354229',	'101983729',	'101382014',	'101437213',	'101432311',	'102065613',	'100959558',	'99880680',	'102064090',	'101876278',	'101403508',	'100065954',	'101505493',	'101326278',	'102049042',	'101237703',	'101230496',	'100805132',	'102020733',	'100637801',	'101529864',	'101400114',	'101198831',	'101885168',	'101961240',	'101239136',	'100726974',	'101508476',	'101403562',	'100136724',	'100931741',	'101933984',	'101525473',	'6188600089',	'100925021',	'100307412',	'101489865',	'101697316',	'101761589',	'101155601',	'101181561',	'101906746',	'101304696',	'99975447',	'101283429',	'101924076',	'101415088',	'100082139',	'101249685',	'101617239',	'101355036',	'101847737',	'101864800',	'99975504',	'100337231',	'100740671',	'102014198',	'101528607',	'101495709',	'101595533',	'101504320',	'101632335',	'101099590',	'101499136',	'101329822',	'6393000089',	'101200994',	'101367196',	'101109350',	'100818150',	'101443344',	'101223902',	'100954852',	'101857129',	'101687643',	'101949341',	'100907492',	'101959694',	'100910456',	'101959265',	'102003044',	'101272357',	'101368193',	'100945524',	'101319748',	'5055600089',	'101227197',	'101837952',	'101602208',	'101210443',	'101216052',	'101379238',	'101225287',	'101353881',	'100032871',	'101387288',	'2917700080',	'101505505',	'101234122',	'101056650',	'101549451',	'100943016',	'100920802',	'5114300080',	'102067523',	'101291415',	'101239640',	'101959582',	'100719332',	'101268211',	'102013922',	'100676163',	'101927198',	'101364971',	'101646604',	'3580500001',	'100564729',	'101737249',	'6006200090',	'101890005',	'101969518',	'100854345',	'101455226',	'101892504',	'101035888',	'100934582',	'100536735',	'102065686',	'102043358',	'100621994',	'101852469',	'101352642',	'101464787',	'101187723',	'101605861',	'101406068',	'100916056',	'99887821',	'101398127',	'101094483',	'100871070',	'101530075',	'101262116',	'101286121',	'102024209',	'101907529',	'101182504',	'102083943',	'101522593',	'101375052',	'100465910',	'101323295',	'100058620',	'3556000001',	'101194422',	'100946101',	'101918413',	'101420112',	'100930342',	'100877429',	'101763190',	'101506762',	'3406500082',	'100878417',	'102045455',	'101041731',	'4147300089',	'101473903',	'101183396',	'101885243',	'101405249',	'101513546',	'1882700082',	'99884026',	'101421557',	'101230236',	'102061183',	'101394080',	'101020473',	'101280213',	'100907371',	'101775942',	'102021981',	'102007846',	'101483005',	'100585519',	'100764369',	'101057479',	'101855406',	'101187433',	'101161929',	'101507983',	'100914669',	'100775459',	'101178637',	'100838822',	'101404288',	'101236760',	'102002579',	'101506726',	'101257635',	'100765254',	'101273037',	'100886980',	'100956025',	'101393999',	'101953058',	'101971847',	'101819529',	'101483135'
)
AND RC.SUMMARY_SUB_STATUS_CD = 'I'
ORDER BY BRANCH_CODE_TX , DIVISION_CODE_TX , LOAN.NUMBER_TX
---- 416

IF OBJECT_ID(N'tempdb..#TMPRC',N'U') IS NOT NULL
       DROP TABLE #TMPRC 

---- DROP TABLE #TMPRC
SELECT PLCY.* , OP.SPECIAL_HANDLING_XML
INTO #TMPRC
FROM #TMPRC_00 PLCY JOIN OWNER_POLICY OP ON OP.ID = PLCY.ID 
--WHERE PRIMARY_LOAN_IN = 'Y'
---- 416

UPDATE #TMPRC SET EXCLUDE = 0

--- EXCEPTIONS
UPDATE #TMPRC SET EXCLUDE = -1 WHERE PRIMARY_LOAN_IN = 'N'
AND EXCLUDE = 0 
----0

UPDATE #TMPRC SET EXCLUDE = 1 WHERE SUB_TYPE_CD <> 'CADW' AND EXCLUDE = 0 
--- 0


---- EXCESS
UPDATE #TMPRC SET EXCLUDE = 3 WHERE EXCESS_IN = 'Y' AND EXCLUDE = 0 
----- 0


--- IV. COVERAGE AMOUNT = 0
UPDATE #TMPRC SET EXCLUDE = 4 WHERE EXCLUDE = 0 AND ISNULL(COVERAGE_AMOUNT_NO, 0 ) = 0
--- 21

UPDATE #TMPRC SET EXCLUDE = 4 WHERE EXCLUDE = 0
AND PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMPRC WHERE EXCLUDE = 4
)
----0


UPDATE #TMPRC SET EXCLUDE = 5 WHERE EXCLUDE = 0
AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'N' AND SPECIAL_HANDLING_XML IS NULL
---0


UPDATE #TMPRC SET EXCLUDE = 5 WHERE EXCLUDE = 0
AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'N' AND ISNULL(SPECIAL_HANDLING_XML.value('(/SH/Units)[1]' , 'int'),0) IN (0, 1)
---- 5

UPDATE #TMPRC SET EXCLUDE = 5 WHERE PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMPRC WHERE EXCLUDE = 5
)
AND EXCLUDE = 0
----3

/*
SELECT * FROM #TMPRC WHERE EXCLUDE = 5
ORDER BY PROPERTY_ID
*/

UPDATE #TMPRC SET NEW_COVERAGE_AMOUNT_NO = 0
---416

IF OBJECT_ID(N'tempdb..#TMPRC_01',N'U') IS NOT NULL
       DROP TABLE #TMPRC_01 

--- DROP TABLE #TMPRC_01
SELECT DISTINCT  PROPERTY_ID , SECONDARY_CLASS_CD , 
NEW_COVERAGE_AMOUNT_NO , COVERAGE_AMOUNT_NO , UNIT_OWNERS_IN ,
ISNULL(SPECIAL_HANDLING_XML.value('(/SH/Units)[1]' , 'int'),0) AS UNITS_NO ,
ID AS OWNER_POLICY_ID , PC_ID
INTO #TMPRC_01
FROM #TMPRC WHERE EXCLUDE = 0 
---387

IF OBJECT_ID(N'tempdb..#TMP_PROP_MULTI',N'U') IS NOT NULL
       DROP TABLE #TMP_PROP_MULTI 

---- DROP TABLE #TMP_PROP_MULTI
SELECT PROPERTY_ID , COUNT(*) AS CNT
INTO #TMP_PROP_MULTI
 FROM #TMPRC_01
GROUP BY PROPERTY_ID
HAVING COUNT(*) > 1
----0

IF OBJECT_ID(N'tempdb..#TMPRC_02',N'U') IS NOT NULL
       DROP TABLE #TMPRC_02 

--- DROP TABLE #TMPRC_02
SELECT * , 0 AS EXCLUDE
INTO #TMPRC_02
FROM #TMPRC_01 WHERE PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMP_PROP_MULTI
)
ORDER BY PROPERTY_ID
---0

---- WHAT TO DO WITH THESE - UPDATE LATER
UPDATE #TMPRC SET EXCLUDE = 6 WHERE PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMP_PROP_MULTI
)
AND EXCLUDE = 0
---- 0


UPDATE #TMPRC SET NEW_COVERAGE_AMOUNT_NO = COVERAGE_AMOUNT_NO
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD NOT IN ('COND' , 'COCOND')
---- 379


UPDATE #TMPRC SET NEW_COVERAGE_AMOUNT_NO = COVERAGE_AMOUNT_NO
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'Y'
---- 8


UPDATE #TMPRC SET NEW_COVERAGE_AMOUNT_NO = ROUND(COVERAGE_AMOUNT_NO / SPECIAL_HANDLING_XML.value('(/SH/Units)[1]' , 'int'), 2)
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'N' 
AND ISNULL(SPECIAL_HANDLING_XML.value('(/SH/Units)[1]' , 'int'),0) > 1
----- 0

-------- CASE II 
UPDATE #TMPRC_02 SET EXCLUDE = 0 
---0


UPDATE T1 SET EXCLUDE = 1
FROM #TMPRC_02 T1
JOIN #TMPRC_02 T2 ON T1.PROPERTY_ID = T2.PROPERTY_ID
WHERE T1.SECONDARY_CLASS_CD NOT IN ('COND' , 'COCOND')
AND T1.OWNER_POLICY_ID <> T2.OWNER_POLICY_ID
AND T1.COVERAGE_AMOUNT_NO <> T2.COVERAGE_AMOUNT_NO 
----0


UPDATE #TMPRC_02 SET EXCLUDE = 1 WHERE PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMPRC_02 WHERE EXCLUDE = 1
)
AND EXCLUDE = 0 
----0

---- DROP TABLE #TMPRC_05
SELECT * 
INTO #TMPRC_05
FROM #TMPRC_02 WHERE EXCLUDE = 0
AND SECONDARY_CLASS_CD NOT IN ('COND' , 'COCOND')
ORDER BY PROPERTY_ID
----0


UPDATE T1 SET EXCLUDE = 2
FROM #TMPRC_02 T1
JOIN #TMPRC_02 T2 ON T1.PROPERTY_ID = T2.PROPERTY_ID
WHERE T1.SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND T1.OWNER_POLICY_ID <> T2.OWNER_POLICY_ID
AND T1.EXCLUDE = 0
AND T2.EXCLUDE = 0
AND T1.UNIT_OWNERS_IN = 'Y'
AND T2.UNIT_OWNERS_IN = 'Y'
AND T1.COVERAGE_AMOUNT_NO <> T2.COVERAGE_AMOUNT_NO 
----0


UPDATE T1 SET EXCLUDE = 2
--- SELECT T1.COVERAGE_AMOUNT_NO  , T2.COVERAGE_AMOUNT_NO , T1.UNITS_NO
FROM #TMPRC_02 T1
JOIN #TMPRC_02 T2 ON T1.PROPERTY_ID = T2.PROPERTY_ID
WHERE T1.SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND T1.OWNER_POLICY_ID <> T2.OWNER_POLICY_ID
AND T1.EXCLUDE = 0
AND T2.EXCLUDE = 0
AND T1.UNIT_OWNERS_IN = 'N'
AND T2.UNIT_OWNERS_IN = 'Y'
AND T1.COVERAGE_AMOUNT_NO <> T2.COVERAGE_AMOUNT_NO * T1.UNITS_NO
---0

UPDATE #TMPRC_02 SET EXCLUDE = 2 WHERE PROPERTY_ID IN 
(
SELECT PROPERTY_ID FROM #TMPRC_02 WHERE EXCLUDE = 2
)
AND EXCLUDE = 0 
----0

INSERT INTO #TMPRC_05
SELECT * 
FROM #TMPRC_02 WHERE EXCLUDE = 0
AND SECONDARY_CLASS_CD  IN ('COND' , 'COCOND')
ORDER BY PROPERTY_ID
----0


UPDATE #TMPRC_05 SET NEW_COVERAGE_AMOUNT_NO = COVERAGE_AMOUNT_NO
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD NOT IN ('COND' , 'COCOND')
---- 0

UPDATE #TMPRC_05 SET NEW_COVERAGE_AMOUNT_NO = COVERAGE_AMOUNT_NO
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'Y'
---- 0


UPDATE #TMPRC_05 SET NEW_COVERAGE_AMOUNT_NO = COVERAGE_AMOUNT_NO / UNITS_NO
WHERE EXCLUDE = 0 AND SECONDARY_CLASS_CD IN ('COND' , 'COCOND')
AND UNIT_OWNERS_IN = 'N' 
AND UNITS_NO > 1
----- 0


UPDATE #TMPRC SET NEW_COVERAGE_AMOUNT_NO = TMP.NEW_COVERAGE_AMOUNT_NO
--- SELECT *
FROM #TMPRC JOIN #TMPRC_05 TMP ON 
TMP.PROPERTY_ID = #TMPRC.PROPERTY_ID
WHERE #TMPRC.EXCLUDE = 6
---- 0

SELECT TMP.* , PR.REPLACEMENT_COST_VALUE_NO AS ORIG_REPLACEMENT_COST_VALUE_NO
INTO UnitracHDStorage.dbo.tmpTask37502_PLCY
---- SELECT COUNT(*)
FROM PROPERTY PR JOIN #TMPRC TMP ON 
TMP.PROPERTY_ID = PR.ID
----416

/*
SELECT TMP.* , PR.REPLACEMENT_COST_VALUE_NO AS ORIG_REPLACEMENT_COST_VALUE_NO
INTO UnitracHDStorage.dbo.tmpTask37502_PLCY
---- SELECT COUNT(*)
FROM PROPERTY PR JOIN #TMPRC TMP ON 
TMP.PROPERTY_ID = PR.ID WHERE EXCLUDE = 0
AND TMP.NEW_COVERAGE_AMOUNT_NO > 0
---- 

--SELECT COUNT(*) FROM UnitracHDStorage.dbo.tmpTASK37502_1245_1114

SELECT * FROM #TMPRC WHERE EXCLUDE = 0 
ORDER BY NUMBER_TX
----387

SELECT * FROM #TMPRC WHERE EXCLUDE <> 0 
ORDER BY NUMBER_TX

*/

----------------UPDATES
UPDATE PR SET REPLACEMENT_COST_VALUE_NO = TMP.NEW_COVERAGE_AMOUNT_NO , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK37502' , 
LOCK_ID = CASE WHEN PR.LOCK_ID >= 255 THEN 1 ELSE PR.LOCK_ID + 1 END
----- SELECT NUMBER_TX ,   TMP.NEW_COVERAGE_AMOUNT_NO , PR.REPLACEMENT_COST_VALUE_NO
FROM PROPERTY PR JOIN #TMPRC TMP ON 
TMP.PROPERTY_ID = PR.ID WHERE EXCLUDE = 0
AND TMP.NEW_COVERAGE_AMOUNT_NO > 0
---- 387


 INSERT INTO PROPERTY_CHANGE
 (
 ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN
 )
 SELECT DISTINCT  'Allied.UniTrac.Property' , TMP.PROPERTY_ID , 'TASK37502' , 'N' , 
 GETDATE() ,  1 , 
 'Changed RCV from ' + convert(varchar(20), ISNULL(REPLACEMENT_COST_VALUE_NO,0))  + ' to ' + 
 convert(varchar(20), CAST(NEW_COVERAGE_AMOUNT_NO AS DECIMAL(18,2))) , 
 'N' , 'Y' , 1 ,  'Allied.UniTrac.Property' , TMP.PROPERTY_ID , 'PEND' , 'N'
 FROM #TMPRC TMP WHERE EXCLUDE = 0 AND NEW_COVERAGE_AMOUNT_NO > 0
 ---- 387
 

-----update these also - #TMPRC_05
UPDATE PR SET REPLACEMENT_COST_VALUE_NO = TMP.NEW_COVERAGE_AMOUNT_NO , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK37502' , 
LOCK_ID = CASE WHEN PR.LOCK_ID >= 255 THEN 1 ELSE PR.LOCK_ID + 1 END
----- SELECT COUNT(*)
FROM PROPERTY PR JOIN #TMPRC_05 TMP ON 
TMP.PROPERTY_ID = PR.ID WHERE EXCLUDE = 0
AND TMP.NEW_COVERAGE_AMOUNT_NO > 0
---- 0


 INSERT INTO PROPERTY_CHANGE
 (
 ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN
 )
 SELECT DISTINCT  'Allied.UniTrac.Property' , TMP.PROPERTY_ID , 'TASK37502' , 'N' , 
 GETDATE() ,  1 , 
 'Changed RCV from 0.00 to ' + 
 convert(varchar(20), CAST(NEW_COVERAGE_AMOUNT_NO AS DECIMAL(18,2))) , 
 'N' , 'Y' , 1 ,  'Allied.UniTrac.Property' , TMP.PROPERTY_ID , 'PEND' , 'N'
 FROM #TMPRC_05 TMP WHERE EXCLUDE = 0
 AND TMP.NEW_COVERAGE_AMOUNT_NO > 0
 ---- 0

UPDATE RC SET GOOD_THRU_DT = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK37502' ,
LOCK_ID = CASE WHEN RC.LOCK_ID >= 255 THEN 1 ELSE RC.LOCK_ID + 1 END
---- SELECT COUNT(*)
FROM REQUIRED_COVERAGE RC JOIN #TMPRC TMP ON 
TMP.PROPERTY_ID = RC.PROPERTY_ID WHERE EXCLUDE = 0
---- 774


UPDATE RC SET GOOD_THRU_DT = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'TASK37502' ,
LOCK_ID = CASE WHEN RC.LOCK_ID >= 255 THEN 1 ELSE RC.LOCK_ID + 1 END
---- SELECT COUNT(*)
FROM REQUIRED_COVERAGE RC JOIN #TMPRC_05 TMP ON 
TMP.PROPERTY_ID = RC.PROPERTY_ID WHERE EXCLUDE = 0
---- 0