--- REPLACE 'mm/dd/yy'
SELECT LENDER.AGENCY_ID ,  LENDER.CODE_TX , LENDER.NAME_TX , LENDER.CANCEL_DT , 
LOAN.LENDER_ID , LOAN.ID AS LOAN_ID , LOAN.NUMBER_TX , 
WI.ID AS WI_ID , WI.CREATE_DT , WI.STATUS_CD ,
WI.CURRENT_QUEUE_ID , WI.CURRENT_OWNER_ID 
INTO #TMPVD
--- SELECT COUNT(*)
FROM LOAN JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
JOIN WORK_ITEM WI ON WI.RELATE_ID = LOAN.ID
AND WI.RELATE_TYPE_CD = 'Allied.UniTrac.Loan'
AND WI.STATUS_CD NOT IN ('Complete', 'Withdrawn')
WHERE WI.WORKFLOW_DEFINITION_ID = 8
AND WI.PURGE_DT IS NULL
AND LENDER.PURGE_DT IS NULL
--AND LENDER.TEST_IN = 'N'
AND LENDER.CANCEL_DT IS NULL
AND WI.CREATE_DT < 'MM/DD/YY'
ORDER BY LENDER.CODE_TX , WI.CREATE_DT


SELECT VD.* , RC.ID AS RC_ID
INTO #TMPRC
FROM #TMPVD VD
JOIN COLLATERAL COLL ON COLL.LOAN_ID = VD.LOAN_ID
AND COLL.PURGE_DT IS NULL
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = COLL.PROPERTY_ID
AND RC.PURGE_DT IS NULL
AND RC.RECORD_TYPE_CD = 'G'
AND PR.RECORD_TYPE_CD = 'G'


UPDATE WI SET STATUS_CD = 'Withdrawn' , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'BUGXXXXX' , 
LOCK_ID = WI.LOCK_ID % 255 + 1
---- SELECT COUNT(*)
FROM WORK_ITEM WI JOIN #TMPVD TMP ON 
TMP.WI_ID = WI.ID
AND WI.PURGE_DT IS NULL


INSERT INTO WORK_ITEM_ACTION (WORK_ITEM_ID, ACTION_CD, FROM_STATUS_CD, TO_STATUS_CD, CURRENT_QUEUE_ID, 
CURRENT_OWNER_ID, ACTION_NOTE_TX, ACTIVE_IN, CREATE_DT, UPDATE_DT, UPDATE_USER_TX, LOCK_ID, ACTION_USER_ID)
SELECT DISTINCT WI_ID , 'Withdraw' , STATUS_CD , 'Withdrawn' , CURRENT_QUEUE_ID , 
CURRENT_OWNER_ID , 'BUGXXXXX' , 'Y' , GETDATE() , GETDATE() , 'BUGXXXXX' , 1 , 1
FROM #TMPVD



UPDATE LN SET SPECIAL_HANDLING_XML = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX  = 'BUGXXXXX' , 
LOCK_ID = LN.LOCK_ID % 255 + 1
--- SELECT COUNT(*)
FROM LOAN LN JOIN #TMPVD ON #TMPVD.LOAN_ID = LN.ID


---- CLEAR GOOD THRU
UPDATE RC SET GOOD_THRU_DT = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'BUGXXXXX' ,
LOCK_ID = RC.LOCK_ID % 255 + 1
--- SELECT COUNT(*)
FROM REQUIRED_COVERAGE RC JOIN #TMPRC ON 
#TMPRC.RC_ID = RC.ID



