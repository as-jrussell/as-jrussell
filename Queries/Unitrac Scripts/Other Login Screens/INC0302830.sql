USE [UniTrac]
GO 

--FPC
SELECT CA.* 
FROM LOAN L
INNER JOIN dbo.FORCE_PLACED_CERTIFICATE FPC ON FPC.LOAN_ID = L.ID
INNER JOIN dbo.CPI_QUOTE CQ ON CQ.ID = FPC.CPI_QUOTE_ID 
INNER JOIN dbo.CPI_ACTIVITY CA ON CA.CPI_QUOTE_ID = CQ.ID
JOIN dbo.LENDER ll ON ll.ID = L.LENDER_ID
WHERE L.NUMBER_TX IN ('63800-20')



--FPC
SELECT CA.* 
FROM LOAN L
INNER JOIN dbo.FORCE_PLACED_CERTIFICATE FPC ON FPC.LOAN_ID = L.ID
INNER JOIN dbo.CPI_QUOTE CQ ON CQ.ID = FPC.CPI_QUOTE_ID 
INNER JOIN dbo.CPI_ACTIVITY CA ON CA.CPI_QUOTE_ID = CQ.ID
JOIN dbo.LENDER ll ON ll.ID = L.LENDER_ID
WHERE L.NUMBER_TX IN ('0000029679L1')


--FPC
SELECT DISTINCT L.NUMBER_TX , FPC.ID [FPC_ID],
       RC.DESCRIPTION_TX ,
       CA.PROCESS_DT ,
       CA.TOTAL_PREMIUM_NO ,
       CA.START_DT ,
       CA.END_DT ,
       CA.REASON_CD ,
       CA.EXECUTION_STEPS_TX ,
       CA.COMMENT_TX ,
       CA.EARNED_PAYMENT_AMOUNT_NO ,
       CA.SUB_REASON_CD
INTO #tmpFPC
FROM   LOAN L
       INNER JOIN dbo.FORCE_PLACED_CERTIFICATE FPC ON FPC.LOAN_ID = L.ID
       INNER JOIN dbo.CPI_QUOTE CQ ON CQ.ID = FPC.CPI_QUOTE_ID
       INNER JOIN dbo.CPI_ACTIVITY CA ON CA.CPI_QUOTE_ID = CQ.ID
       INNER JOIN dbo.REF_CODE RC ON RC.CODE_CD = CA.TYPE_CD
                                     AND RC.DOMAIN_CD = 'CPIActivityType'
       JOIN dbo.LENDER ll ON ll.ID = L.LENDER_ID
WHERE  CA.TYPE_CD = 'C'
       AND CA.TYPE_CD != 'CP';


SELECT * FROM dbo.REF_CODE
WHERE CODE_CD = 'cp'



   SELECT DISTINCT oc.id INTO  #tmpRC FROM dbo.FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE FPCR 
   JOIN #tmpFPC FPC ON FPC.FPC_ID = FPCR.FPC_ID
   INNER JOIN dbo.REQUIRED_COVERAGE OC ON OC.ID = FPCR.REQUIRED_COVERAGE_ID

   SELECT DISTINCT T.ID [RC_ID], WI.id[WorkItem_ID], WI.RELATE_ID
   INTO #tmpFL
    FROM #tmpRC T
   LEFT JOIN dbo.WORK_ITEM WI ON T.ID = WI.RELATE_ID AND WI.WORKFLOW_DEFINITION_ID =3
   WHERE WI.ID IS NULL 

   --4,766,187

   SELECT * FROM #tmpFL


--FPC
SELECT L.NUMBER_TX [Loan Number] ,
       FPC.NUMBER_TX [Cert Number] ,
       ll.CODE_TX [Lender Code] ,
       ll.NAME_TX [Lender Name] ,
       CA.PROCESS_DT [Process Date] ,
       CA.TOTAL_PREMIUM_NO [Premium] ,
       CA.START_DT [Start Date] ,
       CA.END_DT [End Date] ,
       CA.REASON_CD [Reason] ,
       CA.PAYMENT_EFFECTIVE_DT [Payment Effective Date] ,
       CA.EARNED_PAYMENT_AMOUNT_NO [Earned Payment Amount] ,
       CA.SUB_REASON_CD [Sub Reason]
INTO   JCs..INC0302830F
FROM   LOAN L
       INNER JOIN dbo.FORCE_PLACED_CERTIFICATE FPC ON FPC.LOAN_ID = L.ID
       INNER JOIN dbo.CPI_QUOTE CQ ON CQ.ID = FPC.CPI_QUOTE_ID
       INNER JOIN dbo.CPI_ACTIVITY CA ON CA.CPI_QUOTE_ID = CQ.ID
       JOIN dbo.LENDER ll ON ll.ID = L.LENDER_ID
       JOIN dbo.FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE FPCR ON FPCR.FPC_ID = FPC.ID
       JOIN dbo.REQUIRED_COVERAGE RC ON RC.ID = FPCR.REQUIRED_COVERAGE_ID
WHERE  RC.ID IN (   SELECT RC_ID
                    FROM   #tmpFL
                )
       AND CA.TYPE_CD = 'C'
       AND ll.PURGE_DT IS NULL
       AND ll.TEST_IN = 'N'
       AND FPC.PURGE_DT IS NULL
       AND CQ.PURGE_DT IS NULL
       AND CA.PURGE_DT IS NULL
       AND RC.PURGE_DT IS NULL
       AND FPC.PURGE_DT IS NULL;


	--   DROP TABLE JCs..INC0302830



	SELECT COUNT(*) FROM JCs..INC0302830F
 