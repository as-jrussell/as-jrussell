USE [UniTrac]
GO

DECLARE @processDate datetime
DECLARE @ProcessLogID NVARCHAR(255)

SET @ProcessLogID  = 

/* Run this query and then place start_dt into the processDate field
--SELECT * FROM dbo.PROCESS_LOG WHERE ID =  */

SET @processDate = ''

	
	IF OBJECT_ID(N'tempdb..#tmpPrint',N'U') IS NOT NULL
       DROP TABLE #tmpPrint   
       
	Create Table #tmpPrint
	(	
	  DOCUMENT_CONTAINER_ID BIGINT
    )
    
    INSERT INTO #tmpPrint
    (
       DOCUMENT_CONTAINER_ID
    )
    SELECT DC.ID
    FROM EVALUATION_EVENT EE 
	    JOIN DOCUMENT_CONTAINER DC ON DC.RELATE_CLASS_NAME_TX = EE.RELATE_TYPE_CD   AND DC.RELATE_ID = EE.RELATE_ID
	JOIN dbo.PROCESS_LOG_ITEM PLI ON PLI.EVALUATION_EVENT_ID = EE.ID 
	WHERE PLI.PROCESS_LOG_ID IN (@ProcessLogID)

    AND EE.TYPE_CD = 'PRNT'
    AND DC.PURGE_DT IS NULL
    AND EE.STATUS_CD = 'COMP'  
    AND DATEDIFF ( DAY , DC.CREATE_DT , @processDate ) = 0   

    UPDATE EE SET STATUS_CD = 'PEND' , EE.LOCK_ID = (EE.LOCK_ID % 255) + 1 , 
    EE.UPDATE_USER_TX = 'CYCBACKOFF' , EE.UPDATE_DT = GETDATE()
    --SELECT * 
  FROM EVALUATION_EVENT EE 
	JOIN dbo.PROCESS_LOG_ITEM PLI ON PLI.EVALUATION_EVENT_ID = EE.ID 
	WHERE PLI.PROCESS_LOG_ID IN (@ProcessLogID)
    
    UPDATE DC SET PURGE_DT = GETDATE() , LOCK_ID = (LOCK_ID % 255) + 1 ,
    UPDATE_USER_TX = 'CYCBACKOFF' , UPDATE_DT = GETDATE()
    --SELECT *
	FROM DOCUMENT_CONTAINER DC JOIN #tmpPrint TMP ON 
    TMP.DOCUMENT_CONTAINER_ID = DC.ID
    WHERE DC.PURGE_DT IS NULL




