USE [UniTrac]
GO 

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT DISTINCT  L.NUMBER_TX ,
        RC.ESCROW_IN ,
        RC2.DESCRIPTION_TX [Loan Record Type] ,
        RC3.DESCRIPTION_TX [Loan Status] ,
        RC4.DESCRIPTION_TX [Loan Type] ,
        L.BRANCH_CODE_TX [Branch Code] ,
        RC.ID [RC_ID] ,
        L.ID [LoanID]
INTO UniTracHDStorage..INC0231872_RC
FROM    LOAN L
        INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
        INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
        INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
        INNER JOIN dbo.REF_CODE RC2 ON RC2.CODE_CD = L.RECORD_TYPE_CD
                                       AND RC2.DOMAIN_CD = 'RecordType'
        INNER JOIN dbo.REF_CODE RC3 ON RC3.CODE_CD = L.STATUS_CD
                                       AND RC3.DOMAIN_CD = 'LoanStatus'
        INNER JOIN dbo.REF_CODE RC4 ON RC4.CODE_CD = L.TYPE_CD
                                       AND RC4.DOMAIN_CD = 'LoanType'
WHERE   L.LENDER_ID = '12'
        AND L.BRANCH_CODE_TX = 'ESCROW' AND RC.ESCROW_IN = 'Y'



AND L.RECORD_TYPE_CD = 'G'



UPDATE dbo.REQUIRED_COVERAGE
SET ESCROW_IN = 'N', UPDATE_DT = GETDATE(), UPDATE_USER_TX = 'INC0231872', LOCK_ID = LOCK_ID+1
--SELECT ESCROW_IN, LOCK_ID [RC], * FROM dbo.REQUIRED_COVERAGE
WHERE ID IN (SELECT [RC_ID] FROM UniTracHDStorage..INC0231872_RC)




 INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.RequiredCoverage' , RC.ID , 'INC0231872' , 'N' , 
 GETDATE() ,  1 , 
 'Removed Escrow Flag', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.RequiredCoverage' , RC.ID , 'PEND' , 'N'
FROM REQUIRED_COVERAGE RC 
WHERE RC.ID IN (SELECT RC_ID FROM UniTracHDStorage..INC0231872_RC)



SELECT ESCROW_IN, * FROM UniTracHDStorage..INC0228540_RC


SELECT *
INTO  UniTracHDStorage..INC0231872_RE
  FROM UniTracHDStorage..INC0228540_RE

SELECT * 
INTO UniTracHDStorage..INC0228540_RE
FROM dbo.REQUIRED_ESCROW
WHERE REQUIRED_COVERAGE_ID IN (SELECT RC_ID FROM UniTracHDStorage..INC0231872_RC)



UPDATE dbo.REQUIRED_ESCROW
SET PURGE_DT = GETDATE()-2, UPDATE_DT = GETDATE()-2, UPDATE_USER_TX = 'INC0231872', LOCK_ID = LOCK_ID+1
--SELECT * FROM dbo.REQUIRED_ESCROW
WHERE ID IN (SELECT ID FROM  UniTracHDStorage..INC0231872_RE) AND SUB_STATUS_CD = 'POD'