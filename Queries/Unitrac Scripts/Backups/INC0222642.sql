USE [UniTrac]
GO 

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT  P.*
FROM    LOAN L
        INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
        INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
        INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
        INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
        INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
        INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
        INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
        --INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
        --INNER JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
        --INNER JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
        --INNER JOIN dbo.INTERACTION_HISTORY IH ON IH.PROPERTY_ID = P.ID
        --                 --                        AND IH.RELATE_CLASS_TX = 'Allied.UniTrac.Notice'
        --INNER JOIN dbo.NOTICE_REQUIRED_COVERAGE_RELATE NC ON NC.REQUIRED_COVERAGE_ID = RC.ID
        --INNER JOIN dbo.NOTICE N ON N.ID = NC.NOTICE_ID
WHERE   LL.CODE_TX = '2032'
        AND L.NUMBER_TX IN ('888692620')


SELECT *
FROM dbo.PROPERTY_CHANGE PC
INNER JOIN dbo.PROPERTY_CHANGE_UPDATE PCU ON pc.ENTITY_ID = pcu.TABLE_ID
INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE PCR ON PCR.PROPERTY_ID = PC.ENTITY_ID
INNER JOIN dbo.PROPERTY P ON P.ID = PCR.PROPERTY_ID
INNER JOIN dbo.LENDER L ON L.ID = P.LENDER_ID
WHERE PC.ENTITY_NAME_TX = 'Allied.UniTrac.Property' --AND PC.ENTITY_ID = '116092126'
AND PCU.TABLE_NAME_TX = 'PROPERTY' AND L.CODE_TX = '2032'

--DROP TABLE #tmp

SELECT * FROM #tmp

SELECT DISTINCT PC.ENTITY_ID --, PC.ENTITY_NAME_TX, PCU.TABLE_NAME_TX, PCU.COLUMN_NM, PC.CREATE_DT
INTO #tmpP
FROM dbo.PROPERTY_CHANGE PC
INNER JOIN dbo.PROPERTY_CHANGE_UPDATE PCU ON pc.ENTITY_ID = pcu.TABLE_ID
INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE PCR ON PCR.PROPERTY_ID = PC.ENTITY_ID
INNER JOIN dbo.PROPERTY P ON P.ID = PCR.PROPERTY_ID
INNER JOIN dbo.LENDER L ON L.ID = P.LENDER_ID
WHERE PC.ENTITY_ID IN (SELECT * FROM #tmp) AND 
PC.ENTITY_NAME_TX = 'Allied.UniTrac.Property'
AND PCU.TABLE_NAME_TX = 'PROPERTY' AND COLUMN_NM LIKE 'Verify Property Address.%'
 AND CAST(PC.CREATE_DT AS DATE) >= CAST(GETDATE()-380 AS DATE) AND  L.CODE_TX = '2032'

--23384945


SELECT L.* FROM dbo.PROPERTY P
INNER JOIN dbo.COLLATERAL C ON C.PROPERTY_ID = P.ID
INNER JOIN dbo.LOAN L ON L.ID = C.LOAN_ID
WHERE P.ID IN (SELECT * FROM #tmpP)

