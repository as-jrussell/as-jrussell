USE [UniTrac];
GO



--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT CC.CODE_TX, CC.DESCRIPTION_TX, RC.TYPE_CD, C. *
--INTO UniTracHDStorage..INC0328478_C
FROM   LOAN L
       INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
       INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
	   JOIN dbo.COLLATERAL_CODE CC ON CC.id = C.COLLATERAL_CODE_ID
	   JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = C.PROPERTY_ID
WHERE  LL.CODE_TX IN ( '3193' ) 
       AND L.NUMBER_TX IN ( '1071927',	 '1072156', '1072289', '1073170' ,
                            '1074988' ,'1072156', '1072289', '1072446' ,
                            '1072867' ,'1073162', '1073170', '1073212' ,
                            '1074210' ,'580432497'
                          );


--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT CC.CODE_TX, CC.DESCRIPTION_TX,  RC. *
--INTO UniTracHDStorage..INC0328478_RC
FROM   LOAN L
       INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
       INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
	   JOIN dbo.COLLATERAL_CODE CC ON CC.id = C.COLLATERAL_CODE_ID
	   JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = C.PROPERTY_ID
WHERE  LL.CODE_TX IN ( '3193' ) 
       AND L.NUMBER_TX IN (  '1072156', '1072289', '1073170' ,
                            '1074988' ,'1072156', '1072289', '1072446' ,
                            '1072867' ,'1073162', '1073170', '1073212' ,
                            '1074210' ,'580432497'
                          );

						  '1071927')
	   ,	

--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT  C.ID INTO #TMP
--INTO UniTracHDStorage..INC0328478_C
FROM   LOAN L
       INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
       INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
	   JOIN dbo.COLLATERAL_CODE CC ON CC.id = C.COLLATERAL_CODE_ID
	   JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = C.PROPERTY_ID
WHERE  LL.CODE_TX IN ( '3193' )   AND L.NUMBER_TX IN (  '1072156', '1072289', '1073170' ,
                            '1074988' ,'1072156', '1072289', '1072446' ,
                            '1072867' ,'1073162', '1073170', '1073212' ,
                            '1074210' ,'580432497'
                          ) AND RC.TYPE_CD IN ('EQUIPMENT','PHYS-DAMAGE','LIFE')

SELECT * FROM dbo.COLLATERAL
WHERE PROPERTY_ID = 51154920

UPDATE C
SET C.PURGE_DT = GETDATE(), C.UPDATE_DT = GETDATE(), C.UPDATE_USER_TX = 'INC0328478', C.PRIMARY_LOAN_IN = 'N', LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1 ELSE LOCK_ID + 1 END
--SELECT * 
FROM dbo.COLLATERAL C 
WHERE ID IN (SELECT * FROM #TMP)


INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.Collateral' , L.ID , 'INC0328478' , 'N' , 
 GETDATE() ,  1 , 
'Purged Collateral', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.Collateral' , L.ID , 'PEND' , 'N'
FROM dbo.COLLATERAL L 
WHERE L.ID IN (SELECT ID FROM UniTracHDStorage..INC0328478_C)



SELECT L.* FROM dbo.LOAN L
JOIN dbo.COLLATERAL C ON C.LOAN_ID = L.ID
JOIN UniTracHDStorage..INC0328478_C D ON D.LOAN_ID = L.id AND C.PRIMARY_LOAN_IN = 'Y'
