---------- Validate Work Item before making update
----REPLACE XXXXXXX WITH THE WI ID
----REPLACE INCXXXXXXX WITH TICKET NUMBER
SELECT * 
INTO UniTracHDStorage..INC0305837
FROM UniTrac..WORK_ITEM
WHERE LENDER_ID = 1026 AND WORKFLOW_DEFINITION_ID = 7
AND STATUS_CD = 'Initial'

SELECT * FROM dbo.WORK_ITEM
WHERE  WORKFLOW_DEFINITION_ID = 7
AND UPDATE_DT >= '2017-06-27' AND STATUS_CD NOT IN ('Complete', 'Initial')

--------- Insert New Row in Work Item Action (for History Tracking)
----REPLACE XXXXXXX WITH THE THE WI ID
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40011592	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40011597	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40027440	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40028827	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40029448	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40029517	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40030848	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40031103	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40031569	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40031786	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40040847	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )
INSERT INTO dbo.WORK_ITEM_ACTION  	(WORK_ITEM_ID ,ACTION_CD,FROM_STATUS_CD,TO_STATUS_CD,CURRENT_QUEUE_ID,CURRENT_OWNER_ID,ACTION_NOTE_TX,ACTIVE_IN,CREATE_DT,PURGE_DT,UPDATE_DT,UPDATE_USER_TX,LOCK_ID,ACTION_USER_ID )	VALUES	(	40053388	, N'Complete' , N'Initial' , N'Complete' , 5 , 738 ,  N'Manual Close Request HDT' , 'Y' ,  GETDATE() , NULL ,  GETDATE() , N'INC0305837' , 1 , 1 )


----Use Last WIA ID that was created for LAST_WORK_ITEM_ACTION_ID column 
UPDATE  WI
SET     WI.STATUS_CD = 'Complete', 
WI.LAST_WORK_ITEM_ACTION_ID = (SELECT MAX(ID) FROM dbo.WORK_ITEM_ACTION WHERE   WORK_ITEM_ID IN ( (SELECT ID FROM UniTracHDStorage..INC0305837) )),
WI.UPDATE_DT = GETDATE(),LOCK_ID = WI.LOCK_ID+1, UPDATE_USER_TX = 'INC0305837'
--SELECT WI.* 
FROM dbo.WORK_ITEM WI 
JOIN dbo.WORK_ITEM_ACTION WIA ON WIA.WORK_ITEM_ID = WI.ID
WHERE   WI.ID IN (SELECT ID FROM UniTracHDStorage..INC0305837) AND WIA.WORK_ITEM_ID = WI.ID
        AND WORKFLOW_DEFINITION_ID = 7
        AND WI.ACTIVE_IN = 'Y'

SELECT * FROM dbo.WORK_ITEM_ACTION
WHERE ID = 83146036

---Verification

SELECT * 
FROM UniTrac..WORK_ITEM
WHERE ID IN (SELECT ID FROM UniTracHDStorage..INCXXXXXXX)


UPDATE WI
SET WI.LAST_WORK_ITEM_ACTION_ID = WIA.ID
--SELECT WI.LAST_WORK_ITEM_ACTION_ID, WIA.ID, * 
FROM dbo.WORK_ITEM WI
JOIN dbo.WORK_ITEM_ACTION WIA ON WIA.WORK_ITEM_ID = WI.ID
WHERE WORK_ITEM_ID IN (SELECT ID FROM UniTracHDStorage..INC0305837)
AND ACTION_CD = 'Complete'