/* Task 39618 & 39769
 Update for Lender 4220 & 1939
 */

UPDATE utlldr SET utlldr.PURGE_DT = GETDATE(), utlldr.UPDATE_DT = GETDATE(),
 utlldr.UPDATE_USER_TX =
( Case when l.LENDER_ID = 8
THEN 'Bug39769'
WHEN l.LENDER_ID = 80
THEN 'Bug39618'
END )
,utlldr.LOCK_ID = (utlldr.LOCK_ID % 255) + 1 

 FROM UNITRAC_TO_LATEST_LENDER_DATA_RELATE utlldr
 INNER JOIN COLLATERAL c ON c.ID = utlldr.UNITRAC_RELATE_CLASS_ID AND c.PURGE_DT IS NULL AND utlldr.UNITRAC_RELATE_CLASS_NAME_TX = 'Allied.UniTrac.Collateral'
 INNER JOIN LOAN l ON l.ID = c.LOAN_ID AND l.PURGE_DT IS NULL  AND l.Record_Type_CD IN ('G','A','D')
 WHERE l.LENDER_ID in (80,8) -- Lender 4220 & 1939
 and utlldr.PURGE_DT IS NULL
 and utlldr.LENDER_DATA_RELATE_CLASS_ID NOT IN 
 (SELECT cetd.ID FROM COLLATERAL_EXTRACT_TRANSACTION_DETAIL cetd)
 and utlldr.UNITRAC_RELATE_CLASS_ID in (142558494,143840656)


