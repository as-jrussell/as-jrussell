-------------- Check Work Items Before Update (To Verify Work Item Definition and Status)
-------------- Work Item ID Number(s) should be provided on HDT
----REPLACE XXXXX WITH THE THE WI ID


SELECT CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, * INTO UniTracHDStorage..WI_INC0237598
FROM    UniTrac..WORK_ITEM
WHERE   ID IN ( '31682304',
'22396612',
'24096427',
'27527671',
'22396585',
'23987432',
'27021169',
'26175924',
'22396586',
'26694375',
'23987503',
'22396580',
'22396590',
'31648635',
'29439043',
'25492613',
'26900994',
'25798376',
'25556809',
'25424165',
'4365222',
'24104355',
'26175977',
'26175946',
'24303422',
'31594770',
'24758884',
'26900996',
'24374555',
'25798122',
'22817467',
'24151953',
'23987495',
'24758778',
'26900346',
'23528296',
'27850512',
'26900341',
'30274707',
'26175956',
'24211936',
'26175923',
'22396574',
'26175983',
'26175948',
'28019430',
'23987499',
'22396594',
'25692508',
'23528518',
'25798120',
'26900345',
'22503792',
'23510234',
'22396591',
'26900413',
'23440753',
'31648497',
'27469595',
'24104250',
'26175954',
'26175929',
'23987500',
'24990805',
'24469449',
'26175959',
'24104357',
'26175995',
'31648499',
'25126033',
'24460883',
'26175993',
'26068593',
'22396578',
'23987504',
'27412348',
'27898932',
'26175916',
'31734444',
'26175998',
'22396597',
'23987496',
'24623902',
'22796627',
'23499659',
'22396606',
'31908944',
'22396610',
'26177656',
'26175985',
'22396595',
'31888069',
'26176001',
'31161765',
'22396600',
'22396583',
'26175942',
'22396567',
'26175981',
'26737444',
'26719397',
'26900342',
'23505319',
'24432221',
'22396605',
'27121380',
'24895027',
'24104337',
'26175940',
'25556810',
'30274709',
'4673805',
'24104322',
'22396593',
'24623811',
'23724379',
'29195009',
'24101094',
'22906033',
'27128568',
'23576826',
'25695488',
'26058141',
'26176266',
'24882333',
'22396576',
'25808328',
'23434744',
'22396599',
'26971478',
'31670839',
'22396575',
'24078082',
'27673279',
'22396572',
'26175950',
'30841355',
'23987477',
'24104325',
'22396592',
'26971477',
'25805428',
'26175972',
'26175944',
'30679361',
'23987501',
'26724041',
'29883759',
'22396604',
'26175969',
'26900441',
'26691141',
'26900361',
'26175988',
'24432223',
'26203314',
'22396602',
'28019428',
'22396587',
'22396611',
'24683245',
'26175963',
'22396577',
'24884285',
'24104336',
'23987507',
'22396568',
'31748634',
'26177909',
'25407434',
'30799353',
'22396603',
'22396615',
'28907939',
'22396619',
'27128478',
'29289567',
'24119863',
'24104354',
'28673970',
'24432222',
'24894980',
'29721019',
'26900995',
'22396589',
'23434730',
'22396607',
'23987413',
'23948532',
'22396582',
'22396581',
'23434732',
'22396588',
'26175952',
'31594789',
'23506076',
'26175974',
'23978880',
'24432220',
'30841345',
'26900344',
'23506145',
'24104335',
'24302065',
'26175979',
'26175937',
'26175961',
'31648560',
'24104341',
'26710702',
'27526771',
'24104361',
'26175934',
'30274671',
'22396596',
'28019444',
'22396579',
'23987497',
'26175965',
'22396608',
'24804844',
'30274724',
'22396601',
'22396613',
'27276721',
'23314718',
'25808491',
'22396598')


-------- Verify Data Work Item Clean Up for Cancelled Lender or update initial Select if only specific WI's being closed out.
----REPLACE XXXXXXX WITH THE THE WI ID
----REPLACE #### WITH THE THE Lender ID

SELECT DISTINCT
        WI.ID AS WI_ID ,
        LOAN.ID AS LOAN_ID
INTO    #TMPWI
FROM    LOAN
        JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
        JOIN WORK_ITEM WI ON WI.RELATE_ID = LOAN.ID
WHERE  -- LENDER.CODE_TX = '####'
         WI.WORKFLOW_DEFINITION_ID = 8
        AND WI.STATUS_CD NOT IN ( 'COMPLETE', 'Withdrawn' )
        AND WI.PURGE_DT IS NULL
        --AND WI.CREATE_DT < '2014-01-01 00:00:00.000'
        AND LOAN.PURGE_DT IS NULL
        AND LOAN.RECORD_TYPE_CD IN ('G','A')
		AND WI.ID IN (SELECT ID FROM UniTracHDStorage..WI_INC0237598)
		

SELECT * FROM #TMPWI

SELECT * INTO UniTracHDStorage..LOAN_INC0237598
FROM dbo.LOAN WHERE ID IN (SELECT LOAN_ID FROM #TMPWI)


UPDATE  LN
SET     SPECIAL_HANDLING_XML = NULL ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0237598' ,
        LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1
                       ELSE LOCK_ID + 1
                  END
--SELECT COUNT(*)
FROM    LOAN LN
        JOIN #TMPWI ON #TMPWI.LOAN_ID = LN.ID


UPDATE  WI
SET     STATUS_CD = 'Withdrawn' ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0237598' ,
        LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1
                       ELSE LOCK_ID + 1
                  END
--SELECT COUNT(*)
FROM    WORK_ITEM WI
        JOIN #TMPWI ON #TMPWI.WI_ID = WI.ID




SELECT STATUS_CD, UPDATE_DT, UPDATE_USER_TX, LOCK_ID FROM dbo.WORK_ITEM
WHERE ID IN (SELECT WI_ID FROM #TMPWI)



SELECT SPECIAL_HANDLING_XML, UPDATE_DT, UPDATE_USER_TX, LOCK_ID
FROM dbo.LOAN WHERE ID IN (SELECT LOAN_ID FROM #TMPWI)




SELECT CONTENT_XML.value('(/Content/Lender/Code)[1]', 'varchar (50)') Lender, * --INTO UniTracHDStorage..WI_INC0222261
INTO    #TMPWII
FROM    UniTrac..WORK_ITEM
WHERE   ID IN (  (SELECT ID FROM UniTracHDStorage..WI_INC0237598)  )



UPDATE WI SET STATUS_CD = 'Withdrawn' , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'INC0237598' , 
LOCK_ID = WI.LOCK_ID % 255 + 1
---- SELECT COUNT(*)
FROM WORK_ITEM WI JOIN #TMPWII TMP ON 
TMP.ID = WI.ID
AND WI.PURGE_DT IS NULL
AND WI.STATUS_CD <> 'Withdrawn'
---- 

INSERT INTO WORK_ITEM_ACTION (WORK_ITEM_ID, ACTION_CD, FROM_STATUS_CD, TO_STATUS_CD, CURRENT_QUEUE_ID, 
CURRENT_OWNER_ID, ACTION_NOTE_TX, ACTIVE_IN, CREATE_DT, UPDATE_DT, UPDATE_USER_TX, LOCK_ID, ACTION_USER_ID)
SELECT DISTINCT ID , 'Withdraw' , STATUS_CD , 'Withdrawn' , CURRENT_QUEUE_ID , 
CURRENT_OWNER_ID , 'INC0237598' , 'Y' , GETDATE() , GETDATE() , 'INC0237598' , 1 , 1
FROM #TMPWII
ORDER BY STATUS_CD
---- 


UPDATE LN SET SPECIAL_HANDLING_XML = NULL , 
UPDATE_DT = GETDATE() , UPDATE_USER_TX  = 'INC0237598' , 
LOCK_ID = LN.LOCK_ID % 255 + 1
--- SELECT LN.NUMBER_TX
FROM LOAN LN JOIN #TMPWII ON #TMPWII.RELATE_ID = LN.ID
AND SPECIAL_HANDLING_XML IS NOT NULL
--- 




