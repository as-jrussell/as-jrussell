SELECT P.TAB.value('.', 'nvarchar(max)') AS LenderCode, SETTINGS_XML_IM.value('(/ProcessDefinitionSettings/TargetServiceList/TargetService)[1]', 'nvarchar(max)') AS ServiceName
INTO #tmpLenders
FROM PROCESS_DEFINITION pd 
CROSS APPLY pd.SETTINGS_XML_IM.nodes('(/ProcessDefinitionSettings/LenderList/LenderID)') AS P (TAB)
WHERE pd.PROCESS_TYPE_CD = 'MSGSRV' 
AND pd.ACTIVE_IN = 'y'

SELECT     'INBOUND' as 'DIRECTION',  t.ServiceName,   TP.EXTERNAL_ID_TX,      TP.NAME_TX,        WI.ID AS WI_ID ,  M.* 
FROM message M (NOLOCK) 
JOIN TRADING_PARTNER TP (NOLOCK)      ON M.RECEIVED_FROM_TRADING_PARTNER_ID = TP.ID 
JOIN      DELIVERY_INFO DI           ON M.DELIVERY_INFO_ID = DI.id 
JOIN      RELATED_DATA RD           ON DI.id = RD.RELATE_ID 
 JOIN      RELATED_DATA_DEF RDD           ON RDD.id = RD.DEF_ID 
 LEFT JOIN WORK_ITEM WI ON WI.RELATE_ID = M.ID AND WI.WORKFLOW_DEFINITION_ID = 1
 left JOIN #tmpLenders t ON t.LenderCode = TP.EXTERNAL_ID_TX
WHERE M.PROCESSED_IN = 'N' 
--AND M.RECEIVED_STATUS_CD = 'ADHOC' 
AND M.RECEIVED_STATUS_CD = 'RCVD' 
AND M.MESSAGE_DIRECTION_CD = 'I' 
and TYPE_CD = 'LFP_TP'
 AND RDD.NAME_TX = 'UniTracDeliveryType' 
and m.DELIVER_TO_TRADING_PARTNER_ID = '2046'
AND rd.VALUE_TX = 'IMPORT'
AND M.PURGE_DT IS NULL
UNION
SELECT     'INBOUND' as 'DIRECTION',  'ADHOC',   TP.EXTERNAL_ID_TX,      TP.NAME_TX,        WI.ID AS WI_ID ,  M.* 
FROM message M (NOLOCK) 
JOIN TRADING_PARTNER TP (NOLOCK)      ON M.RECEIVED_FROM_TRADING_PARTNER_ID = TP.ID 
JOIN      DELIVERY_INFO DI           ON M.DELIVERY_INFO_ID = DI.id 
JOIN      RELATED_DATA RD           ON DI.id = RD.RELATE_ID 
 JOIN      RELATED_DATA_DEF RDD           ON RDD.id = RD.DEF_ID 
 LEFT JOIN WORK_ITEM WI ON WI.RELATE_ID = M.ID AND WI.WORKFLOW_DEFINITION_ID = 1
 left JOIN #tmpLenders t ON t.LenderCode = TP.EXTERNAL_ID_TX
WHERE M.PROCESSED_IN = 'N' 
AND M.RECEIVED_STATUS_CD = 'ADHOC' 
AND M.MESSAGE_DIRECTION_CD = 'I' 
and TYPE_CD = 'LFP_TP'
 AND RDD.NAME_TX = 'UniTracDeliveryType' 
and m.DELIVER_TO_TRADING_PARTNER_ID = '2046'
AND rd.VALUE_TX = 'IMPORT'
AND M.PURGE_DT IS null

ORDER BY M.ID, EXTERNAL_ID_TX



DROP TABLE #tmpLenders





BEGIN TRAN


UPDATE  MESSAGE
SET     RECEIVED_STATUS_CD = 'ADHOC'
WHERE   ID IN (5010958,
5010959,
5010960,
5011018,
5011019,
5011020,
5011021,
5011022,
5011116,
5011117,
5011304,
5011367,
5011440)



BEGIN TRAN


UPDATE  MESSAGE
SET     RECEIVED_STATUS_CD = 'ADHOC'
WHERE   ID IN (5011590,
5011672,
5011673,
5011827,
5011830,
5011899,
5010648,
5010649,
5010774,
5010775,
5010776,
5010957)


BEGIN TRAN

UPDATE dbo.MESSAGE
SET RECEIVED_STATUS_CD = 'ADHOC'
WHERE id IN (5012663,
5012664,
5012805,
5012806,
5012967,
5012968,
5012985,
5012986,
5013103,
5013316,
5013317,
5013318,
5013319,
5013320,
5013365,
5013402,
5013403,
5013492,
5013689,
5013690,
5013809,
5013810,
5013813)


BEGIN
	TRAN

UPDATE  dbo.MESSAGE
SET     RECEIVED_STATUS_CD = 'RCVD'
--SELECT* FROM dbo.MESSAGE
WHERE   ID NOT IN ( 5017888, 5017889, 5017890, 5017891, 5017892, 5017918,
                    5017919, 5017938, 5017945, 5017946, 5017947, 5017948,
                    5017973, 5017974, 5017976, 5017977, 5017978, 5017979,
                    5017980 )
AND MESSAGE_DIRECTION_CD = 'I' AND PROCESSED_IN = 'N'
AND PURGE_DT IS NULL AND UPDATE_USER_TX <> 'MsgSrvrADHOC'

--ROLLBACK

--COMMIT


UPDATE dbo.MESSAGE
SET RECEIVED_STATUS_CD = 'RCVD'
--select * FROM message
WHERE RECEIVED_STATUS_CD = 'MSGSRVREXTUSD'




SELECT * FROM dbo.TRADING_PARTNER
ORDER BY EXTERNAL_ID_TX DESC


SELECT * FROM dbo.MESSAGE
ORDER BY RECIPIENT_TRADING_PARTNER_ID

