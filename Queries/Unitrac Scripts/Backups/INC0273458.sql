USE UniTrac	


--Loan Screen Information - LOAN/COLLATERAL/PROPERTY/OWNER/REQUIRED COVERAGE
SELECT  op.* 
INTO UniTracHDStorage..INC0273458_OP
FROM dbo.LOAN L
JOIN dbo.COLLATERAL C ON C.LOAN_ID = L.ID
JOIN dbo.PROPERTY P ON P.ID = C.PROPERTY_ID
JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = P.ID
JOIN dbo.PROPERTY_OWNER_POLICY_RELATE pop ON pop.PROPERTY_ID = P.ID
JOIN dbo.OWNER_POLICY OP ON OP.ID = pop.OWNER_POLICY_ID
JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
JOIN dbo.INTERACTION_HISTORY ih ON ih.PROPERTY_ID = p.id
WHERE RC.SUMMARY_STATUS_CD = 'E' AND L.LENDER_ID = '2291'
AND RC.SUMMARY_SUB_STATUS_CD = 'D'



SELECT  PC.*
--INTO UniTracHDStorage..INC0273458_PC
 FROM dbo.LOAN L
JOIN dbo.COLLATERAL C ON C.LOAN_ID = L.ID
JOIN dbo.PROPERTY P ON P.ID = C.PROPERTY_ID
JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = P.ID
JOIN dbo.PROPERTY_OWNER_POLICY_RELATE pop ON pop.PROPERTY_ID = P.ID
JOIN dbo.OWNER_POLICY OP ON OP.ID = pop.OWNER_POLICY_ID
JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
JOIN dbo.INTERACTION_HISTORY ih ON ih.PROPERTY_ID = p.id
WHERE RC.SUMMARY_STATUS_CD = 'E' AND L.LENDER_ID = '2291'
AND RC.SUMMARY_SUB_STATUS_CD = 'D'


SELECT  RC.*
INTO UniTracHDStorage..INC0273458_RC
 FROM dbo.LOAN L
JOIN dbo.COLLATERAL C ON C.LOAN_ID = L.ID
JOIN dbo.PROPERTY P ON P.ID = C.PROPERTY_ID
JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = P.ID
JOIN dbo.PROPERTY_OWNER_POLICY_RELATE pop ON pop.PROPERTY_ID = P.ID
JOIN dbo.OWNER_POLICY OP ON OP.ID = pop.OWNER_POLICY_ID
JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
JOIN dbo.INTERACTION_HISTORY ih ON ih.PROPERTY_ID = p.id
WHERE RC.SUMMARY_STATUS_CD = 'E' AND L.LENDER_ID = '2291'
AND RC.SUMMARY_SUB_STATUS_CD = 'D'


UPDATE  REQUIRED_COVERAGE
SET     EventOptionReaudit = '18' ,
        INSURANCE_STATUS_CD = 'F' ,
        INSURANCE_SUB_STATUS_CD = 'D' ,
        SUMMARY_STATUS_CD = 'F' ,
        SUMMARY_SUB_STATUS_CD = 'D' ,
        GOOD_THRU_DT = NULL ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0253579' ,
        BEGAN_NEW_IN = 'N' ,
        CPI_QUOTE_ID = NULL ,
        NOTICE_DT = NULL ,
        NOTICE_TYPE_CD = NULL ,
        NOTICE_SEQ_NO = NULL ,
        LAST_EVENT_SEQ_ID = NULL ,
        LAST_EVENT_DT = NULL ,
        LAST_SEQ_CONTAINER_ID = NULL ,
        LOCK_ID = LOCK_ID % 255 + 1
-- SELECT GOOD_THRU_DT,* FROM REQUIRED_COVERAGE 
WHERE   ID IN ( SELECT  id
                FROM    UniTracHDStorage..INC0273458_RC ) --AND SUMMARY_STATUS_CD <> 'E'
        AND PURGE_DT IS NULL
--12993

UPDATE OWNER_POLICY
 SET STATUS_CD = 'F' ,
SUB_STATUS_CD = 'D', 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'INC0253579', 
LOCK_ID = LOCK_ID % 255 + 1
-- SELECT * FROM Unitrac..OWNER_POLICY
WHERE ID IN (SELECT id FROM UniTracHDStorage..INC0273458_OP)  AND PURGE_DT IS NULL
--13427


--UPDATE PC SET 
--Pc.UPDATE_DT = GETDATE() , 
--PC.UPDATE_USER_TX = 'INC0253579', 
--PC.LOCK_ID = PC.LOCK_ID % 255 + 1
---- SELECT * 
--FROM POLICY_COVERAGE PC
--JOIN jc..INC0273458_PC P ON P.ID = PC.ID 
--WHERE  PC.ID IN (SELECT id from jc..INC0273458_PC) AND PC.PURGE_DT IS NULL AND PC.END_DT = '9999-12-31 23:59:59.9999999'

--27556



	
		-- Add Property change log
		-- 634
		INSERT INTO PROPERTY_CHANGE
				(
					ENTITY_NAME_TX,
					ENTITY_ID,
					USER_TX,
					ATTACHMENT_IN,
					CREATE_DT,
					AGENCY_ID,
					DESCRIPTION_TX,
					DETAILS_IN,
					FORMATTED_IN,
					LOCK_ID,
					PARENT_NAME_TX,
					PARENT_ID,
					TRANS_STATUS_CD,
					UTL_IN
				)
			SELECT DISTINCT
				'Allied.UniTrac.RequiredCoverage',
				ID,
				'UNITRAC',
				'N',
				GETDATE(),
				1,
				'Changed Summary Status from Expired to In-force',
				'N',
				'Y',
				1,
				'Allied.UniTrac.RequiredCoverage',
				ID,
				'PEND',
				'N'
			FROM
				dbo.REQUIRED_COVERAGE
			WHERE   ID IN ( SELECT  id
                FROM    UniTracHDStorage..INC0273458_RC )
        AND PURGE_DT IS NULL





UPDATE RC
SET     EventOptionReaudit = '18' ,
        INSURANCE_STATUS_CD = 'F' ,
        INSURANCE_SUB_STATUS_CD = 'D' ,
        SUMMARY_STATUS_CD = 'F' ,
        SUMMARY_SUB_STATUS_CD = 'D' ,
        GOOD_THRU_DT = NULL ,
        UPDATE_DT = GETDATE() ,
        UPDATE_USER_TX = 'INC0253579' ,
        BEGAN_NEW_IN = 'N' ,
        CPI_QUOTE_ID = NULL ,
        NOTICE_DT = NULL ,
        NOTICE_TYPE_CD = NULL ,
        NOTICE_SEQ_NO = NULL ,
        LAST_EVENT_SEQ_ID = NULL ,
        LAST_EVENT_DT = NULL ,
        LAST_SEQ_CONTAINER_ID = NULL ,
        LOCK_ID = LOCK_ID % 255 + 1
-- SELECT * 
FROM dbo.REQUIRED_COVERAGE RC
JOIN UniTracHDStorage..INC0273458_RC RC1 ON RC.ID = RC1.ID 
WHERE RC.ID NOT IN (SELECT ID FROM UniTracHDStorage..JDByrider_expired3)
--12993



SELECT  RC.*
 FROM dbo.LOAN L
JOIN dbo.COLLATERAL C ON C.LOAN_ID = L.ID
JOIN dbo.PROPERTY P ON P.ID = C.PROPERTY_ID
JOIN dbo.REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = P.ID
WHERE RC.SUMMARY_STATUS_CD = 'E' AND L.LENDER_ID = '2291'
AND RC.SUMMARY_SUB_STATUS_CD = 'D'


SELECT * FROM dbo.REF_CODE
WHERE CODE_CD IN ('D', 'E') --AND DOMAIN_CD = 'RequiredCoverageInsSubStatus'
AND DOMAIN_CD IN ('RequiredCoverageInsStatus','RequiredCoverageInsSubStatus')

SELECT * FROM dbo.LENDER
WHERE id = '2291'


SELECT * FROM UniTrac..POLICY_COVERAGE
WHERE OWNER_POLICY_ID IN (SELECT ID FROM Unitrac..OWNER_POLICY
WHERE ID IN (SELECT id from UniTracHDStorage..INC0273458_OP))


\


SELECT * FROM Unitrac..OWNER_POLICY
WHERE ID IN (SELECT id from UniTracHDStorage..INC0273458_OP)



SELECT * FROM Unitrac..REQUIRED_COVERAGE
WHERE ID IN (SELECT id from UniTracHDStorage..INC0273458_RC)




 SELECT GOOD_THRU_DT,* FROM REQUIRED_COVERAGE 
WHERE   ID IN ( SELECT  id
                FROM    UniTracHDStorage..INC0273458_RC ) AND SUMMARY_STATUS_CD = 'E'
        AND PURGE_DT IS NULL
--12993