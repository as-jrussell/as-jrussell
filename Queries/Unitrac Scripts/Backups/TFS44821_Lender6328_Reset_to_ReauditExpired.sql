/*
	TFS 44821
	CF Finance lender 6328

	We likely need to update the Req Coverage Summary Status and Sub Status to Reaudit Expired, and likely the Owner Policy Status and Sub Status, 
	and the corresponding Policy Coverage Expiration dates (so it doesn't go into Reaudit Inforce). 
	Exposure Date/Expiration Date can be set at 1/2/18. 

	Adjust RC Status & clear good thru date
	Create PC & PCU records
	Revert OP & PC to prior status and end/exp dates
	Purge OP IH Record related to expiration

*/
	
IF OBJECT_ID(N'tempdb..#tmpReAuditRCs',N'U') IS NOT NULL
	DROP TABLE #tmpReAuditRCs
IF OBJECT_ID(N'tempdb..#tmpPolicies',N'U') IS NOT NULL
	DROP TABLE #tmpPolicies 	
IF OBJECT_ID(N'tempdb..#tmpCurrentPC',N'U') IS NOT NULL
	DROP TABLE #tmpCurrentPC
IF OBJECT_ID(N'tempdb..#tmpMaxStart',N'U') IS NOT NULL
	drop table #tmpMaxStart   

    CREATE TABLE #tmpReAuditRCs
    (
      LOAN_ID BIGINT ,
      RC_ID BIGINT ,
	  PROP_ID BIGINT,
	  LOAN_NO varchar(100),
      INS_SUMMARY_STATUS VARCHAR(1),
	  INS_SUMMARY_SUB_STATUS VARCHAR(1),
	  EXPOSURE_DT DATETIME
    )

Declare @Task varchar(8) = 'TASK44821'
Declare @ExpiredStatus varchar(2) = 'E'
Declare @NewExposure datetime = '01/02/2018'
	
INSERT INTO #tmpReAuditRCs
(
    LOAN_ID, RC_ID, PROP_ID, LOAN_NO, INS_SUMMARY_STATUS, INS_SUMMARY_SUB_STATUS, EXPOSURE_DT
)
select  l.ID, RC.ID, RC.PROPERTY_ID, l.NUMBER_TX, rc.SUMMARY_STATUS_CD, rc.SUMMARY_SUB_STATUS_CD, rc.EXPOSURE_DT
from loan l
inner join lender ldr on ldr.id = l.LENDER_ID
inner join COLLATERAL c on c.LOAN_ID = l.ID
inner join REQUIRED_COVERAGE rc on rc.PROPERTY_ID = c.PROPERTY_ID and rc.PURGE_DT is NULL
where ldr.CODE_TX = '6328' and rc.INSURANCE_STATUS_CD = 'F'
 and rc.INSURANCE_SUB_STATUS_CD = 'R' and l.RECORD_TYPE_CD = 'G'
and l.NUMBER_TX in ('16001909',
'3008944',
'11004143',
'8004668',
'6005662',
'6005712',
'10008945',
'15002231',
'8004538',
'7004782',
'1006893',
'6005929',
'13001882',
'9005036',
'10010122',
'16002432',
'15002432',
'6005837',
'1006944',
'16001691',
'12004074',
'1006451',
'10009788',
'10009117',
'5008445',
'2005945',
'5007511',
'4008258',
'10009582',
'15003073',
'15002638',
'6005821',
'10009641',
'4007836',
'15001792',
'40002823',
'10009680',
'17002453',
'13002192',
'9005547',
'10009455',
'1007026',
'10009465',
'13002637',
'10010229',
'11005752',
'9005270',
'4006374',
'13001709',
'10009946',
'6006221',
'15002828',
'15001805',
'2005282',
'17001942',
'11005789',
'40002013',
'16001917',
'9005288',
'12005150',
'15001862',
'15002719',
'17002483',
'17002483',
'15002725',
'9005898',
'15003218',
'4007738',
'5007648',
'15002786',
'4008270',
'17002005',
'12004741',
'10009554',
'9005345',
'17002123',
'1007395',
'15002752',
'15003239',
'9005028',
'16002092',
'10009112',
'15002532',
'11005812',
'7005089',
'12004092',
'1007390',
'10009675',
'15002698',
'5006966',
'12004689',
'18000187',
'4007214',
'15002400',
'10009608',
'10010094',
'10009439',
'5008666',
'13002982',
'4007808',
'10009131',
'10009760',
'4006135',
'4007083',
'4007083',
'11005188',
'6005301',
'10008543',
'11006187',
'11006187',
'13002765',
'6006015',
'15002357',
'1007373',
'17002332',
'14002140',
'40001862',
'3008621',
'16001945',
'15002644',
'18000199',
'9004663',
'12004641',
'10008967',
'16002343',
'6006474',
'6006567',
'11005751',
'13002331',
'4008240',
'1007344',
'11006647',
'8004668',
'1007394',
'12004472',
'1007327',
'16002203',
'18000290',
'10009672',
'13002983',
'10008901',
'4008271',
'3008449',
'4007024',
'15002184',
'16001964',
'16001964',
'10009452',
'10009679',
'17001123',
'10008421',
'1007744',
'15001787',
'15002806',
'13001976',
'1007418',
'5006855',
'10009548',
'14002306',
'6006185',
'12004527',
'10009732',
'5007889',
'10009840',
'10009741',
'12004305',
'1006890',
'4007342',
'12004962',
'15002542',
'40002565',
'5008944',
'15003234',
'13002417',
'10008246',
'17001922',
'18000371',
'10009642',
'10009939',
'5006828',
'11005656',
'10009894',
'7004906',
'7004906',
'40002920',
'13001779',
'4006700',
'4008385',
'7005418',
'8004342',
'11005575',
'1007462',
'10009764',
'7005527',
'1007238',
'3007856',
'14002182',
'15003108',
'2005606',
'4007859',
'14001912',
'10009802',
'10009748',
'10009733',
'14001924',
'16002462',
'14001689',
'1007897',
'12005032',
'40002378',
'1007601',
'10009125',
'2006637',
'5008362',
'9005197',
'11006563',
'10009783',
'6006000',
'6006363',
'15002785',
'5007729',
'5008857',
'13002442',
'15003238',
'13002442',
'17002119',
'13002979',
'13002495',
'17002321',
'4006087',
'16002357',
'1007618',
'12004839',
'11005746',
'1007498',
'15002402',
'12004640',
'17001968',
'6006016',
'16002281',
'6006487',
'6006260',
'4007426',
'16002446',
'12003855',
'17002087',
'4008156',
'4007437',
'15002848',
'10008805',
'16001644',
'15002891',
'40002792',
'15002689',
'40002252',
'15002650',
'7005861',
'7005306',
'15002564',
'16002195',
'14002900',
'3008272',
'5008190',
'16002232',
'14001854',
'1006955',
'10009918',
'15002954',
'10009438',
'13002574',
'13002554',
'1006536',
'7005271',
'15002203',
'11006748',
'11005765',
'13001989',
'11005807',
'5008564',
'11006403',
'11005654',
'13002575',
'2006342',
'5008537',
'14001439',
'16002038',
'11006196',
'13001285',
'4008046',
'12004564',
'10009854',
'6006314',
'1007557',
'13002668',
'4007396',
'10009857',
'15002393',
'5008291',
'10009961',
'13001742',
'15001205',
'1007427',
'6006339',
'10009761',
'13002634',
'1007191',
'13002597',
'2005698',
'15002645',
'10009504',
'10009837',
'13002629',
'6006553',
'15003175',
'4007031',
'10009536',
'10009166',
'1007570',
'1006899',
'10009879',
'1007690',
'10009769',
'8005020',
'40002658',
'13002271',
'17001973',
'11006222',
'10009813',
'8005153',
'15002699',
'10008158',
'5008520',
'5008444',
'1006346',
'13003018',
'1007500',
'40002352',
'12004792',
'18000202',
'14002593',
'5008064',
'16001329',
'5008518',
'14001854',
'10009491',
'6006136',
'17002400',
'10008904',
'10009887',
'6006351',
'14002590',
'40002541',
'15002252',
'16001659',
'12003600',
'13001660',
'40002375',
'4007723',
'15003078',
'6006431',
'17001462',
'12004324',
'1007209',
'1007513',
'8005211',
'13002498',
'4006712',
'1007456',
'17002046',
'1007594',
'1007416',
'1007596',
'4007861',
'1007836',
'19000125',
'3008517',
'2005906',
'15003249',
'13002946',
'13002305',
'8005046',
'8005198',
'1007602',
'1007602',
'15003183',
'8005027',
'1007494',
'18000320',
'5007969',
'16002219',
'1007605',
'4006709',
'18000299',
'12004844',
'16002440',
'12004404',
'12003733',
'10010164',
'2006093',
'19000210',
'1007615',
'9004297',
'4006611',
'1007872',
'4007493',
'4005403',
'1007610',
'4007229',
'2006674',
'16001853',
'14002152',
'9005848',
'17001964',
'13002518',
'12004825',
'6006358',
'14002792',
'11006585',
'12005017',
'1007213',
'8004594',
'12005069',
'5008332',
'10009643',
'10009876',
'10009876',
'10009782',
'18000291',
'15002114',
'4007611',
'10009959',
'40002795',
'12003819',
'15003085',
'1006990',
'17002009',
'12003909',
'18000326',
'5008565',
'16001823',
'1006928',
'12004432',
'15001811',
'18000345',
'1007805',
'1007445',
'11006619',
'13001833',
'13002303',
'11006577',
'16002249',
'15002580',
'13001789',
'11006747',
'11006326',
'12004559',
'40002616',
'12004571',
'18000344',
'10008686',
'3008481',
'5007569',
'15003224',
'10009493',
'13001915',
'5007934',
'6005972',
'10008417',
'6006317',
'1007449',
'40002880',
'9005922',
'1007668',
'17001248',
'16001575',
'11005746',
'7005307',
'11005823',
'2006326',
'15002749',
'16002289',
'8004958',
'2006512',
'12005029',
'3008558',
'5007630',
'11005829',
'5008630',
'7005413',
'2006358',
'15002176',
'10009705',
'2006572',
'10009525',
'1007684',
'1007502',
'12004838',
'10009950',
'10008311',
'12005137',
'17001743',
'17001743',
'5006467',
'10009416',
'16002485',
'5007688',
'17002015',
'11004860',
'9005682',
'2006409',
'14001847',
'4007988',
'13002926',
'2005765',
'16001649',
'6006566',
'17001797',
'2006541',
'4007826',
'16002207',
'11004340',
'5008056',
'4007405',
'5008807',
'40002587',
'18000351',
'10009932',
'11005410',
'7005617',
'18000190',
'10008519',
'6006534',
'14002257',
'40002599',
'14002656',
'3008144',
'40002258',
'11004861',
'17001748',
'5008488',
'1007792',
'15002767',
'5008696',
'10010063',
'10009077',
'12004401',
'12005129',
'8005080',
'12005157',
'17002442',
'8004992',
'4005645',
'16001322',
'40002594',
'4008260',
'4008221',
'6005264',
'7005712',
'7005712',
'14002358',
'12004148',
'5008169',
'16002263',
'9004832',
'17001081',
'11006223',
'18000486',
'14002395',
'4007715',
'4008342',
'15001945',
'10009781',
'16002303',
'3008576',
'13002743',
'10009909',
'40002691',
'5008597',
'4008267',
'12004829',
'12004829',
'12004829',
'5008739',
'10009997',
'10009419',
'1007686',
'10009592',
'6006438',
'6006438',
'10009970',
'4006684',
'13002295',
'3008593',
'1007816',
'4007201',
'4007944',
'7005373',
'7005854',
'17001839',
'16001938',
'17001212',
'17002129',
'10009161',
'10009533',
'15003104',
'11006358',
'2006481',
'13001794',
'16002272',
'16002404',
'16002403',
'11006035',
'10008613',
'17002171',
'8005049',
'11005949',
'14002638',
'10009578',
'16002351',
'13002366',
'8004661',
'4006655',
'12004413',
'10009614',
'17002036',
'3007304',
'17001736',
'15002960',
'5007962',
'13002693',
'10009974',
'11006591',
'19000108',
'10009986',
'17001663',
'10009886',
'1006679',
'4007966',
'10009636',
'17001223',
'5007695',
'12004397',
'17002305',
'9005030',
'14002605',
'10009979',
'14002332',
'18000203',
'3008475',
'8005164',
'40002863',
'17001209',
'4007916',
'15002973',
'13001962',
'7005383',
'1007538',
'9004634',
'16002276',
'10009502',
'17002365',
'17002347',
'16002260',
'9005931',
'1007707',
'2006335',
'12005111',
'10008686',
'10009091',
'10009927',
'8005089',
'8005089',
'14002858',
'16002142',
'6006017',
'40002287',
'2006236',
'1007581',
'1007571',
'1007571',
'1007622',
'16001678',
'10009604',
'11006409',
'11006635',
'15003112',
'16002464',
'17002036',
'18000388',
'9005726',
'9005487',
'19000207',
'11006418',
'9005631',
'10009710',
'1007518',
'10010133',
'10009729',
'16002283',
'6006203',
'8005220',
'13002601',
'13002601',
'2006708',
'4007989',
'2006521',
'40002644',
'5007407',
'15001777',
'5008625',
'11006385',
'12004428',
'11005279',
'10009660',
'18000184',
'7005705',
'11005809',
'4007975',
'16002474',
'11005280',
'10010118',
'10009647',
'40002627',
'5007419',
'7005380',
'7005380',
'13001931',
'4006353',
'10009447',
'40002710',
'11005933',
'4007933',
'14002367',
'14002367',
'8005212',
'19000259',
'12004346',
'11005721',
'16002032',
'1007708',
'1007703',
'12004970',
'12004440',
'2006421',
'1007818',
'3007521',
'17001767',
'14002360',
'1007709',
'18000374',
'11006370',
'10009523',
'1007265',
'9005063',
'10009761',
'2006184',
'2006528',
'15003098',
'15003098',
'11005827',
'10009815',
'10009511',
'10008588',
'15002424',
'7004935',
'10009394',
'13002678',
'13002678',
'8004580',
'4008268',
'6006381',
'6006381',
'9005933',
'9005162',
'8004975',
'6006341',
'12004901',
'13001965',
'12005059',
'15002662',
'7005013',
'2006346',
'16002185',
'11005734',
'8005177',
'8005177',
'9005294',
'14002494',
'5008099',
'17002471',
'1007631',
'2006607',
'6006545',
'15002632',
'10009290',
'12004441',
'13002309',
'13002309',
'12004225',
'16002259',
'1007748',
'11005886',
'17001506',
'17001509',
'14002502',
'7005775',
'10008158',
'8004650',
'2006676',
'5008357',
'17001006',
'40002755',
'10009881',
'10010005',
'9005231',
'4008006',
'16002491',
'12004923',
'17002391',
'18000476',
'4008206',
'9005867',
'10009632',
'10010011',
'15002781',
'17002116',
'1007727',
'18000386',
'16002021',
'14002226',
'10009826',
'16001292',
'17001834',
'13001982',
'6006457',
'4008402',
'4008402',
'4008402',
'14001632',
'7005695',
'7005695',
'13002994',
'4006456',
'10010019',
'16002373',
'3008699',
'40002635',
'16002439',
'40002600',
'3008189',
'3008944',
'18000389',
'11005907',
'9005915',
'13003014',
'2006620',
'16002246',
'17001062',
'17001145',
'13002702',
'10009050',
'13001882',
'4008329',
'16001261',
'1006125',
'11005861',
'8004945',
'9005670',
'16002465',
'10009478',
'4007632',
'1007550',
'13002776',
'40002604',
'10008867',
'10010029',
'10010038',
'2006155',
'1006613',
'8004661',
'10009796',
'9005714',
'13002805',
'11006717',
'11005906',
'10010105',
'10009345',
'11004552',
'16001970',
'16001970',
'16001893',
'4005378',
'9005866',
'17002347',
'12005120',
'2006482',
'2006482',
'14001007',
'10010076',
'10009816',
'11006507',
'16001976',
'10009904',
'3009010',
'4008040',
'4007654',
'11006119',
'10010234',
'17002404',
'4008085',
'4008256',
'5008900',
'11006631',
'12004429',
'12004617',
'5006621',
'12004475',
'16002352',
'11006249',
'11006249',
'4007201',
'5007338',
'6006223',
'3008971',
'5007911',
'5008298',
'10010035',
'7005383',
'10009690',
'1007895',
'16001702',
'15001863',
'10008840',
'4005693',
'11006086',
'5008820',
'40002666',
'13001161',
'4007569',
'11006729',
'16002388',
'15002956',
'7005505',
'14002662',
'13002314',
'8004565',
'8004565',
'18000469',
'10009501',
'15003100',
'40002536',
'10009571',
'1007398',
'7005348',
'11006220',
'40002742',
'13002332',
'7005831',
'13001908',
'7005444',
'13002800',
'15003187',
'10009141',
'10009624',
'7004954',
'2006300',
'9005243',
'4008427',
'1007549',
'4006632',
'16002361',
'15003184',
'1007786',
'1007907',
'1007269',
'14002635',
'1007791',
'10009169',
'12003482',
'1007782',
'4007309',
'16001952',
'18000421',
'10009254',
'16001754',
'15001511',
'12005160',
'13002633',
'11006586',
'5008175',
'11004544',
'40002430',
'8004916',
'16002470',
'16002470',
'9005827',
'8005155',
'2006270',
'11005951',
'10010131',
'7004980',
'3008986',
'16001538',
'12005031',
'4007801',
'2005589',
'9005293',
'14002348',
'4007202',
'4007202',
'10009555',
'10010199',
'10010199',
'5008834',
'5008922',
'15003054',
'4007229',
'13002192',
'13002192',
'1007312',
'2006710',
'8004297',
'11005754',
'40002637',
'10009336',
'5008294',
'5008352',
'10009737',
'5008536',
'5008536',
'10009451',
'5007961',
'40002869',
'16002371',
'6006615',
'17002124',
'17002183',
'6006201',
'12005110',
'40002767',
'17001769',
'12004818',
'16002193',
'10010112',
'8004769',
'16002383',
'10009306',
'40002774',
'10010237',
'11006514',
'4008147',
'10009720',
'10009140',
'16002385',
'17001315',
'11005675',
'12004869',
'10010064',
'8005153',
'13002815',
'5007989',
'14002603',
'5008881',
'10010220',
'15002634',
'16002055',
'16002055',
'4006015',
'2006499',
'7005276',
'6006106',
'10009016',
'13001962',
'4006531',
'9005373',
'1007948',
'14002300',
'10009794',
'14002863',
'11005638',
'11006676',
'7005005',
'8004978',
'8004978',
'12003578',
'12004282',
'10010086',
'8005109',
'18000453',
'14002773',
'17002477',
'11004319',
'2006599',
'4007008',
'18000430',
'4007694',
'7005401',
'8004306',
'12004864',
'16001773',
'5007768',
'17002472',
'4007911',
'6006355',
'11005978',
'14002481',
'9004543',
'4007922',
'11006048',
'18000477',
'16001572',
'7005863',
'3008503',
'15003039',
'18000432',
'2006298',
'13001709',
'12004742',
'3008539',
'2006227',
'10009551',
'4007926',
'4008140',
'5008609',
'40002437',
'1006794',
'12004710',
'4008195',
'10009937',
'4008295',
'1007549',
'8004350',
'40002518',
'17002167',
'17002318',
'6006577',
'6006577',
'8005089',
'11004140',
'11004140',
'2004503',
'19000210',
'1007664',
'4006695',
'15002759',
'9005651',
'1007073',
'11005621',
'11006364',
'4007390',
'16001973',
'3008264',
'4005146',
'16002410',
'11006554',
'16002480',
'7005715',
'3009003',
'7005849',
'9005341',
'4007436',
'5008689',
'12005071',
'16002473',
'2006410',
'17002176',
'17002057',
'15002873',
'40002805',
'11006069',
'11006069',
'2005740',
'16002081',
'16001297',
'1006590',
'1007835',
'6006365',
'13002862',
'16002264',
'13001915',
'3008994',
'13001779',
'1007838',
'10009531',
'13001803',
'11006503',
'2005787',
'16001897',
'2005085',
'8004607',
'5006527',
'13003018',
'15003233',
'4007892',
'16002074',
'12005084',
'18000193',
'18000193',
'4005731',
'5008741',
'15002979',
'14001497',
'3006881',
'7005926',
'5007722',
'2006675',
'12004811',
'14002410',
'18000287',
'1007237',
'12004982',
'15002504',
'11006625',
'40002819',
'10009506',
'2006639',
'6006545',
'2006332',
'14001497',
'10010241',
'10010140',
'10008527',
'15003071',
'15003071',
'16002198',
'40002205',
'4006997',
'1007555',
'9005883',
'11006681',
'10009579',
'18000348',
'3008653',
'11005402',
'10010117',
'13001801',
'5008763',
'4006668',
'8004845',
'1007192',
'4008394',
'6006397',
'7005285',
'15003194',
'9005404',
'16001847',
'40002149',
'16001882',
'16001882',
'13001575',
'15003140',
'4007990',
'12005062',
'12005062',
'7005435',
'15001730',
'15003075',
'14002110',
'5007966',
'5007966',
'5007973',
'10010181',
'4006165',
'10009944',
'15002627',
'2005237',
'9004581',
'8005082',
'14002622',
'10009442',
'16002261',
'12004858',
'12004858',
'14001942',
'14001942',
'1007434',
'4007572',
'11005682',
'3008192',
'1007437',
'13002167',
'3008037',
'8005036',
'7005903',
'4006231',
'4007292',
'12004771',
'7005339',
'12005108',
'3008897',
'1007853',
'16001074',
'5007352',
'12005145',
'3008893',
'3007542',
'14002218',
'14002650',
'13002544',
'10008908',
'12005099',
'7005919',
'10009230',
'17002374',
'3008898',
'10010135',
'12005041',
'12005041',
'15002647',
'15002647',
'14002487',
'4007638',
'7005679',
'13002881',
'13002881',
'11004903',
'11004903',
'8005161',
'17001039',
'11006720',
'12004743',
'12005147',
'16002219',
'12004311',
'5007718',
'14002844',
'11006656',
'15002240',
'7005853',
'16001901',
'3008896',
'1007865',
'2006416',
'12005132',
'6006527',
'40002809',
'11006644',
'12005104',
'14002386',
'10010017',
'19000171',
'14002843',
'11006639',
'4006471',
'11006633',
'10009819',
'15002637',
'14002420',
'10009654',
'1007823',
'4008407',
'11006185',
'40002295',
'5008907',
'5008765',
'10008574',
'13002973',
'2006157',
'14002817',
'3008629',
'8005209',
'13001336',
'18000402',
'5007323',
'15003249',
'4006631',
'11005404',
'10008885',
'13002893',
'17002148',
'5008164',
'10009377',
'17002014',
'2006705',
'14002641',
'4007809',
'1006258',
'10010213',
'3007529',
'6005384',
'10009653',
'10009378',
'2006415',
'7005291',
'15001961',
'17001960',
'15003252',
'5008865',
'3007692',
'3007950',
'17002050',
'7005818',
'8005148',
'15002345',
'12005084',
'13002880',
'11006600',
'4008358',
'5008267',
'10009985',
'17001493',
'10010151',
'3008855',
'11005403',
'4006375',
'16002451',
'16002404',
'40002801',
'16001783',
'17001932',
'4005433',
'4007249',
'2006025',
'40002668',
'10009838',
'2006148',
'16002079',
'16002386',
'14002806',
'7005560',
'5008724',
'6006062',
'11005939',
'17002482',
'18000372',
'11005292',
'17002481',
'16002457',
'6006337',
'17002401',
'6006483',
'4008309',
'16001952',
'1007888',
'3008828',
'3008828',
'10009980',
'19000123',
'7005230',
'10009344',
'5008778',
'40002418',
'15003279',
'8004878',
'7005324',
'10009747',
'3006913',
'10009143',
'10009148',
'7005280',
'11006294',
'11006175',
'4007918',
'10010124',
'7004867',
'10009488',
'15002771',
'16001801',
'3008456',
'2006370',
'12005125',
'12005125',
'10009609',
'16001815',
'13002679',
'4008360',
'7005333',
'18000467',
'11005863',
'14002317',
'14002781',
'16001846',
'16001846',
'1007007',
'1007552',
'19000269',
'10009397',
'7004772',
'10008834',
'2006437',
'5008629',
'13002136',
'7005103',
'2006253',
'1007898',
'7005805',
'11006554',
'11006480',
'10009559',
'14002601',
'40002652',
'1006743',
'11006622',
'17001502',
'16002426',
'7005862',
'3007980',
'16002449',
'6006056',
'5008853',
'16002460',
'5008645',
'6005488',
'19000246',
'14002150',
'2005884',
'5006240',
'12005120',
'13002678',
'17002178',
'11006690',
'13002899',
'15003265',
'6005687',
'15002818',
'12005130',
'11004455',
'7005909',
'4006151',
'17002488',
'10009726',
'17002019',
'13002687',
'1007663',
'3008468',
'11005732',
'14002810',
'14002810',
'15003216',
'15003216',
'17001517',
'17002949',
'40002872',
'40001857',
'10010176',
'1007368',
'17001952',
'13002922',
'1007886',
'10010167',
'40002864',
'4008323',
'5008573',
'4007092',
'10008566',
'12005144',
'6006581',
'12005057',
'12005057',
'12004936',
'10009443',
'10010203',
'40002902',
'16001571',
'11005934',
'5008862',
'14002404',
'12004370',
'12004370',
'9005794',
'14002288',
'2006354',
'17001056',
'12004808',
'11006636',
'13002295',
'2006435',
'3008737',
'3008737',
'16002018',
'3008777',
'18000433',
'18000433',
'18000454',
'11005694',
'3008881',
'1007589',
'7005729',
'40002830',
'15002878',
'1007900',
'13001475',
'17002334',
'7005772',
'10009703',
'13002465',
'8005226',
'8005163',
'40002873',
'7005480',
'14002847',
'13002303',
'4008222',
'5008940',
'16001721',
'13002589',
'15002683',
'1007919',
'11006688',
'11005617',
'40002124',
'9005314',
'4008353',
'7005343',
'7005343',
'18000032',
'11005238',
'7005937',
'11005977',
'40002571',
'11006702',
'11005420',
'4006811',
'10009475',
'11006612',
'16002200',
'16002200',
'11006393',
'14001483',
'7005910',
'1007713',
'12004416',
'5007980',
'10010134',
'14002222',
'12005135',
'5007060',
'4007121',
'12004761',
'12003996',
'16001941',
'5008691',
'12005067',
'13002821',
'4006982',
'14002629',
'16001925',
'40002638',
'11004007',
'12005119',
'12004821',
'10009526',
'10009824',
'6006589',
'6005880',
'10008534',
'10008895',
'17002353',
'10009844',
'9005917',
'4007446',
'11006703',
'2006218',
'16002419',
'9005365',
'14002170',
'14002775',
'1007679',
'10010077',
'12005150',
'18000469',
'4007176',
'1007825',
'15002426',
'6006590',
'4008355',
'5007995',
'3008487',
'12005046',
'2005760',
'13002869',
'13002933',
'13002989',
'3008765',
'2006150',
'15003235',
'5008209',
'5008087',
'5008595',
'10009519',
'10009987',
'8005032',
'8005032',
'18000066',
'19000256',
'4006278',
'1007932',
'16002238',
'10009557',
'4008364',
'19000250',
'15001880',
'18000094',
'4007673',
'13002703',
'12003975',
'12004387',
'10009613',
'4008279',
'2005944',
'11005911',
'11005743',
'10010240',
'12005196',
'15003031',
'4006905',
'11005768',
'4008043',
'12004762',
'12004786',
'4007595',
'4008306',
'7005115',
'14001942',
'16002475',
'17001927',
'11006617',
'14002821',
'3008782',
'1007920',
'14002320',
'14002320',
'9005510',
'10008977',
'40002831',
'11006722',
'3007436',
'15003267',
'10009896',
'4007461',
'5008897',
'2006274',
'11006271',
'4008307',
'40002891',
'11005724',
'11006344',
'4008148',
'1007804',
'14002230',
'19000116',
'13002434',
'5008260',
'11006204',
'11005407',
'5006871',
'4007896',
'16002228',
'5008868',
'14002003',
'15002963',
'15002963',
'6006594',
'10010202',
'14002328',
'16002479',
'13002953',
'17001920',
'17001920',
'40002892',
'11005893',
'10009946',
'13002500',
'10010212',
'11006263',
'1007021',
'12005154',
'11006400',
'4007529',
'17001971',
'13002658',
'3006905',
'5007981',
'2006474',
'40002550',
'1007267',
'16002481',
'11006603',
'2006086',
'3008634',
'3008706',
'13002848',
'10009623',
'40002898',
'12005204',
'10009684',
'12005168',
'10009587',
'10009699',
'11005119',
'15001980',
'10009509',
'2006205',
'6006138',
'6006138',
'15001084',
'14001544',
'14001544',
'4007065',
'19000253',
'12003952',
'11005048',
'5008895',
'7005665',
'10009358',
'12004820',
'16002483',
'5008016',
'6005579',
'18000090',
'5007951',
'3008958',
'2006670',
'40002901',
'13002958',
'3008255',
'17002170',
'4008247',
'5008567',
'14002864',
'15002657',
'4007503',
'14001693',
'14002837',
'7005752',
'7005841',
'4007824',
'11006399',
'15003077',
'15003077',
'15003077',
'2006357',
'11006588',
'10009681',
'11006759',
'5008568',
'1006778',
'1007928',
'12005015',
'5008029',
'8005253',
'12004835',
'15003264',
'4008063',
'7005297',
'3008084',
'16002318',
'10010211',
'1007935',
'4008320',
'5008822',
'5008879',
'6006152',
'4008446',
'10008993',
'10008894',
'3008583',
'9005589',
'17002034',
'7005303',
'12004846',
'7005428',
'13001537',
'11006208',
'14002872',
'8004052',
'6006005',
'11006485',
'11006485',
'6006307',
'17001966',
'5008454',
'17001947',
'19000257',
'17001993',
'17001156',
'7005702',
'12004180',
'10009303',
'10010121',
'3008955',
'13002957',
'11006673',
'14002761',
'6005384',
'10010190',
'12004821',
'11006415',
'10010219',
'16001928',
'7005623',
'11006648',
'14001444',
'17001963',
'2006436',
'11006219',
'15003199',
'5008079',
'13001650',
'5008914',
'11005326',
'17002958',
'4008408',
'4008408',
'16001933',
'2005893',
'13002988',
'16002456',
'11006755',
'11006224',
'12003633',
'18000478',
'2005285',
'2006211',
'16001957',
'19000262',
'13003006',
'1007868',
'4008349',
'6005587',
'17002335',
'1007645',
'17001741',
'1007879',
'19000120',
'10009581',
'11006765',
'4006749',
'3007087',
'1007942',
'16002495',
'4006140',
'9005951',
'2006518',
'5008049',
'7004841',
'12004258',
'5008092',
'11006616',
'12004807',
'13002989',
'4006005',
'17002961',
'11005878',
'11005878',
'18000468',
'2006100',
'16002060',
'10010138',
'16002012',
'1007947',
'9005345',
'13003002',
'10009638',
'7005704',
'5008674',
'14002548',
'14002886',
'13001969',
'9005642',
'5008756',
'13002601',
'10009362',
'10009330',
'2006612',
'6005802',
'6005802',
'6006364',
'18000328',
'16002416',
'14002786',
'8005197',
'1007912',
'10010116',
'14002533',
'5007033',
'5008419',
'5008563',
'8005258',
'4006755',
'11006627',
'16001896',
'16002453',
'18000447',
'10010238',
'12004715',
'18000409',
'8004660',
'16002329',
'9005375',
'40002916',
'40002913',
'7005325',
'14002156',
'19000145',
'5008326',
'17002956',
'5008727',
'4007519',
'12004887',
'3008246',
'4008317',
'7005894',
'12004823',
'6006218',
'6006218',
'16002502',
'16002502',
'19000270',
'12005048',
'13001635',
'1006740',
'13002984',
'7005332',
'10009532',
'2006348',
'14002560',
'6006583',
'6006583',
'12005156',
'11006630',
'2006715',
'17001959',
'13002251',
'4007348',
'2006164',
'13001970',
'13001970',
'18000354',
'2006323',
'2006323',
'5008082',
'12003955',
'12003955',
'2006654',
'16002033',
'13002371',
'13003017',
'11005810',
'13002583',
'40002941',
'13002463',
'16001624',
'6006011',
'11005123',
'19000273',
'11005968',
'5008941',
'11005852',
'5008942',
'11005846',
'13002281',
'9005704',
'11006727',
'10010228',
'1006591',
'13002880',
'18000399',
'13002959',
'13002959',
'14002290',
'5007847',
'6006583',
'3008947',
'3008947',
'6006588',
'5008075',
'17002302',
'13001890',
'2006091',
'13002666',
'4007177',
'10009522',
'10009708',
'12004960',
'13001573',
'10010192',
'10009907',
'12004775',
'7005709',
'11006583',
'2006244',
'14001509',
'3008574',
'13002690',
'2006667',
'7005337',
'17002482',
'3007901',
'5008132',
'7005277',
'9005723',
'2006504',
'9005877',
'12005171',
'5008369',
'7005666',
'11005927',
'4007957',
'6006318',
'14002079',
'12004819',
'17002952',
'3008852',
'3008852',
'7004143',
'14002643',
'16002400',
'14001501',
'19000227',
'12005142',
'3008701',
'40002357',
'16002271',
'7004190',
'14002633',
'17002294',
'6006315',
'9005647',
'16002397',
'12003240',
'12003240',
'9004251',
'16001676',
'14002763',
'4007542',
'10009860',
'5008052',
'5008738',
'10009085',
'4007586',
'16002464',
'16002464',
'3007948',
'16001954',
'11006489')



--SELECT * from #tmpReAuditRCs


 update rc
 set rc.Summary_Status_CD = @ExpiredStatus, rc.INSURANCE_STATUS_CD = @ExpiredStatus, rc.EXPOSURE_DT = @NewExposure,
 rc.Good_THRU_DT = null, rc.UPDATE_USER_TX=@Task, rc.UPDATE_DT = getdate(), rc.LOCK_ID = (LOCK_ID % 255) + 1

 from REQUIRED_COVERAGE rc
 join #tmpReAuditRCs t on t.RC_ID = rc.ID
 where rc.PURGE_DT is null 

  


BEGIN /* --  Insert Pc & PCU records for RC */
  		
	  declare @rowcount int = 0
	  declare @rcID bigint = 0,
	          @propID bigint = 0,
			  @currentSummaryStatus nvarchar(2)= null,
			  @currentExposure datetime = null,
			  @chunksize int = 1000
	  declare itemCursor cursor for
	  select RC_ID, PROP_ID,INS_SUMMARY_STATUS, EXPOSURE_DT from #tmpReAuditRCs;

	  open itemCursor

	  fetch next from itemCursor into @rcID, @propID, @currentSummaryStatus, @currentExposure

	  WHILE @@FETCH_STATUS = 0
	  BEGIN	  
		-- check to see if a transaction has been started yet
		-- if not (@rowcount is 0), begin a transaction
		if @rowcount = 0
		begin
			begin transaction
		end
		declare @propChangeID bigint = 0
		-- Insert into Property Change Table
		Insert into PROPERTY_CHANGE (ENTITY_NAME_TX,ENTITY_ID,USER_TX,ATTACHMENT_IN,CREATE_DT,DETAILS_IN,FORMATTED_IN,LOCK_ID,PARENT_NAME_TX,PARENT_ID,TRANS_STATUS_CD,UTL_IN)
			values ('Allied.UniTrac.RequiredCoverage',@rcID,@Task,'N',getdate(),'Y','N',1,'Allied.UniTrac.Property',@propID,'PEND','N')
		set @propChangeID = SCOPE_IDENTITY()
		if (@propChangeID <> 0)
		begin
		-- Insert into Property Change Update Table

		--SUMMARY_STATUS_CD
		insert into PROPERTY_CHANGE_UPDATE (CHANGE_ID,TABLE_NAME_TX,TABLE_ID,COLUMN_NM,FROM_VALUE_TX,TO_VALUE_TX,DATATYPE_NO,CREATE_DT,DISPLAY_IN,OPERATION_CD)
			values(@propChangeID,'REQUIRED_COVERAGE',@rcID,'SUMMARY_STATUS_CD',@currentSummaryStatus,@ExpiredStatus,2,getdate(),'Y','U')


		--INSURANCE_STATUS_CD
		insert into PROPERTY_CHANGE_UPDATE (CHANGE_ID,TABLE_NAME_TX,TABLE_ID,COLUMN_NM,FROM_VALUE_TX,TO_VALUE_TX,DATATYPE_NO,CREATE_DT,DISPLAY_IN,OPERATION_CD)
			values(@propChangeID,'REQUIRED_COVERAGE',@rcID,'INSURANCE_STATUS_CD',@currentSummaryStatus,@ExpiredStatus,2,getdate(),'Y','U')

		--EXPOSURE_DT
		insert into PROPERTY_CHANGE_UPDATE (CHANGE_ID,TABLE_NAME_TX,TABLE_ID,COLUMN_NM,FROM_VALUE_TX,TO_VALUE_TX,DATATYPE_NO,CREATE_DT,DISPLAY_IN,OPERATION_CD)
			values(@propChangeID,'REQUIRED_COVERAGE',@rcID,'EXPOSURE_DT',@currentExposure,@NewExposure,2,getdate(),'Y','U')

		END
		 -- increment the rowcount
		 set @rowcount = @rowcount + 1

		 -- if the rowcount equals the @chunksize, commit the transaction
		 --  reset @rowcount to begin a new transaction
		 if @rowcount = @chunksize
		 begin
		 	  commit transaction
		 	  set @rowcount = 0
		 end

		fetch next from itemCursor into @rcID,@propID, @currentSummaryStatus, @currentExposure
	  END

	  -- if there were any rows updated since the last commit, commit them now
	  if @rowcount > 0
	  	commit transaction

	  close itemCursor;
	  deallocate itemCursor;
end /* --  Insert Pc & PCU records for RC */

	 
begin /* -- OP & PC Records */


select 
t.LOAN_ID, t.RC_ID,t.PROP_ID, op.id as OP_ID,  t.LOAN_NO, op.STATUS_CD, op.SUB_STATUS_CD, op.POLICY_NUMBER_TX ,cast( '01/02/2018' as datetime) as NEW_EXP_DATE
into #tmpPolicies
from  #tmpReAuditRCs t
inner join PROPERTY_OWNER_POLICY_RELATE popr on popr.PROPERTY_ID = t.PROP_ID and popr.PURGE_DT is NULL
inner join OWNER_POLICY op on op.id = popr.OWNER_POLICY_ID and op.PURGE_DT is null


--where op.STATUS_CD = 'F' and op.SUB_STATUS_CD = 'R' and op.EXPIRATION_DT > '01/01/2016'
order by t.LOAN_NO

select 'Owner Policies to Update', *, @ExpiredStatus as NewStatus_CD from #tmpPolicies order by Loan_no



select op.ID as OP_ID, max(t.NEW_EXP_DATE) as EXPIRATION_DT, pc.TYPE_CD, pc.SUB_TYPE_CD, max(pc.START_DT) as MAX_START_DT
into #tmpMaxStart
from OWNER_POLICY op
  join #tmpPolicies t on op.ID = t.OP_ID
  join POLICY_COVERAGE pc on op.ID = pc.OWNER_POLICY_ID and pc.PURGE_DT is null
group by op.ID, pc.TYPE_CD, pc.SUB_TYPE_CD

 
select op.ID as OP_ID, pc.ID as PC_ID, t.EXPIRATION_DT, pc.TYPE_CD, pc.SUB_TYPE_CD, max(pc.END_DT) MAX_END_DT
into #tmpCurrentPC
from OWNER_POLICY op
  join #tmpMaxStart t on op.ID = t.OP_ID
  join POLICY_COVERAGE pc on op.ID = pc.OWNER_POLICY_ID and pc.PURGE_DT is null
                         and t.TYPE_CD = pc.TYPE_CD and t.SUB_TYPE_CD = pc.SUB_TYPE_CD
                                        and pc.START_DT >= t.MAX_START_DT
                                        --and op.EXPIRATION_DT != pc.END_DT
group by op.ID, pc.ID, t.EXPIRATION_DT, pc.TYPE_CD, pc.SUB_TYPE_CD

SELECT 'PCs To Be Updated', Pc.ID, PC.OWNER_POLICY_ID, pc.END_DT, t.EXPIRATION_DT
from POLICY_COVERAGE pc
   join #tmpCurrentPC t on pc.ID = t.PC_ID
where pc.END_DT = t.MAX_END_DT


BEGIN /* UPDATES */
	update op
	set op.STATUS_CD = @ExpiredStatus, op.EXPIRATION_DT = t.New_Exp_Date, 
	op.UPDATE_DT = getdate(), op.UPDATE_USER_TX = @task, op.LOCK_ID = (op.LOCK_ID % 255) + 1
	from OWNER_POLICY op
	join #tmpPolicies t on t.OP_ID = op.ID

	 update pc
	 set pc.END_DT = t.EXPIRATION_DT, UPDATE_DT = getdate(), pc.UPDATE_USER_TX = @task, pc.LOCK_ID = (pc.LOCK_ID % 255 ) + 1
	 from POLICY_COVERAGE pc
	   join #tmpCurrentPC t on pc.ID = t.PC_ID
	where pc.END_DT = t.MAX_END_DT

END /* UPDATES */

END /* -- OP & PC Records */


	

SELECT *
FROM REQUIRED_COVERAGE RC
where UPDATE_USER_TX = 'INC0368902'


