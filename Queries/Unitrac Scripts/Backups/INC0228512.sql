--SELECT * FROM LENDER WHERE CODE_TX = '4750'
---- 2231
SELECT TOP 5 OP.*
--INTO UniTracHDStorage..INC0228512OP
 FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
INNER JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
INNER JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
INNER JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
WHERE LL.CODE_TX IN ('4171') AND L.NUMBER_TX  IN ('53018-01',
'7595-24',
'133195-24',
'109121-24',
'17931-02',
'102631-01',
'111740-24',
'160531-24',
'108756-02',
'125790-01',
'132786-24',
'116995-24',
'134911-01',
'94920-25',
'143720-02',
'20767-24',
'93032-01',
'49601-01',
'180143-01',
'166484-24',
'187449-01',
'121664-24',
'131404-01',
'149038-02',
'190820-24',
'119908-01',
'168179-01',
'144530-24',
'173923-01',
'159465-02',
'73471-01',
'192088-01',
'147238-25',
'69396-01',
'192398-24',
'174833-02',
'122288-01',
'163034-24',
'185384-24',
'12089-24',
'146876-01',
'186008-24',
'138180-01',
'90061-24',
'94343-02',
'159813-24',
'149450-24',
'155996-03',
'106462-24',
'139306-24',
'126562-24',
'72216-02',
'160057-24',
'15447-04',
'32285-24',
'172747-01',
'162467-24',
'146526-24',
'132521-24',
'56236-24',
'100222-25',
'194442-24',
'5857-24',
'180764-01',
'129653-03',
'65687-24',
'149874-25',
'53542-24',
'77050-24',
'208862-01',
'71877-26',
'38073-01',
'80187-01',
'148704-24',
'81756-01',
'139172-03',
'187260-24',
'101907-24',
'117747-24',
'123335-24',
'209525-24',
'209017-24',
'158279-24',
'165148-01',
'125475-01',
'125475-03',
'107799-24',
'142303-24',
'155060-24',
'156435-24',
'128038-24',
'80319-24',
'129549-24',
'138111-24',
'120052-24',
'183938-01',
'38271-24',
'191709-01',
'107857-24',
'99507-01',
'32201-03',
'27711-01',
'121060-25',
'121981-24',
'213761-01',
'127328-04',
'16315-01',
'214514-24',
'36200-01',
'142270-01',
'75029-02',
'113022-02',
'178468-24',
'122654-01',
'191541-01',
'155576-25',
'131735-24',
'75704-24',
'121834-02',
'121834-26',
'59088-24',
'70135-01',
'131077-03',
'49555-04',
'214500-01',
'163351-24',
'132989-24',
'164306-24',
'179619-24',
'218211-01',
'60994-02',
'155405-01',
'16225-25',
'52036-03',
'122425-01')




SELECT * FROM dbo.REF_CODE
WHERE DOMAIN_CD IN( 'OwnerPolicySubStatus', 'OwnerPolicyStatus')



UPDATE dbo.OWNER_POLICY
SET SUB_STATUS_CD = 'R', UPDATE_DT = GETDATE(),
UPDATE_USER_TX = 'INC0228512', EXPIRATION_DT = '2016-03-01 00:00:00.0000000', 
EFFECTIVE_DT = '2016-03-01 00:00:00.0000000'
WHERE ID IN (SELECT ID FROM UniTracHDStorage..INC0228512OP)




--- DROP TABLE #TMPPLCY
SELECT LOAN.NUMBER_TX , LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX , 
COLL.LOAN_ID , COLL.ID AS COLL_ID , 
---COLL.PROPERTY_ID , 
RC.TYPE_CD AS RC_TYPE_CD , RC.ID AS RC_ID , 
RC.SUMMARY_SUB_STATUS_CD , RC.SUMMARY_STATUS_CD , RC.EXPOSURE_DT , 
RC.CPI_QUOTE_ID , RC.NOTICE_DT , RC.NOTICE_SEQ_NO , RC.NOTICE_TYPE_CD , 
RC.LAST_EVENT_DT , RC.LAST_EVENT_SEQ_ID , RC.LAST_SEQ_CONTAINER_ID , 
PLCY.* , 0 AS EXCLUDE
INTO #TMPPLCY
FROM LOAN
JOIN COLLATERAL COLL ON COLL.LOAN_ID = LOAN.ID
AND COLL.PURGE_DT IS NULL AND LOAN.PURGE_DT IS NULL
AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN PROPERTY PR ON PR.ID = COLL.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.PROPERTY_ID = COLL.PROPERTY_ID
AND RC.PURGE_DT IS NULL
CROSS APPLY
(
SELECT * FROM dbo.GetCurrentCoverage(PR.ID , RC.ID , RC.TYPE_CD)
)  AS PLCY
WHERE RC.ID IN (SELECT ID FROM UniTracHDStorage..INC0228512RC)
ORDER BY NUMBER_TX
----10



UPDATE #TMPPLCY SET EXCLUDE = 1 WHERE SUMMARY_SUB_STATUS_CD = 'R'
----0

--SELECT DISTINCT SUMMARY_STATUS_CD , SUMMARY_SUB_STATUS_CD FROM #TMPPLCY
--WHERE EXCLUDE = 0 

UPDATE #TMPPLCY SET EXCLUDE = 2 WHERE SUMMARY_SUB_STATUS_CD <> 'D'
AND EXCLUDE = 0
----- 0

UPDATE #TMPPLCY SET EXCLUDE = 3 WHERE SUMMARY_STATUS_CD <> 'E'
AND EXCLUDE = 0
----0

--UPDATE #TMPPLCY SET EXCLUDE = -1 WHERE EXCLUDE = 0 
--AND NOTICE_SEQ_NO > 0
----22


SELECT T1.* , PC.ID AS PC_ID , PC.START_DT , PC.END_DT , PC.TYPE_CD , PC.SUB_TYPE_CD ,
PC.UPDATE_USER_TX AS PC_UPDATE_USER_TX
INTO #TMPPC
FROM POLICY_COVERAGE PC JOIN #TMPPLCY T1 ON T1.ID = PC.OWNER_POLICY_ID
WHERE PC.PURGE_DT IS NULL
AND EXCLUDE = 0 
----- 10

SELECT * 
INTO #TMPPLCY_01
FROM #TMPPLCY
WHERE EXCLUDE = 0
----10


SELECT * 
INTO UnitracHDStorage.dbo.tmpTask36802_PLCY_01
FROM #TMPPLCY
---- 10

SELECT * 
INTO UnitracHDStorage.dbo.tmpTask36802_PC_01
FROM #TMPPC
---- 10

UPDATE PLCY SET 
SUB_STATUS_CD = 'R', 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'TASK36802' , 
LOCK_ID = PLCY.LOCK_ID % 255 + 1
---- SELECT *
FROM OWNER_POLICY PLCY JOIN #TMPPLCY_01 T1 ON T1.ID = PLCY.ID
AND PLCY.STATUS_CD = 'E'
AND PLCY.SUB_STATUS_CD = 'D'
----- 10



----- GET THE LIST OF RC'S IN #TMPRC
---- DROP TABLE #TMPRC
SELECT  *
INTO #TMPRC
FROM #TMPPLCY_01
WHERE CPI_QUOTE_ID > 0
AND EXCLUDE = 0 
----0

---- DROP TABLE #tmpIH
SELECT IH.ID AS IH_ID
INTO #tmpIH
FROM #TMPRC tmp
		JOIN INTERACTION_HISTORY IH ON IH.RELATE_ID = tmp.CPI_QUOTE_ID
WHERE
		IH.TYPE_CD = 'CPI'
		AND IH.RELATE_CLASS_TX = 'ALLIED.UNITRAC.CPIQUOTE'
		AND tmp.RC_ID = ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/RC)[1]', 'BIGINT'),0 )
		and tmp.PROPERTY_ID = IH.property_id     
		AND ISNULL(IH.SPECIAL_HANDLING_XML.value('(/SH/Status)[1]', 'varchar(20)'),'') = 'Open'
		AND IH.PURGE_DT IS NULL
		---- 0
	
INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	tf.RC_ID,
	'TASK36802',
	'N',
	GETDATE(),
	1,
	'Notice Cycle Cleared',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	TF.RC_ID,
	'PEND',
	'N'
--SELECT * 
FROM
	 #TMPPLCY_01 tf
WHERE
	NOTICE_SEQ_NO > 0
	AND EXCLUDE = 0 
	----- 0		
						
			
UPDATE QT
	SET	QT.CLOSE_REASON_CD = 'NCC',
		QT.CLOSE_DT = GETDATE(),
		QT.UPDATE_DT = GETDATE(),
		QT.UPDATE_USER_TX = 'TASK36802',
		QT.LOCK_ID = (QT.LOCK_ID % 255) + 1
	--SELECT COUNT(*)
	FROM CPI_QUOTE QT
	JOIN #TMPRC RC
		ON RC.CPI_QUOTE_ID = QT.ID
		---- 0
			
			
UPDATE IH
SET	SPECIAL_HANDLING_XML.modify('replace value of (/SH/Status/text())[1] with "Closed" '),
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'TASK36802',
	LOCK_ID = (IH.LOCK_ID % 255) + 1
--SELECT COUNT(*)
FROM INTERACTION_HISTORY IH
JOIN #tmpIH
	ON #tmpIH.IH_ID = IH.ID
----- 0



UPDATE RC SET GOOD_THRU_DT = NULL , 
INSURANCE_STATUS_CD = 'E' , 
INSURANCE_SUB_STATUS_CD = 'R' , 
SUMMARY_STATUS_CD = 'E' , 
SUMMARY_SUB_STATUS_CD = 'R' , 
NOTICE_DT = NULL , 
NOTICE_SEQ_NO = NULL , 
NOTICE_TYPE_CD = NULL , 
LAST_EVENT_DT = NULL , 
LAST_EVENT_SEQ_ID = NULL , 
LAST_SEQ_CONTAINER_ID = NULL ,
CPI_QUOTE_ID = NULL , 
UPDATE_DT = GETDATE() , 
UPDATE_USER_TX = 'INC0228512' , 
LOCK_ID = RC.LOCK_ID % 255 + 1
---- SELECT *
FROM REQUIRED_COVERAGE RC JOIN #TMPPLCY_01 T1 ON T1.RC_ID = RC.ID
WHERE EXCLUDE = 0 
AND RC.SUMMARY_SUB_STATUS_CD = 'D'
AND RC.SUMMARY_STATUS_CD = 'E'
AND RC.INSURANCE_SUB_STATUS_CD = 'D'
AND RC.INSURANCE_STATUS_CD = 'E'
----- 10

INSERT INTO
	PROPERTY_CHANGE (
		ENTITY_NAME_TX,
		ENTITY_ID,
		USER_TX,
		ATTACHMENT_IN,
		CREATE_DT,
		AGENCY_ID,
		DESCRIPTION_TX,
		DETAILS_IN,
		FORMATTED_IN,
		LOCK_ID,
		PARENT_NAME_TX,
		PARENT_ID,
		TRANS_STATUS_CD,
		UTL_IN)
SELECT DISTINCT
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'TASK36802',
	'N',
	GETDATE(),
	1,
	'Changed Summary status to Re-audit Expired',
	'N',
	'Y',
	1,
	'Allied.UniTrac.RequiredCoverage',
	RC_ID,
	'PEND',
	'N'
--SELECT * 
FROM
	 #TMPPLCY_01 WHERE EXCLUDE = 0 
	 ----- 10
	 
	 
UPDATE EVALUATION_EVENT
SET STATUS_CD = 'CLR',
	UPDATE_DT = GETDATE(),
	UPDATE_USER_TX = 'INC0228512',
	LOCK_ID = (LOCK_ID % 255) + 1
--SELECT ee.*
FROM
	EVALUATION_EVENT ee
	JOIN #TMPPLCY_01 te ON ee.REQUIRED_COVERAGE_ID = te.RC_ID
	WHERE ee.STATUS_CD = 'PEND'
	AND ee.EVENT_SEQUENCE_ID > 0
	----0


