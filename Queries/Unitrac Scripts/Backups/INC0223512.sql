USE [UniTrac]
GO 


--Any loan with memo of only a Policy Exp Date of 12/31/9999 needs to have that memo removed. Example loan: 100021232
SELECT  P.Id INTO #tmp
 FROM LOAN L
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
LEFT JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
LEFT JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
LEFT JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
WHERE LL.CODE_TX IN ('7350') --AND OP.EXPIRATION_DT = '9999-12-31 23:59:59.9999999'
AND  L.NUMBER_TX = '100011947'
--P.ID = '113536196' AND



--AND L.NUMBER_TX = '100021232' 
SELECT * --INTO UniTracHDStorage..INC0223512_PolicyExp
INTO #tmpB
 FROM dbo.INTERACTION_HISTORY
WHERE PROPERTY_ID IN (SELECT * FROM #tmp) --AND PURGE_DT IS NULL 
AND TYPE_CD = 'MEMO'
AND NOTE_TX = 'Policy Number:  
Insurance Company Name:  
Insurance Company Name:  
Policy Effective Date:  
Policy Expiration Date: 12/31/9999 
Policy Cancellation Date:  
Agent Name:  
Agent Phone:'


SELECT ID INTO #tmpB
FROM UniTracHDStorage..INC0223512_PolicyExp


UPDATE dbo.INTERACTION_HISTORY
SET PURGE_DT = GETDATE(), UPDATE_DT = GETDATE(), UPDATE_USER_TX = 'INC0223512'
--SELECT * FROM dbo.INTERACTION_HISTORY
WHERE ID IN (SELECT ID FROM #tmpB)

--- Insurance needs to be updated from Auto to Real Estate


SELECT DISTINCT L.NUMBER_TX, L.CREATE_DT[Loan Active Date], RCC.DESCRIPTION_TX [Loan Status], 
rcd.DESCRIPTION_TX [Loan Record Type],
 OP.POLICY_NUMBER_TX, OP.BASE_PROPERTY_TYPE_CD, OP.ID [OwnerPolicyID], L.ID [LoanID]
 INTO UniTracHDStorage..INC0223512
 FROM LOAN L
 INNER JOIN dbo.LENDER LL ON LL.ID = L.LENDER_ID
INNER JOIN COLLATERAL C ON L.ID = C.LOAN_ID
INNER JOIN PROPERTY P ON C.PROPERTY_ID = P.ID
INNER JOIN REQUIRED_COVERAGE RC ON P.ID = RC.PROPERTY_ID
INNER JOIN OWNER_LOAN_RELATE OL ON L.ID = OL.LOAN_ID
INNER JOIN OWNER O ON OL.OWNER_ID = O.ID
INNER JOIN OWNER_ADDRESS OA ON O.ADDRESS_ID = OA.ID
LEFT JOIN dbo.PROPERTY_OWNER_POLICY_RELATE POP ON POP.PROPERTY_ID = P.ID
LEFT JOIN dbo.OWNER_POLICY OP ON OP.ID = POP.OWNER_POLICY_ID
LEFT JOIN dbo.POLICY_COVERAGE PC ON PC.OWNER_POLICY_ID = OP.ID
LEFT JOIN dbo.REF_CODE rcc ON RCC.CODE_CD = L.STATUS_CD AND rcc.DOMAIN_CD = 'LoanStatus'
LEFT JOIN dbo.REF_CODE rcd ON RCd.CODE_CD = L.RECORD_TYPE_CD AND rcd.DOMAIN_CD = 'RecordType'
WHERE LL.CODE_TX IN ('7350') AND OP.BASE_PROPERTY_TYPE_CD = 'AUTO'
--AND L.NUMBER_TX IN ( '1045574', '30009563') AND OP.POLICY_NUMBER_TX = '19BEL2327'


SELECT DISTINCT BASE_PROPERTY_TYPE_CD FROm dbo.OWNER_POLICY

SELECT * FROM dbo.REF_CODE
WHERE CODE_CD = 'G'


SELECT OwnerPolicyID
INTO #tmp
 FROM UniTracHDStorage..INC0223512

UPDATE dbo.OWNER_POLICY
SET BASE_PROPERTY_TYPE_CD = 'RE', UPDATE_DT =GETDATE(), UPDATE_USER_TX = 'INC0223512'
--SELECT * FROM dbo.OWNER_POLICY
WHERE ID IN (SELECT * FROM #tmp)

SELECT * FROM dbo.INTERACTION_HISTORY
WHERE PROPERTY_ID = '107786060'

