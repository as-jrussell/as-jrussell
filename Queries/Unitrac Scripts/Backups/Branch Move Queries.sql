SELECT *
FROM UniTracHDStorage.dbo.BRANCH_MOVE_1695

SELECT *
FROM LENDER
WHERE CODE_TX = '1695'

--Save original LOAN rows into temp table
SELECT * INTO UniTracHDStorage.dbo.LOAN_1695_INC0199757
FROM LOAN
WHERE LENDER_ID = 1026 
AND NUMBER_TX IN (SELECT ContractNumber
FROM UniTracHDStorage.dbo.BRANCH_MOVE_1695) AND BRANCH_CODE_TX <> 'Guardian Angel CU'
--419

--Narrow down to 51 rows being updated
SELECT BRANCH_CODE_TX,*
FROM LOAN
WHERE ID IN (123189242,120396735,120396736,124514896,119992825,120396742,123189250,124514899,124514900,123189254,121728244,120397158,123189266,120397337,123189267,124514906,121729374,124514910,124514911,120398069,123189276,124514915,120398371,120398502,124514918,119993166,119993173,119993182,120398980,120399001,123204203,121739853,123207840,120400469,123207987,120400615,116117332,116117409,116118266,113274832,121752515,111959649,120400931,116119002,123209617,123209630,113275317,107864076,114624859,117487878,124548932)




--1) Update BRANCH_CODE_TX field in LOAN table
UPDATE LN 
SET BRANCH_CODE_TX = 'Guardian Angel CU',UPDATE_DT = GETDATE() , UPDATE_USER_TX = 'INC0199757' ,
LOCK_ID = CASE WHEN LOCK_ID >= 255 THEN 1 ELSE LOCK_ID + 1 END
---- SELECT DISTINCT LN.ID , LN.BRANCH_CODE_TX
FROM LOAN LN
WHERE ID IN (123189242,120396735,120396736,124514896,119992825,120396742,123189250,124514899,124514900,123189254,121728244,120397158,123189266,120397337,123189267,124514906,121729374,124514910,124514911,120398069,123189276,124514915,120398371,120398502,124514918,119993166,119993173,119993182,120398980,120399001,123204203,121739853,123207840,120400469,123207987,120400615,116117332,116117409,116118266,113274832,121752515,111959649,120400931,116119002,123209617,123209630,113275317,107864076,114624859,117487878,124548932)


--Confirm select from RC table
select GOOD_THRU_DT ,L.NUMBER_TX,RC.*
FROM REQUIRED_COVERAGE RC 
INNER JOIN PROPERTY P ON RC.PROPERTY_ID = P.ID
INNER JOIN COLLATERAL C ON P.ID = C.PROPERTY_ID
INNER JOIN LOAN L ON L.ID = C.LOAN_ID
WHERE L.ID IN (123189242,120396735,120396736,124514896,119992825,120396742,123189250,124514899,124514900,123189254,121728244,120397158,123189266,120397337,123189267,124514906,121729374,124514910,124514911,120398069,123189276,124514915,120398371,120398502,124514918,119993166,119993173,119993182,120398980,120399001,123204203,121739853,123207840,120400469,123207987,120400615,116117332,116117409,116118266,113274832,121752515,111959649,120400931,116119002,123209617,123209630,113275317,107864076,114624859,117487878,124548932)




--2) Update GOOD_THRU_DT field to NULL in REQUIRED_COVERAGE table
UPDATE RC SET RC.GOOD_THRU_DT = NULL ,RC.UPDATE_DT = GETDATE() , RC.UPDATE_USER_TX = 'INC0199757' ,
RC.LOCK_ID = CASE WHEN RC.LOCK_ID >= 255 THEN 1 ELSE RC.LOCK_ID + 1 END
---- SELECT DISTINCT RC.ID
FROM REQUIRED_COVERAGE RC 
INNER JOIN PROPERTY P ON RC.PROPERTY_ID = P.ID
INNER JOIN COLLATERAL C ON P.ID = C.PROPERTY_ID
INNER JOIN LOAN L ON L.ID = C.LOAN_ID
WHERE L.ID IN (123189242,120396735,120396736,124514896,119992825,120396742,123189250,124514899,124514900,123189254,121728244,120397158,123189266,120397337,123189267,124514906,121729374,124514910,124514911,120398069,123189276,124514915,120398371,120398502,124514918,119993166,119993173,119993182,120398980,120399001,123204203,121739853,123207840,120400469,123207987,120400615,116117332,116117409,116118266,113274832,121752515,111959649,120400931,116119002,123209617,123209630,113275317,107864076,114624859,117487878,124548932)



--3) Insert History into PROPERTY_CHANGE table
--Update description field based on new and old branch name. If it varies on loan by loan basis, need to link in our temp table form the beginning

 INSERT INTO PROPERTY_CHANGE
 ( ENTITY_NAME_TX , ENTITY_ID , USER_TX , ATTACHMENT_IN , 
 CREATE_DT , AGENCY_ID , DESCRIPTION_TX ,  DETAILS_IN , FORMATTED_IN ,
 LOCK_ID , PARENT_NAME_TX , PARENT_ID , TRANS_STATUS_CD , UTL_IN )
 SELECT DISTINCT 'Allied.UniTrac.Loan' , L.ID , 'UNITRAC' , 'N' , 
 GETDATE() ,  1 , 
 'Moved Loan to Branch Guardian Angel CU', 
 'Y' , 'N' , 1 ,  'Allied.UniTrac.Loan' , L.ID , 'PEND' , 'N'
FROM REQUIRED_COVERAGE RC 
INNER JOIN PROPERTY P ON RC.PROPERTY_ID = P.ID
INNER JOIN COLLATERAL C ON P.ID = C.PROPERTY_ID
INNER JOIN LOAN L ON L.ID = C.LOAN_ID
WHERE L.ID IN (123189242,120396735,120396736,124514896,119992825,120396742,123189250,124514899,124514900,123189254,121728244,120397158,123189266,120397337,123189267,124514906,121729374,124514910,124514911,120398069,123189276,124514915,120398371,120398502,124514918,119993166,119993173,119993182,120398980,120399001,123204203,121739853,123207840,120400469,123207987,120400615,116117332,116117409,116118266,113274832,121752515,111959649,120400931,116119002,123209617,123209630,113275317,107864076,114624859,117487878,124548932)


SELECT *
FROM LENDER_ORGANIZATION
WHERE LENDER_ID = 1026 AND TYPE_CD = 'BRCH'


