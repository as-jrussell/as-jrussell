 ---- GET THE ACCOUNTING PERIOD
 --- DROP TABLE #TMPACCT
 IF OBJECT_ID(N'tempdb..#TMPACCT',N'U') IS NOT NULL
       DROP TABLE #TMPACCT
 
 SELECT TOP 1 * 
 INTO #TMPACCT
 FROM ACCOUNTING_PERIOD 
 WHERE AGENCY_ID = 1
 AND PURGE_DT IS NULL 
 AND REPORTED_IN = 'N'
 ORDER BY ID DESC
 
 SELECT * FROM #TMPACCT
 
---- GET ALL THE TXNS. POSTED FOR THE GIVEN ACCOUNTING PERIOD
--- DROP TABLE #TMPFPC
 IF OBJECT_ID(N'tempdb..#TMPFPC',N'U') IS NOT NULL
       DROP TABLE #TMPFPC

 SELECT LENDER.CODE_TX , LENDER.NAME_TX , LOAN.LENDER_ID , LOAN.NUMBER_TX , 
 LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX ,  
 COLL.COLLATERAL_CODE_ID , CC.CODE_TX AS CC_CODE_TX , 
 CC.PRIMARY_CLASS_CD , CC.SECONDARY_CLASS_CD , CC.CONTRACT_TYPE_CD , 
 RC.TYPE_CD AS RC_TYPE_CD , 
 FT.ID AS FT_ID , FT.TXN_DT ,  FT.TXN_TYPE_CD , FT.AMOUNT_NO , 
 FT.FPC_ID , FPC.NUMBER_TX AS FPC_NUMBER_TX , FPC.EFFECTIVE_DT , FPC.EXPIRATION_DT , FPC.CANCELLATION_DT ,
 COLL.LOAN_ID , RC.PROPERTY_ID , RC.ID AS RC_ID , COLL.ID AS COLL_ID , 
 0 AS EXCLUDE
 INTO #TMPFPC
 FROM FINANCIAL_TXN FT
 JOIN FORCE_PLACED_CERTIFICATE FPC ON FPC.ID = FT.FPC_ID
JOIN FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE REL ON REL.FPC_ID = FPC.ID
AND REL.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.ID = REL.REQUIRED_COVERAGE_ID
AND RC.PURGE_DT IS NULL
JOIN PROPERTY PR ON PR.ID = RC.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN COLLATERAL COLL ON COLL.PROPERTY_ID = PR.ID
AND COLL.PURGE_DT IS NULL AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN LOAN ON LOAN.ID = COLL.LOAN_ID
AND LOAN.PURGE_DT IS NULL
JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
AND LENDER.PURGE_DT IS NULL
JOIN COLLATERAL_CODE CC ON CC.ID = COLL.COLLATERAL_CODE_ID
JOIN #TMPACCT T1 ON T1.AGENCY_ID = 1
 WHERE LOAN.AGENCY_ID = 1
 AND FT.PURGE_DT IS NULL
 AND FPC.PURGE_DT IS NULL
 AND FT.TXN_TYPE_CD IN ('P', 'CP')
 AND T1.START_DT <= FT.TXN_DT
 AND T1.END_DT >= FT.TXN_DT
 --AND FT.TXN_DT >= '2015-07-01 00:00:00.0000000'
 --AND FT.TXN_DT <= '2015-08-01 00:00:00.0000000'
 ORDER BY LENDER.CODE_TX , LOAN.DIVISION_CODE_TX , RC.TYPE_CD
 --- 25701
 
 ------ GET ALL COMMISSIONS SETUP FOR ALLIED
 --- DROP TABLE #TMPCR
 IF OBJECT_ID(N'tempdb..#TMPCR',N'U') IS NOT NULL
       DROP TABLE #TMPCR
 
SELECT LENDER.CODE_TX , LENDER.NAME_TX , LENDER.TEST_IN , LENDER.CANCEL_DT , 
CR.LENDER_ID , CR.ID AS CR_ID , CR.TYPE_CD , CR.SUSPENDED_IN , 
CR.EFFECTIVE_DT , CR.EXPIRATION_DT , 
CR.AMOUNT_NO , CR.PERCENT_NO ,  
BOG.GROUP_TYPE_CD , BOG.DESCRIPTION_TX , BOG.ID AS BOG_ID , 
BRB.ID AS BRB_ID ,
RCB.ID AS RCB_ID , RCB.NAME_TX AS RCB_NAME , RCB.CONDITION_TYPE_CD , RCB.ORDER_NO , RCB.LEVEL_NO ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/@OperatorCode)[1]' , 'varchar(50)') OperatorCode ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamClassName)[1]' , 'varchar(50)') LParamClassName ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamProperty)[1]' , 'varchar(50)') LParamProperty ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamType)[1]' , 'varchar(50)') RParamType ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValue)[1]' , 'varchar(50)') RParamValue ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValueType)[1]' , 'varchar(50)') RParamValueType , 
BO.ID AS BO_ID_0 , BO.NAME_TX AS BO_NAME_0 , BO.DESCRIPTION_TX AS BO_DESCRIPTION_0 , 
BO.DEFAULT_VALUE_TX AS BO_DEFAULT_0 ,
BO1.ID AS BO_ID_1 , BO1.NAME_TX AS BO_NAME_1 , BO1.DESCRIPTION_TX AS BO_DESCRIPTION_1, 
BO1.DEFAULT_VALUE_TX AS BO_DEFAULT_1 
INTO #TMPCR
FROM COMMISSION_RATE CR
LEFT JOIN BUSINESS_OPTION_GROUP BOG ON BOG.RELATE_ID = CR.ID
AND BOG.PURGE_DT IS NULL
AND BOG.RELATE_CLASS_NM = 'Allied.UniTrac.CommissionRate'
LEFT JOIN BUSINESS_RULE_BASE BRB ON BRB.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BRB.PURGE_DT IS NULL
LEFT JOIN RULE_CONDITION_BASE RCB ON RCB.BUSINESS_RULE_BASE_ID = BRB.ID
AND RCB.PURGE_DT IS NULL
JOIN LENDER ON LENDER.ID = CR.LENDER_ID
LEFT JOIN BUSINESS_OPTION BO ON BO.BUSINESS_RULE_ID = BRB.ID
AND BO.PURGE_DT IS NULL
LEFT JOIN BUSINESS_OPTION BO1 ON BO1.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BO1.PURGE_DT IS NULL
WHERE LENDER.PURGE_DT IS NULL
AND LENDER.AGENCY_ID = 1
AND CR.PURGE_DT IS NULL
ORDER BY LENDER.CODE_TX , CR.ID
---- 8334

---- CASE I
---- EXCLUDE THE COMM WITH NO RULES OR WITH COLL CODE SELECTED
---- DROP TABLE #TMPCR_01
IF OBJECT_ID(N'tempdb..#TMPCR_01',N'U') IS NOT NULL
       DROP TABLE #TMPCR_01

SELECT * 
INTO #TMPCR_01
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') IN ( '' ,  'Allied.UniTrac.Collateral')
)
----8086

UPDATE #TMPFPC SET EXCLUDE =  0
---- 25701


--- EXCLUDE THE FPC'S WITH COMM RULES SETUP WITH DIV & COV TYPE SELECTED
UPDATE FPC SET EXCLUDE = 1
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND CR.TYPE_CD = 'AGENCY'
AND EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
---- 25582

----- CASE II
---- RULE SETUP ONLY WITH COVERAGE TYPE
---- drop table #TMPCR_02
IF OBJECT_ID(N'tempdb..#TMPCR_02',N'U') IS NOT NULL
       DROP TABLE #TMPCR_02

SELECT * 
INTO #TMPCR_02
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('' , 'Allied.UniTrac.Collateral' , 'Allied.UniTrac.loan')
)
----24


UPDATE FPC SET EXCLUDE = 2
FROM #TMPFPC FPC
JOIN #TMPCR_02 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND CR.TYPE_CD = 'AGENCY'
AND FPC.EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
----10

---- CASE III
---- WITH NO RULES - FOR ALL DIVISIONS - ALL COVERAGE TYPES
--SELECT * FROM #TMPCR WHERE RCB_ID IS NULL

UPDATE #TMPFPC SET EXCLUDE = 3
WHERE EXCLUDE = 0
AND CODE_TX IN 
(
SELECT CODE_TX FROM #TMPCR WHERE RCB_ID IS NULL
)
----109

------ CASE IV
---- WITH COLLATERAL CODE RULE SETUP
UPDATE FPC SET EXCLUDE = 4
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_02 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
---- 0


---- REMAINING FPC'S WITH NO COMMISSION SETUP
SELECT * FROM #TMPFPC WHERE EXCLUDE = 0
ORDER BY CODE_TX


 