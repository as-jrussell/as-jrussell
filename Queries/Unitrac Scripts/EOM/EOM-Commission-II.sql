---- GET THE ACCOUNTING PERIOD
 --- DROP TABLE #TMPACCT
 IF OBJECT_ID(N'tempdb..#TMPACCT',N'U') IS NOT NULL
       DROP TABLE #TMPACCT
 
 SELECT TOP 1 * 
 INTO #TMPACCT
 FROM ACCOUNTING_PERIOD 
 WHERE AGENCY_ID = 1
 AND PURGE_DT IS NULL 
 AND REPORTED_IN = 'N'
 ORDER BY ID DESC
 
 --SELECT * FROM #TMPACCT
 
---- GET ALL THE TXNS. POSTED FOR THE GIVEN ACCOUNTING PERIOD
--- DROP TABLE #TMPFPC
 IF OBJECT_ID(N'tempdb..#TMPFPC',N'U') IS NOT NULL
       DROP TABLE #TMPFPC

 SELECT LENDER.CODE_TX , LENDER.NAME_TX , LOAN.LENDER_ID , LOAN.NUMBER_TX , 
 LOAN.DIVISION_CODE_TX , LOAN.BRANCH_CODE_TX ,  
 COLL.COLLATERAL_CODE_ID , CC.CODE_TX AS CC_CODE_TX , 
 CC.PRIMARY_CLASS_CD , CC.SECONDARY_CLASS_CD , CC.CONTRACT_TYPE_CD , 
 RC.TYPE_CD AS RC_TYPE_CD , 
 FT.ID AS FT_ID , FT.TXN_DT ,  FT.TXN_TYPE_CD , FT.AMOUNT_NO , 
 FT.FPC_ID , FPC.NUMBER_TX AS FPC_NUMBER_TX , FPC.EFFECTIVE_DT , FPC.EXPIRATION_DT , FPC.CANCELLATION_DT ,
 COLL.LOAN_ID , RC.PROPERTY_ID , RC.ID AS RC_ID , COLL.ID AS COLL_ID , 
 0 AS EXCLUDE
 INTO #TMPFPC
 FROM FINANCIAL_TXN FT
 JOIN FORCE_PLACED_CERTIFICATE FPC ON FPC.ID = FT.FPC_ID
JOIN FORCE_PLACED_CERT_REQUIRED_COVERAGE_RELATE REL ON REL.FPC_ID = FPC.ID
AND REL.PURGE_DT IS NULL
JOIN REQUIRED_COVERAGE RC ON RC.ID = REL.REQUIRED_COVERAGE_ID
AND RC.PURGE_DT IS NULL
JOIN PROPERTY PR ON PR.ID = RC.PROPERTY_ID
AND PR.PURGE_DT IS NULL
JOIN COLLATERAL COLL ON COLL.PROPERTY_ID = PR.ID
AND COLL.PURGE_DT IS NULL AND COLL.PRIMARY_LOAN_IN = 'Y'
JOIN LOAN ON LOAN.ID = COLL.LOAN_ID
AND LOAN.PURGE_DT IS NULL
JOIN LENDER ON LENDER.ID = LOAN.LENDER_ID
AND LENDER.PURGE_DT IS NULL
JOIN COLLATERAL_CODE CC ON CC.ID = COLL.COLLATERAL_CODE_ID
JOIN #TMPACCT T1 ON T1.AGENCY_ID = 1
 WHERE LOAN.AGENCY_ID = 1
 AND FT.PURGE_DT IS NULL
 AND FPC.PURGE_DT IS NULL
 AND FT.TXN_TYPE_CD IN ('P', 'CP')
 AND T1.START_DT <= FT.TXN_DT
 AND T1.END_DT >= FT.TXN_DT
 --AND FT.TXN_DT >= '2015-07-01 00:00:00.0000000'
 --AND FT.TXN_DT <= '2015-08-01 00:00:00.0000000'
 ORDER BY LENDER.CODE_TX , LOAN.DIVISION_CODE_TX , RC.TYPE_CD
 --- 53710
 
 ------ GET ALL COMMISSIONS SETUP FOR ALLIED
 --- DROP TABLE #TMPCR
 IF OBJECT_ID(N'tempdb..#TMPCR',N'U') IS NOT NULL
       DROP TABLE #TMPCR
 
SELECT LENDER.CODE_TX , LENDER.NAME_TX , LENDER.TEST_IN , LENDER.CANCEL_DT , 
CR.LENDER_ID , CR.ID AS CR_ID , CR.TYPE_CD , CR.SUSPENDED_IN , 
CR.EFFECTIVE_DT , CR.EXPIRATION_DT , 
CR.AMOUNT_NO , CR.PERCENT_NO ,  
BOG.GROUP_TYPE_CD , BOG.DESCRIPTION_TX , BOG.ID AS BOG_ID , 
BRB.ID AS BRB_ID ,
RCB.ID AS RCB_ID , RCB.NAME_TX AS RCB_NAME , RCB.CONDITION_TYPE_CD , RCB.ORDER_NO , RCB.LEVEL_NO ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/@OperatorCode)[1]' , 'varchar(50)') OperatorCode ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamClassName)[1]' , 'varchar(50)') LParamClassName ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamProperty)[1]' , 'varchar(50)') LParamProperty ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamType)[1]' , 'varchar(50)') RParamType ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValue)[1]' , 'varchar(50)') RParamValue ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValueType)[1]' , 'varchar(50)') RParamValueType , 
BO.ID AS BO_ID_0 , BO.NAME_TX AS BO_NAME_0 , BO.DESCRIPTION_TX AS BO_DESCRIPTION_0 , 
BO.DEFAULT_VALUE_TX AS BO_DEFAULT_0 ,
BO1.ID AS BO_ID_1 , BO1.NAME_TX AS BO_NAME_1 , BO1.DESCRIPTION_TX AS BO_DESCRIPTION_1, 
BO1.DEFAULT_VALUE_TX AS BO_DEFAULT_1 
INTO #TMPCR
FROM COMMISSION_RATE CR
LEFT JOIN BUSINESS_OPTION_GROUP BOG ON BOG.RELATE_ID = CR.ID
AND BOG.PURGE_DT IS NULL
AND BOG.RELATE_CLASS_NM = 'Allied.UniTrac.CommissionRate'
LEFT JOIN BUSINESS_RULE_BASE BRB ON BRB.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BRB.PURGE_DT IS NULL
LEFT JOIN RULE_CONDITION_BASE RCB ON RCB.BUSINESS_RULE_BASE_ID = BRB.ID
AND RCB.PURGE_DT IS NULL
JOIN LENDER ON LENDER.ID = CR.LENDER_ID
LEFT JOIN BUSINESS_OPTION BO ON BO.BUSINESS_RULE_ID = BRB.ID
AND BO.PURGE_DT IS NULL
LEFT JOIN BUSINESS_OPTION BO1 ON BO1.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BO1.PURGE_DT IS NULL
WHERE LENDER.PURGE_DT IS NULL
AND LENDER.AGENCY_ID = 1
AND CR.PURGE_DT IS NULL
ORDER BY LENDER.CODE_TX , CR.ID
---- 8718

--SELECT DISTINCT LParamClassName , LParamProperty FROM #TMPCR ORDER BY LParamClassName
/*
LParamClassName					LParamProperty
NULL							NULL
Allied.UniTrac.Collateral		PrimaryClassificationCode
Allied.UniTrac.Collateral		CollateralCodeId
Allied.UniTrac.Loan				BranchCode
Allied.UniTrac.Loan				DivisionCode
Allied.UniTrac.RequiredCoverage	TypeCode
*/

UPDATE #TMPFPC SET EXCLUDE = 0
---- 53710

---- CASE I
---- EXCLUDE THE COMM WITH NO RULES OR WITH COLL CODE SELECTED
---- DROP TABLE #TMPCR_01
IF OBJECT_ID(N'tempdb..#TMPCR_01',N'U') IS NOT NULL
       DROP TABLE #TMPCR_01

SELECT * 
INTO #TMPCR_01
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') IN ( '' ,  'Allied.UniTrac.Collateral')
)
----8445


--- EXCLUDE THE FPC'S WITH COMM RULES SETUP WITH DIV & COV TYPE SELECTED
UPDATE FPC SET EXCLUDE = 1
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND CR.TYPE_CD = 'AGENCY'
AND EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_01 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
WHERE ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0
---- 53141

--- EXCLUDE THE FPC'S WITH COMM RULES SETUP WITH BRANCH & COV TYPE SELECTED
UPDATE FPC SET EXCLUDE = 2
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND CR.TYPE_CD = 'AGENCY'
AND EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_01 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
WHERE ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0
---- 0

--- EXCLUDE THE FPC'S WITH COMM RULES SETUP WITH BRANCH , DIV & COV TYPE SELECTED
UPDATE FPC SET EXCLUDE = 3
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
JOIN #TMPCR_01 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR2.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_01 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE LN_RULE.LOAN_RULE_CNT > 1
AND CR.TYPE_CD = 'AGENCY'
AND EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
---- 0



--- EXCLUDE THE FPC'S WITH COMM RULES SETUP WITH BRANCH , DIV & NO COV TYPE SELECTED
UPDATE FPC SET EXCLUDE = 4
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_01 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
--AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
--AND CR.LPARAMPROPERTY = 'TypeCode'
--AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
--AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
JOIN #TMPCR_01 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR2.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_01 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_01 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE ISNULL(LN_RULE.LOAN_RULE_CNT,0) > 1
AND ISNULL(COV_RULE.COV_RULE_CNT,0) = 0
AND CR.TYPE_CD = 'AGENCY'
AND EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
---- 0



----- CASE II
---- RULE SETUP ONLY WITH COVERAGE TYPE
---- drop table #TMPCR_02
IF OBJECT_ID(N'tempdb..#TMPCR_02',N'U') IS NOT NULL
       DROP TABLE #TMPCR_02

SELECT * 
INTO #TMPCR_02
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('' , 'Allied.UniTrac.Collateral' , 'Allied.UniTrac.loan')
)
----134


UPDATE FPC SET EXCLUDE = 5
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_02 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND CR.TYPE_CD = 'AGENCY'
AND FPC.EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
----225

------ CASE III
---- WITH COLLATERAL CODE RULE SETUP
IF OBJECT_ID(N'tempdb..#TMPCR_05',N'U') IS NOT NULL
       DROP TABLE #TMPCR_05

SELECT * 
INTO #TMPCR_05
FROM #TMPCR
WHERE CR_ID IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') IN ( 'Allied.UniTrac.Collateral')
)
AND CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR_02
)
AND CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR_01
)
----104

----- WITH COLL CODE, DIVISION , COVERAGE TYPE SELECTED
UPDATE FPC SET EXCLUDE = 7
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT ,0 ) = 0
---- 0

----- WITH COLL CODE,  COVERAGE TYPE WITH NO DIVISION/BRANCH
UPDATE FPC SET EXCLUDE = 8
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
--AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
--AND CR1.LPARAMPROPERTY = 'DivisionCode'
--AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
--AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0
---- 0

----- DIVISION , COLL CODE WITH NO COVERAGE TYPE
UPDATE FPC SET EXCLUDE = 9
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
--AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
--AND CR1.LPARAMPROPERTY = 'DivisionCode'
--AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
--AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT , 0 ) = 0
AND ISNULL(COV_RULE.COV_RULE_CNT,0) = 0
---- 0


----- BRANCH , COLL CODE WITH NO COVERAGE TYPE
UPDATE FPC SET EXCLUDE = 10
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
--AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
--AND CR1.LPARAMPROPERTY = 'DivisionCode'
--AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
--AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT ,0 ) = 0
AND ISNULL(COV_RULE.COV_RULE_CNT,0) = 0
---- 0


----- WITH BRANCH CODE , COVERAGE TYPE & COLL CODE
UPDATE FPC SET EXCLUDE = 11
----SELECT *
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT ,0 ) = 0
---- 15


----- WITH BRANCH CODE, DIV, COVERAGE TYPE & COLL CODE
UPDATE FPC SET EXCLUDE = 12
----SELECT *
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
---- COVERAGE TYPE
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- DIVISION
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
---- BRANCH
JOIN #TMPCR_05 CR3 ON CR3.CR_ID = CR.CR_ID
AND CR3.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR3.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR3.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR3.OPERATORCODE , 'EQ') = 'EQ'
----- COLL CODE
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND LN_RULE.LOAN_RULE_CNT > 1
---- 0


----- WITH BRANCH CODE, DIV & COLL CODE WITH NO COV TYPE
UPDATE FPC SET EXCLUDE = 13
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
---- COVERAGE TYPE
--AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
--AND CR.LPARAMPROPERTY = 'TypeCode'
--AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
--AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- DIVISION
--JOIN #TMPCR_05 CR ON CR1.CR_ID = CR.CR_ID
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- BRANCH
JOIN #TMPCR_05 CR3 ON CR3.CR_ID = CR.CR_ID
AND CR3.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR3.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR3.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR3.OPERATORCODE , 'EQ') = 'EQ'
----- COLL CODE
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'CollateralCodeId'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.COLLATERAL_CODE_ID)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND LN_RULE.LOAN_RULE_CNT > 1
AND ISNULL(COV_RULE.COV_RULE_CNT , 0 ) = 0
---- 0

------ CASE IV: COLL CODE CLASSIFICATION
----- WITH CC - CLASSIFICATION SETUP , DIVISION, COV TYPE
UPDATE FPC SET EXCLUDE = 14
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0
---- 0

----- WITH CC - CLASSIFICATION SETUP , BRANCH, COV TYPE
UPDATE FPC SET EXCLUDE = 15
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0
---- 0


----- CC , COV TYPE WITH NO DIV/BRANCH
UPDATE FPC SET EXCLUDE = 16
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT,0) = 0 
---- 1


----- WITH BRANCH CODE, DIV & COLL CODE WITH NO COV TYPE
UPDATE FPC SET EXCLUDE = 17
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
---- COVERAGE TYPE
--AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
--AND CR.LPARAMPROPERTY = 'TypeCode'
--AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
--AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- DIVISION
--JOIN #TMPCR_05 CR ON CR1.CR_ID = CR.CR_ID
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- BRANCH
JOIN #TMPCR_05 CR3 ON CR3.CR_ID = CR.CR_ID
AND CR3.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR3.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR3.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR3.OPERATORCODE , 'EQ') = 'EQ'
----- COLL CODE
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND LN_RULE.LOAN_RULE_CNT > 1
AND ISNULL(COV_RULE.COV_RULE_CNT , 0 ) = 0
---- 0


----- WITH BRANCH CODE, DIV, COVERAGE TYPE & COLL CODE
UPDATE FPC SET EXCLUDE = 18
----SELECT *
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
---- COVERAGE TYPE
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND CR.RPARAMVALUE = FPC.RC_TYPE_CD
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
---- DIVISION
JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
---- BRANCH
JOIN #TMPCR_05 CR3 ON CR3.CR_ID = CR.CR_ID
AND CR3.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR3.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR3.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR3.OPERATORCODE , 'EQ') = 'EQ'
----- COLL CODE
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
CROSS APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND LN_RULE.LOAN_RULE_CNT > 1
---- 0


----- BRANCH , COLL CODE WITH NO COVERAGE TYPE
UPDATE FPC SET EXCLUDE = 19
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
--AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
--AND CR1.LPARAMPROPERTY = 'DivisionCode'
--AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
--AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT ,0 ) = 0
AND ISNULL(COV_RULE.COV_RULE_CNT,0) = 0
---- 0


----- DIVISION , COLL CODE WITH NO COVERAGE TYPE
UPDATE FPC SET EXCLUDE = 20
----SELECT FPC.FT_ID , COUNT(*)
FROM #TMPFPC FPC
JOIN #TMPCR_05 CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND RTRIM(CR.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
--JOIN #TMPCR_05 CR1 ON CR1.CR_ID = CR.CR_ID
--AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
--AND CR1.LPARAMPROPERTY = 'DivisionCode'
--AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
--AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
JOIN #TMPCR_05 CR2 ON CR2.CR_ID = CR.CR_ID
AND CR2.LPARAMCLASSNAME = 'Allied.UniTrac.Collateral'
AND CR2.LPARAMPROPERTY = 'PrimaryClassificationCode'
AND RTRIM(CR2.RPARAMVALUE) = RTRIM(FPC.PRIMARY_CLASS_CD)
AND ISNULL(CR2.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
OUTER APPLY
(
SELECT COUNT(*) AS COV_RULE_CNT 
FROM #TMPCR_05 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
) AS COV_RULE
WHERE CR.TYPE_CD = 'AGENCY'
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND EXCLUDE = 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT , 0 ) = 0
AND ISNULL(COV_RULE.COV_RULE_CNT,0) = 0
---- 0


----- CASE V
---- RULE SETUP ONLY WITH ONLY DIVISION
---- drop table #TMPCR_03
IF OBJECT_ID(N'tempdb..#TMPCR_03',N'U') IS NOT NULL
       DROP TABLE #TMPCR_03

SELECT * 
INTO #TMPCR_03
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('' , 'Allied.UniTrac.Collateral' , 'Allied.UniTrac.RequiredCoverage')
)
AND CR_ID IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('Allied.UniTrac.Loan')
)
----3

--SELECT * FROM #TMPCR_03

---- ONLY DIV
UPDATE FPC SET EXCLUDE = 21
----SELECT FPC.FT_ID , EXCLUDE
FROM #TMPFPC FPC
JOIN #TMPCR_03 CR1 ON CR1.CODE_TX = FPC.CODE_TX
AND CR1.SUSPENDED_IN = 'N'
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND CR1.TYPE_CD = 'AGENCY'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_03 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR1.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'DivisionCode'
) AS LN_RULE
WHERE EXCLUDE = 0
AND 
    DateDiff(day,  CR1.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR1.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT , 0 ) = 0
---- 108

----- ONLY BRCH
UPDATE FPC SET EXCLUDE = 22
----SELECT FPC.FT_ID , EXCLUDE
FROM #TMPFPC FPC
JOIN #TMPCR_03 CR1 ON CR1.CODE_TX = FPC.CODE_TX
AND CR1.SUSPENDED_IN = 'N'
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND CR1.TYPE_CD = 'AGENCY'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_03 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR1.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR5.LPARAMPROPERTY <> 'BranchCode'
) AS LN_RULE
WHERE EXCLUDE = 0
AND 
    DateDiff(day,  CR1.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR1.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT , 0 ) = 0
---- 0

----- DIV & BRCH
UPDATE FPC SET EXCLUDE = 23
----SELECT FPC.FT_ID , EXCLUDE
FROM #TMPFPC FPC
---- DIVISION
JOIN #TMPCR_03 CR1 ON CR1.CODE_TX = FPC.CODE_TX
AND CR1.SUSPENDED_IN = 'N'
AND CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND RTRIM(CR1.RPARAMVALUE) = RTRIM(FPC.DIVISION_CODE_TX)
AND CR1.TYPE_CD = 'AGENCY'
---- BRANCH
JOIN #TMPCR_03 CR3 ON CR3.CR_ID = CR1.CR_ID
AND CR3.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR3.LPARAMPROPERTY = 'BranchCode'
AND RTRIM(CR3.RPARAMVALUE) = RTRIM(FPC.BRANCH_CODE_TX)
AND ISNULL(CR3.OPERATORCODE , 'EQ') = 'EQ'
OUTER APPLY
(
SELECT COUNT(*) AS LOAN_RULE_CNT FROM #TMPCR_03 CR5
WHERE CR5.CODE_TX = FPC.CODE_TX
AND CR5.SUSPENDED_IN = 'N'
AND CR5.CR_ID = CR1.CR_ID
AND CR5.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
) AS LN_RULE
WHERE EXCLUDE = 0
AND 
    DateDiff(day,  CR1.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR1.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
AND ISNULL(LN_RULE.LOAN_RULE_CNT , 0 ) > 1
---- 0


---- CASE VI
---- WITH NO RULES - FOR ALL DIVISIONS - ALL COVERAGE TYPES
--SELECT * FROM #TMPCR WHERE RCB_ID IS NULL

IF OBJECT_ID(N'tempdb..#TMPCR_02A',N'U') IS NOT NULL
       DROP TABLE #TMPCR_02A
       
SELECT * 
INTO #TMPCR_02A
FROM #TMPCR WHERE RCB_ID IS NULL
AND ( EXPIRATION_DT IS NULL OR EXPIRATION_DT >= '12/31/9999')
----- 166

UPDATE FPC SET EXCLUDE = 6
FROM #TMPFPC FPC
JOIN #TMPCR_02A CR ON CR.CODE_TX = FPC.CODE_TX
AND CR.SUSPENDED_IN = 'N' 
AND CR.TYPE_CD = 'AGENCY'
WHERE EXCLUDE = 0
AND 
    DateDiff(day,  CR.EFFECTIVE_DT ,  FPC.EFFECTIVE_DT ) > = 0
    AND
    DateDiff(day,  FPC.EFFECTIVE_DT ,  ISNULL (CR.EXPIRATION_DT,  DATEADD (Year, 50, GETDATE ()))   )  > 0
----219


---- REMAINING FPC'S WITH NO COMMISSION SETUP
SELECT * FROM #TMPFPC WHERE EXCLUDE = 0
ORDER BY CODE_TX
----1


