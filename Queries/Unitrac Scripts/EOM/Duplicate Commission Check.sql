IF OBJECT_ID(N'tempdb..#TMPCR',N'U') IS NOT NULL
       DROP TABLE #TMPCR
       
--- DROP TABLE #TMPCR
SELECT LENDER.CODE_TX , LENDER.NAME_TX , LENDER.TEST_IN , LENDER.CANCEL_DT , 
CR.LENDER_ID , CR.ID AS CR_ID , CR.TYPE_CD , CR.SUSPENDED_IN , 
CR.EFFECTIVE_DT , CR.EXPIRATION_DT , 
CR.AMOUNT_NO , CR.PERCENT_NO ,  
BOG.GROUP_TYPE_CD , BOG.DESCRIPTION_TX , BOG.ID AS BOG_ID , 
BRB.ID AS BRB_ID ,
RCB.ID AS RCB_ID , RCB.NAME_TX AS RCB_NAME , RCB.CONDITION_TYPE_CD , RCB.ORDER_NO , RCB.LEVEL_NO ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/@OperatorCode)[1]' , 'varchar(50)') OperatorCode ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamClassName)[1]' , 'varchar(50)') LParamClassName ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/LParamProperty)[1]' , 'varchar(50)') LParamProperty ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamType)[1]' , 'varchar(50)') RParamType ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValue)[1]' , 'varchar(50)') RParamValue ,
RCB.RULE_CONDITION_XML.value('(/ValueRuleConditionPropertyType/RParamValueType)[1]' , 'varchar(50)') RParamValueType , 
BO.ID AS BO_ID_0 , BO.NAME_TX AS BO_NAME_0 , BO.DESCRIPTION_TX AS BO_DESCRIPTION_0 , 
BO.DEFAULT_VALUE_TX AS BO_DEFAULT_0 ,
BO1.ID AS BO_ID_1 , BO1.NAME_TX AS BO_NAME_1 , BO1.DESCRIPTION_TX AS BO_DESCRIPTION_1, 
BO1.DEFAULT_VALUE_TX AS BO_DEFAULT_1 
INTO #TMPCR
FROM COMMISSION_RATE CR
LEFT JOIN BUSINESS_OPTION_GROUP BOG ON BOG.RELATE_ID = CR.ID
AND BOG.PURGE_DT IS NULL
AND BOG.RELATE_CLASS_NM = 'Allied.UniTrac.CommissionRate'
LEFT JOIN BUSINESS_RULE_BASE BRB ON BRB.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BRB.PURGE_DT IS NULL
LEFT JOIN RULE_CONDITION_BASE RCB ON RCB.BUSINESS_RULE_BASE_ID = BRB.ID
AND RCB.PURGE_DT IS NULL
JOIN LENDER ON LENDER.ID = CR.LENDER_ID
LEFT JOIN BUSINESS_OPTION BO ON BO.BUSINESS_RULE_ID = BRB.ID
AND BO.PURGE_DT IS NULL
LEFT JOIN BUSINESS_OPTION BO1 ON BO1.BUSINESS_OPTION_GROUP_ID = BOG.ID
AND BO1.PURGE_DT IS NULL
WHERE LENDER.PURGE_DT IS NULL
AND LENDER.AGENCY_ID = 1
AND CR.PURGE_DT IS NULL
ORDER BY LENDER.CODE_TX , CR.ID
---- 8718

---- SELECT * FROM #TMPCR
---- SELECT DISTINCT LPARAMPROPERTY FROM #TMPCR

---- CASE I
---- OVER LAP WITH DIVISION AND/OR BRANCH & COVERAGE TYPE
---- DROP TABLE #TMPCR_01
IF OBJECT_ID(N'tempdb..#TMPCR_01',N'U') IS NOT NULL
       DROP TABLE #TMPCR_01
       
SELECT * 
INTO #TMPCR_01
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') IN ( '' ,  'Allied.UniTrac.Collateral')
)
---8445

IF OBJECT_ID(N'tempdb..#TMPCR_02',N'U') IS NOT NULL
       DROP TABLE #TMPCR_02

--- DROP TABLE #TMPCR_02
SELECT DISTINCT CR.* ,
CR1.RCB_ID AS RCB_ID_01 , CR1.OPERATORCODE AS OPERATORCODE_01 , 
CR1.LPARAMCLASSNAME AS LPARAMCLASSNAME_01 , CR1.LPARAMPROPERTY AS LPARAMPROPERTY_01, 
CR1.RPARAMVALUE AS RPARAMVALUE_01
INTO #TMPCR_02
FROM #TMPCR_01 CR 
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
WHERE CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND CR.TYPE_CD = 'AGENCY'
AND CR.TEST_IN = 'N'
AND CR.CANCEL_DT IS NULL
----2768

INSERT INTO #TMPCR_02
SELECT DISTINCT CR.* ,
CR1.RCB_ID AS RCB_ID_01 , CR1.OPERATORCODE AS OPERATORCODE_01 , 
CR1.LPARAMCLASSNAME AS LPARAMCLASSNAME_01 , CR1.LPARAMPROPERTY AS LPARAMPROPERTY_01, 
CR1.RPARAMVALUE AS RPARAMVALUE_01
FROM #TMPCR_01 CR 
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
WHERE CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.RequiredCoverage'
AND CR.LPARAMPROPERTY = 'TypeCode'
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND CR.TYPE_CD = 'AGENCY'
AND CR.TEST_IN = 'N'
AND CR.CANCEL_DT IS NULL
----0


INSERT INTO #TMPCR_02
SELECT DISTINCT CR.* ,
CR1.RCB_ID AS RCB_ID_01 , CR1.OPERATORCODE AS OPERATORCODE_01 , 
CR1.LPARAMCLASSNAME AS LPARAMCLASSNAME_01 , CR1.LPARAMPROPERTY AS LPARAMPROPERTY_01, 
CR1.RPARAMVALUE AS RPARAMVALUE_01
FROM #TMPCR_01 CR 
JOIN #TMPCR_01 CR1 ON CR1.CR_ID = CR.CR_ID
WHERE CR1.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR1.LPARAMPROPERTY = 'BranchCode'
AND ISNULL(CR1.OPERATORCODE , 'EQ') = 'EQ'
AND CR.SUSPENDED_IN = 'N'
AND CR.LPARAMCLASSNAME = 'Allied.UniTrac.Loan'
AND CR.LPARAMPROPERTY = 'DivisionCode'
AND ISNULL(CR.OPERATORCODE , 'EQ') = 'EQ'
AND CR.TYPE_CD = 'AGENCY'
AND CR.TEST_IN = 'N'
AND CR.CANCEL_DT IS NULL
----0



------ ALL OVERLAPS
--- WITH DIV & COV TYPE
----OVERLAP WITH SAME EFFECTIVE_DT
SELECT CODE_TX , NAME_TX ,  EFFECTIVE_DT , RPARAMVALUE , RPARAMVALUE_01 , OperatorCode
FROM #TMPCR_02
GROUP BY CODE_TX , NAME_TX , EFFECTIVE_DT , RPARAMVALUE , RPARAMVALUE_01 , OperatorCode
HAVING COUNT(*) > 1

---- OVERLAPPING DATES WITH DIV & COV TYPE
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_02 T1
JOIN #TMPCR_02 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
---- COVERAGE
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
---DIVISION
AND ISNULL(T1.RPARAMVALUE_01 , '') = ISNULL(T2.RPARAMVALUE_01 , '')
AND ISNULL(T1.LPARAMCLASSNAME_01 , '') = ISNULL(T2.LPARAMCLASSNAME_01 , '')
AND ISNULL(T1.LPARAMPROPERTY_01 , '') = ISNULL(T2.LPARAMPROPERTY_01 , '')
ORDER BY T1.CODE_TX


----- CASE II
----- ONLY WITH COVERAGE TYPE SETUP
IF OBJECT_ID(N'tempdb..#TMPCR_03',N'U') IS NOT NULL
       DROP TABLE #TMPCR_03

SELECT * 
INTO #TMPCR_03
FROM #TMPCR
WHERE CR_ID NOT IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('' , 'Allied.UniTrac.Collateral' , 'Allied.UniTrac.loan')
)
----134


----- WITH ONLY COV TYPE SET - WITH SAME EFFECTIVE DATE
SELECT CODE_TX , NAME_TX ,  EFFECTIVE_DT , RPARAMVALUE , OperatorCode
FROM #TMPCR_03
GROUP BY CODE_TX , NAME_TX , EFFECTIVE_DT , RPARAMVALUE , OperatorCode
HAVING COUNT(*) > 1
---- 0

---- OVERLAPPING DATES WITH ONLY COV TYPE SET
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_03 T1
JOIN #TMPCR_03 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
AND ISNULL(T1.OperatorCode , '') = ISNULL(T2.OperatorCode , '') 
ORDER BY T1.CODE_TX
---- 0

---- CASE III:
---- OVERLAPPING WITH ONLY COVERAGE TYPE AND OTHER WITH DIVISION/BRANCH AND COVERAGE TYPE
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_02 T1
JOIN #TMPCR_03 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
AND ISNULL(T1.OperatorCode , '') = ISNULL(T2.OperatorCode , '')
ORDER BY T1.CODE_TX
---- 3


SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_03 T1
JOIN #TMPCR_02 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
AND ISNULL(T1.OperatorCode , '') = ISNULL(T2.OperatorCode , '')
ORDER BY T1.CODE_TX
---- 3


------ CASE VI: 
---- OVERLAPPING DATES - ONE WITH NO RULES
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR T1
JOIN #TMPCR T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999') ) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND 
(T1.RCB_ID IS NULL AND T2.RCB_ID IS NOT NULL)
---64


----- CASE V
----- COLL CODE RULES
IF OBJECT_ID(N'tempdb..#TMPCR_04',N'U') IS NOT NULL
       DROP TABLE #TMPCR_04

SELECT * 
INTO #TMPCR_04
FROM #TMPCR
WHERE CR_ID  IN 
(
SELECT CR_ID FROM #TMPCR
WHERE ISNULL(LPARAMCLASSNAME,'') in  ('Allied.UniTrac.Collateral')
)
----105

---- COLL CODE WITH OTHERS RULES OVERLAP WITH DIV/BRANCH CR
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_04 T1
JOIN #TMPCR_02 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
AND ISNULL(T1.OperatorCode , '') = ISNULL(T2.OperatorCode , '')
ORDER BY T1.CODE_TX
---- 1

---- COLL CODE WITH OTHER RULES OVERLAP WITH COV TYPE CR
SELECT DISTINCT  
T1.* , T2.* FROM #TMPCR_04 T1
JOIN #TMPCR_03 T2 ON T2.CODE_TX = T1.CODE_TX
WHERE  (
           (DATEDIFF( DAY , T1.EFFECTIVE_DT , ISNULL(T2.EXPIRATION_DT , '12/31/9999')) > 0 AND
           DATEDIFF( DAY , T2.EFFECTIVE_DT , ISNULL(T1.EXPIRATION_DT, '12/31/9999')) > 0 ) OR
           ISNULL(T2.EXPIRATION_DT , '12/31/9999') = ISNULL(T1.EXPIRATION_DT, '12/31/9999')
       ) 
AND T2.CR_ID <> T1.CR_ID
AND ISNULL(T1.RPARAMVALUE , '') = ISNULL(T2.RPARAMVALUE , '')
AND ISNULL(T1.LPARAMCLASSNAME , '') = ISNULL(T2.LPARAMCLASSNAME , '')
AND ISNULL(T1.LPARAMPROPERTY , '') = ISNULL(T2.LPARAMPROPERTY , '')
AND ISNULL(T1.OperatorCode , '') = ISNULL(T2.OperatorCode , '')
ORDER BY T1.CODE_TX
---- 2


