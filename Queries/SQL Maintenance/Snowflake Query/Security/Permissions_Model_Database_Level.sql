/*
This is an example scripts of settting the up base permissions on a database.
The EDW_DEV database is used in this example and will have three schemas created.

Roles:
OWNER_<DatabaseName>
    ---> READWRITE_<DatabaseName>
        ---> READ_<DatabaseName>
*/

USE ROLE ACCOUNTADMIN;

--OWNER role creation and allowing SYSADMIN hierarchy 
CREATE ROLE IF NOT EXISTS OWNER_EDW_DEV COMMENT = 'Owner role for the EDW_DEV Database';
GRANT ROLE OWNER_EDW_DEV TO ROLE SYSADMIN;

--READ and READ/WRITE roles and their heirarchy
CREATE ROLE IF NOT EXISTS READWRITE_EDW_DEV COMMENT = 'Read/Write role for the EDW_DEV Database';
CREATE ROLE IF NOT EXISTS READ_EDW_DEV COMMENT = 'Read/Write role for the EDW_DEV Database';
GRANT ROLE READ_EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT ROLE READWRITE_EDW_DEV TO ROLE OWNER_EDW_DEV;
GRANT ROLE READ_EDW_DEV TO ROLE READ_ALL_DEV;

--GRANT warehouse
GRANT USAGE, MONITOR ON WAREHOUSE EDW_DEV_INFA_WH TO ROLE READWRITE_EDW_DEV;
GRANT USAGE, MONITOR ON WAREHOUSE EDW_DEV_INFA_WH TO ROLE READ_EDW_DEV;

--Create database
CREATE DATABASE EDW_DEV IF NOT EXISTS COMMENT = 'Purpose of database';

--GRANT ownership, usage and monitor
GRANT OWNERSHIP ON DATABASE EDW_DEV TO ROLE OWNER_EDW_DEV REVOKE CURRENT GRANTS;
GRANT MONITOR, USAGE ON DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT MONITOR, USAGE ON DATABASE EDW_DEV TO ROLE READ_EDW_DEV;

/*****READ/WRITE*****/

--Current object grants
GRANT MONITOR ON ALL TASKS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON ALL SCHEMAS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON ALL FUNCTIONS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON ALL PROCEDURES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT MONITOR ON ALL TASKS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT ON ALL VIEWS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE, READ ON ALL STAGES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON ALL FILE FORMATS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT ON ALL STREAMS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;

--Future object grants
GRANT MONITOR ON FUTURE TASKS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON FUTURE FUNCTIONS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON FUTURE PROCEDURES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT,INSERT, UPDATE,DELETE ON FUTURE TABLES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT MONITOR ON FUTURE TASKS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT ON FUTURE VIEWS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE, READ ON FUTURE STAGES IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT USAGE ON FUTURE FILE FORMATS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;
GRANT SELECT ON FUTURE STREAMS IN DATABASE EDW_DEV TO ROLE READWRITE_EDW_DEV;

/*****READ*****/

--Current object grants
GRANT MONITOR ON ALL TASKS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON ALL SCHEMAS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON ALL FUNCTIONS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON ALL PROCEDURES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON ALL TABLES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT MONITOR ON ALL TASKS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON ALL VIEWS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE, READ ON ALL STAGES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON ALL FILE FORMATS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON ALL STREAMS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;

--Future object grants
GRANT MONITOR ON FUTURE TASKS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON FUTURE SCHEMAS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON FUTURE FUNCTIONS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON FUTURE PROCEDURES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON FUTURE TABLES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT MONITOR ON FUTURE TASKS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON FUTURE VIEWS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE, READ ON FUTURE STAGES IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT USAGE ON FUTURE FILE FORMATS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;
GRANT SELECT ON FUTURE STREAMS IN DATABASE EDW_DEV TO ROLE READ_EDW_DEV;

--Create schemas (Permissions already granted in future object grants)
USE ROLE OWNER_EDW_DEV;
CREATE SCHEMA IF NOT EXISTS EDW_DEV.CDW COMMENT = 'Purpose of schema';
CREATE SCHEMA IF NOT EXISTS EDW_DEV.STG COMMENT = 'Purpose of schema';

--The TEMP schema is useful for "Read" roles so they can create temporary tables
USE ROLE OWNER_EDW_DEV;
CREATE SCHEMA IF NOT EXISTS EDW_DEV.TEMP COMMENT = 'Purpose of schema';
GRANT CREATE TABLE ON SCHEMA EDW_DEV.TEMP TO ROLE READWRITE_EDW_DEV;
GRANT CREATE TABLE ON SCHEMA EDW_DEV.TEMP TO ROLE READ_EDW_DEV;

/*EXAMPLE: This must be ran across all current tables to transfer ownership
           if tables already exist.

USE EDW_DEV;
SELECT 'GRANT OWNERSHIP ON TABLE ' || Table_Catalog || '.' || Table_Schema || '.' || Table_Name || ' TO ROLE OWNER_EDW_DEV REVOKE CURRENT GRANTS;' 
FROM INFORMATION_SCHEMA.Tables
WHERE Table_Schema = 'DBO';

*/
