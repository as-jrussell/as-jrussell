
USE ROLE ACCOUNTADMIN;



---roles users are in and last time they logged into specific role [AuditLogin]



use database DBA;
use schema INFO;


CREATE or replace procedure GetUserRolesLastLogin ( USER_GROUPS VARCHAR)
returns TABLE (WAREHOUSE_NAME VARCHAR,USER_NAME VARCHAR, ROLE_NAME VARCHAR,  FIRST_LOGIN TIMESTAMP_LTZ(6), LAST_LOGIN TIMESTAMP_LTZ(6), LOGINS integer )
LANGUAGE SQL
AS '
BEGIN
IF (USER_GROUPS IN (select name from snowflake.account_usage.roles)) THEN 
DECLARE
  res resultset default (
  
  
 SELECT DISTINCT WAREHOUSE_NAME, USER_NAME, ROLE_NAME,MIN(START_TIME) AS FIRST_LOGIN,MAX(END_TIME) AS LAST_LOGIN,COUNT(*) AS LOGINS
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
WHERE  ROLE_NAME = :USER_GROUPS
GROUP BY USER_NAME, ROLE_NAME, WAREHOUSE_NAME      
   ORDER BY MAX(END_TIME) DESC, COUNT(*) DESC 
   )
    ;
BEGIN
RETURN TABLE(RES);
END;
ELSEIF (USER_GROUPS IN (SELECT GU.NAME FROM SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_ROLES GU WHERE granted_on = ''WAREHOUSE'')) THEN
DECLARE 
  res resultset default (


  SELECT DISTINCT WAREHOUSE_NAME,USER_NAME, ROLE_NAME,MIN(START_TIME) AS FIRST_LOGIN,MAX(END_TIME) AS LAST_LOGIN,COUNT(*) AS LOGINS
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
WHERE WAREHOUSE_NAME = :USER_GROUPS
GROUP BY WAREHOUSE_NAME, USER_NAME,ROLE_NAME       
   ORDER BY WAREHOUSE_NAME, MAX(END_TIME) DESC, COUNT(*) DESC 

      )
    ;
BEGIN
RETURN TABLE(RES);
END;

ELSEIF (USER_GROUPS IN (select name from snowflake.account_usage.users)) THEN 
DECLARE
  res resultset default (
  
  
 SELECT DISTINCT WAREHOUSE_NAME, USER_NAME, ROLE_NAME,MIN(START_TIME) AS FIRST_LOGIN,MAX(END_TIME) AS LAST_LOGIN,COUNT(*) AS LOGINS
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
WHERE  USER_NAME = :USER_GROUPS
GROUP BY USER_NAME, ROLE_NAME, WAREHOUSE_NAME      
   ORDER BY MAX(END_TIME) DESC, COUNT(*) DESC 
    )
    ;
BEGIN
RETURN TABLE(RES);
END;
ELSE
DECLARE
  res resultset default (
  
  
 SELECT DISTINCT WAREHOUSE_NAME, USER_NAME, ROLE_NAME,MIN(START_TIME) AS FIRST_LOGIN,MAX(END_TIME) AS LAST_LOGIN,COUNT(*) AS LOGINS
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
WHERE ROLE_NAME <> ''PUBLIC''
GROUP BY USER_NAME, ROLE_NAME , WAREHOUSE_NAME     
   ORDER BY USER_NAME, MAX(END_TIME) DESC, COUNT(*) DESC 
    )
    ;
BEGIN
RETURN TABLE(RES);
END;

END IF;
END;
';